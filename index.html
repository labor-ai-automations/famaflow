<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fama Flow</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
  (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Re-referencing: ",d):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
    key: "AIzaSyDFgEhXMXR8pa8olYIEQ4QJXAVikag_lFE",
    v: "weekly"
  });
</script>    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --color-background: #F9F9F9; --color-surface: #FFFFFF; --color-text-primary: #1E1E1E; --color-text-secondary: #6B7280; --color-brand-primary: #D81920; --color-border: #E0E0E0; --color-success: #10B981; --color-warning: #F59E0B; --color-danger: #D81920; --color-info: #3B82F6; --color-success-bg: #E7F8F2; --color-warning-bg: #FFFBEB; --color-danger-bg: #FEF2F2; --color-info-bg: #EFF6FF; --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --read-bg: #f3f4f6; --unread-bg: #FFFFFF;
        }
        body.dark-mode {
            --color-background: #121212; --color-surface: #1E1E1E; --color-text-primary: #FFFFFF; --color-text-secondary: #A8A8A8; --color-border: #383838; --color-success-bg: #052e16; --color-warning-bg: #2a2105; --color-danger-bg: #3b1212; --color-info-bg: #1e293b; --shadow: none;
            --read-bg: #1a1a1a; --unread-bg: #252525;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--color-background); color: var(--color-text-primary); transition: background-color 0.3s, color 0.3s; line-height: 1.6; }
        * { box-sizing: border-box; }
        .login-wrapper { display: flex; align-items: center; justify-content: center; height: 100vh; }
        .theme-toggle { position: fixed; top: 1.5rem; right: 1.5rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: var(--shadow); z-index: 3000; }
        .theme-toggle .material-icons { color: var(--color-text-secondary); }
        #icon-sun { display: none; } body.dark-mode #icon-sun { display: block; } body.dark-mode #icon-moon { display: none; }
        .login-container { width: 100%; max-width: 400px; padding: 2.5rem; text-align: center; background-color: var(--color-surface); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--color-border); }
        .login-logo { max-width: 180px; margin-bottom: 1rem; }
        .login-subtitle { color: var(--color-text-secondary); margin-bottom: 2.5rem; font-size: 1rem; }
        .input-group { position: relative; margin-bottom: 1.5rem; text-align: left;}
        .input-field { width: 100%; padding: 1rem; background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text-primary); font-size: 1rem; }
        .btn-primary { padding: 1rem; border: none; border-radius: 8px; background-color: var(--color-brand-primary); color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: opacity: 0.2s; }
        #app-container, .login-wrapper { display: none; }
        #app-container.visible, .login-wrapper.visible { display: flex; }
        .sidebar { width: 260px; background-color: var(--color-surface); border-right: 1px solid var(--color-border); padding: 1.5rem; display: flex; flex-direction: column; height: 100vh; position: fixed; }
        .sidebar-header { margin-bottom: 2rem; } .sidebar-logo { width: 120px; }
        .nav-menu { list-style: none; padding: 0; margin: 0; } .nav-menu li { margin-bottom: 0.5rem; }
        .nav-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 8px; text-decoration: none; color: var(--color-text-secondary); font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .nav-link .material-icons { margin-right: 1rem; }
        .nav-link:hover { background-color: var(--color-background); color: var(--color-text-primary); }
        .nav-link.active { background-color: var(--color-brand-primary); color: white; }
        .nav-section-title { font-size: 0.8rem; color: var(--color-text-secondary); text-transform: uppercase; margin: 2rem 0 1rem 1rem; font-weight: 600; }
        .sidebar-scroll-area { flex-grow: 1; overflow-y: auto; padding-right: 5px; margin-right: -5px; }
        
        /* SIDEBAR FOOTER & SHORTCUT STYLES */
        .sidebar-footer { margin-top: auto; border-top: 1px solid var(--color-border); padding-top: 1rem; }
        .profile-shortcut { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 8px; margin-bottom: 1rem; cursor: pointer; transition: background-color 0.2s; }
        .profile-shortcut:hover, .profile-shortcut.active { background-color: var(--color-background); }
        .profile-shortcut .user-avatar { width: 36px; height: 36px; font-size: 1rem; }
        .profile-shortcut .user-name { font-weight: 600; font-size: 0.9rem; }
        .profile-shortcut .user-role { font-size: 0.8rem; color: var(--color-text-secondary); }

        main.content { flex: 1; margin-left: 260px; padding: 2rem 3rem; overflow-y: auto; background-color: var(--color-background); position: relative; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .page-header h1 { margin: 0; font-size: 1.8rem; display: flex; align-items: center; gap: 1rem;} .page-header p { margin: 5px 0 0 0; color: var(--color-text-secondary); }
        .page-header-actions { display: flex; align-items: center; gap: 1rem; }
        .page-content { display: none; } .page-content.active { display: block; }
        .card { background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow); }
.calc-info { font-size: 14px; color: var(--color-text-secondary); cursor: help; vertical-align: middle; margin-left: 4px; }
.calc-info:hover { color: var(--color-brand-primary); }
.voo-selecionado { background-color: var(--color-success-bg); border-left: 3px solid var(--color-success); padding: 6px 8px !important; margin: 4px -8px; border-radius: 4px; }

        /* --- PAINEL DE CONTROLE DIÁRIO --- */
        .briefing-progress-bar-wrapper { width: 100%; background: var(--color-border); border-radius: 8px; height: 8px; margin-bottom: 1.5rem; overflow: hidden; }
        .briefing-progress-bar-fill { height: 100%; border-radius: 8px; background: linear-gradient(90deg, var(--color-success), #34d399); transition: width 0.6s ease-out; }
        .briefing-progress-label { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 0.4rem; }
        .briefing-cards-wrapper { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .briefing-card { flex: 1; border-radius: 10px; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; border: 1px solid transparent; }
        .briefing-card.critico { background-color: var(--color-danger-bg); border-color: rgba(216,25,32,0.2); }
        .briefing-card.hoje { background-color: var(--color-warning-bg); border-color: rgba(245,158,11,0.2); }
        .briefing-card.mensagens { background-color: var(--color-info-bg); border-color: rgba(59,130,246,0.2); }
        .briefing-card-header { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .briefing-card.critico .briefing-card-header { color: var(--color-danger); }
        .briefing-card.hoje .briefing-card-header { color: var(--color-warning); }
        .briefing-card.mensagens .briefing-card-header { color: var(--color-info); }
        .briefing-card-header .material-icons { font-size: 18px; }
        .briefing-card-count { font-size: 2rem; font-weight: 800; line-height: 1; }
        .briefing-card.critico .briefing-card-count { color: var(--color-danger); }
        .briefing-card.hoje .briefing-card-count { color: var(--color-warning); }
        .briefing-card.mensagens .briefing-card-count { color: var(--color-info); }
        .briefing-card-sub { font-size: 0.8rem; color: var(--color-text-secondary); flex-grow: 1; }
        .briefing-footer-btn { width: 100%; padding: 0.9rem; border: none; border-radius: 10px; background: linear-gradient(135deg, var(--color-brand-primary), #ff4444); color: white; font-size: 1rem; font-weight: 700; cursor: pointer; letter-spacing: 0.05em; transition: opacity 0.2s, transform 0.2s; }
        .briefing-footer-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        @media (max-width: 768px) { .briefing-cards-wrapper { flex-direction: column; } }
        .grid { display: grid; gap: 1.5rem; } .grid-cols-2 { grid-template-columns: repeat(2, 1fr); } .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .btn { padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; border: none; transition: background-color 0.2s, opacity 0.2s;}
        .btn:hover { opacity: 0.9; } .btn .material-icons { margin-right: 0.5rem; font-size: 20px; }
        .btn[disabled] { opacity: 0.5; cursor: not-allowed; }
        .btn-icon { padding: 0.5rem; background: none; border: none; color: var(--color-text-secondary); border-radius: 50%; line-height: 1;} .btn-icon:hover { background-color: var(--color-background); color: var(--color-text-primary); }
        .btn-secondary { background-color: var(--color-surface); color: var(--color-text-primary); border: 1px solid var(--color-border); }
        .btn-danger { background-color: var(--color-brand-primary); color: white; }
        .btn-success { background-color: var(--color-success); color: white; } .btn-warning { background-color: var(--color-warning); color: white; }
        .fab { position: fixed; right: 3rem; bottom: 3rem; width: 56px; height: 56px; background-color: var(--color-brand-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.15); cursor: pointer; border: none; z-index: 100; transition: transform 0.2s; } .fab:hover { transform: scale(1.05); }
        .fab.hidden { display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-overlay.visible { display: flex; }
        #recipient-modal { z-index: 2500 !important; }
        #recipient-modal.visible { display: flex !important; z-index: 2500 !important; }
        .modal-content { background-color: var(--color-surface); padding: 0; border-radius: 12px; width: 100%; max-width: 500px; overflow: hidden; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--color-border); }
        .modal-body { padding: 1.5rem; } .modal-footer { padding: 1rem 1.5rem; display: flex; justify-content: flex-end; gap: 0.5rem; background-color: var(--color-background); }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; }
        .stat-card { display: flex; align-items: center; gap: 1rem; }
        .stat-card .stat-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .stat-card.card-warning .stat-icon { background-color: var(--color-warning-bg); color: var(--color-warning); }
        .stat-card.card-danger .stat-icon { background-color: var(--color-danger-bg); color: var(--color-danger); }
        .stat-card .stat-info h3 { margin: 0; font-size: 1rem; color: var(--color-text-secondary); }
        .stat-card .stat-info p { margin: 0; font-size: 2rem; font-weight: 700; }
        .page-header .btn { padding: 0.5rem 1rem; }
        .message-actions-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); padding-right: 1rem; }
        .tabs-container { display: flex; gap: 0.5rem; }
        .tab-link { background: none; border: none; padding: 0.75rem 1.25rem; cursor: pointer; color: var(--color-text-secondary); font-weight: 500; border-bottom: 2px solid transparent; }
        .tab-link.active { color: var(--color-brand-primary); border-bottom-color: var(--color-brand-primary); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .empty-state { padding: 3rem 1rem; text-align: center; color: var(--color-text-secondary); }
        .data-table-fino { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .data-table-fino tr { cursor: pointer; transition: background-color 0.2s; }
        .data-table-fino tr.row-unread { background-color: var(--unread-bg); }
        .data-table-fino tr.row-read { background-color: var(--read-bg); }
        .data-table-fino tr:hover { filter: brightness(0.98); }
        .data-table-fino td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--color-border); vertical-align: middle; white-space: nowrap; }
        .data-table-fino .col-who { width: 20%; font-weight: 400; overflow: hidden; text-overflow: ellipsis; color: var(--color-text-primary); }
        .row-unread .col-who { font-weight: 700; color: var(--color-text-primary); }
        .data-table-fino .col-subject { width: 50%; overflow: hidden; text-overflow: ellipsis; }
        .data-table-fino .subject-title { font-weight: 400; color: var(--color-text-primary); }
        .row-unread .subject-title { font-weight: 700; }
        .data-table-fino .subject-preview { color: var(--color-text-secondary); margin-left: 0.5rem; font-weight: 400; }
        .data-table-fino .col-meta { width: 15%; text-align: right; }
        .data-table-fino .col-meta .meta-tags { display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem; }
        .data-table-fino .col-date { width: 10%; text-align: right; color: var(--color-text-secondary); font-size: 0.85rem; font-weight: 400; }
        .row-unread .col-date { font-weight: 600; color: var(--color-text-primary); }
        .data-table-fino .col-actions { width: 5%; text-align: center; }
        .data-table-fino .col-actions button { background: none; border: none; cursor: pointer; color: var(--color-text-secondary); padding: 4px; border-radius: 50%; }
        .data-table-fino .col-actions button:hover { background-color: var(--color-background); color: var(--color-text-primary); }
        .tag-fino { font-size: 0.7rem; font-weight: 600; padding: 0.15rem 0.6rem; border-radius: 12px; margin-left: 0.5rem; display: inline-block; line-height: 1.2; vertical-align: middle; }
        .tag-fino.tag-urgent { background-color: var(--color-danger-bg); color: var(--color-danger); }
        .tag-fino.tag-important { background-color: var(--color-warning-bg); color: var(--color-warning); }
        .tag-icon { display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.8rem; color: var(--color-text-secondary); }
        .tag-icon .material-icons { font-size: 18px; }
        .due-date-tag { font-weight: 500; color: var(--color-text-primary); }
        .read-receipt { display: inline-flex; vertical-align: middle; margin-right: 8px; }
        .read-receipt .material-icons { font-size: 18px; }
        .read-receipt.read .material-icons { color: var(--color-info); }
        .read-receipt.delivered .material-icons { color: var(--color-text-secondary); opacity: 0.6; }
        .refresh-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; line-height: 1; }
        .refresh-btn:hover { background-color: var(--color-background); }
        .refresh-btn.loading .material-icons { animation: spin 1s linear infinite; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--color-border); }
        .data-table thead th { background-color: var(--color-background); font-weight: 600; color: var(--color-text-secondary); font-size: 0.9rem; }
        .user-info-cell { display: flex; align-items: center; gap: 1rem; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--color-info-bg); color: var(--color-info); display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0; }
        .user-info-cell .user-name { font-weight: 600; }
        .user-info-cell .user-email { font-size: 0.9rem; color: var(--color-text-secondary); }
        .user-meta-cell { display: flex; flex-direction: column; gap: 0.25rem; }
        .user-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .user-tag { font-size: 0.75rem; font-weight: 600; padding: 0.15rem 0.6rem; border-radius: 12px; display: inline-flex; align-items: center; gap: 0.25rem; }
        .user-tag.department { background-color: var(--color-info-bg); color: var(--color-info); }
        .user-tag.role-admin { background-color: var(--color-danger-bg); color: var(--color-danger); }
        .user-tag.role { background-color: var(--color-background); color: var(--color-text-secondary); border: 1px solid var(--color-border); }
        .score-cell { font-weight: 600; display: flex; align-items: center; gap: 0.25rem; text-align: left !important; }
        .score-cell .material-icons { color: var(--color-warning); font-size: 18px; }
        .action-buttons { text-align: right; }
        .action-buttons .btn { background: none; border: none; cursor: pointer; color: var(--color-text-secondary); padding: 4px; border-radius: 50%; }
        .action-buttons .btn:hover { background-color: var(--color-background); color: var(--color-text-primary); }
/* Checkbox de Permissões Compacto */
        .perm-checkbox {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 0.75rem;
            background: var(--color-background);
            border: 1.5px solid var(--color-border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 42px;
        }
        .perm-checkbox:hover {
            border-color: var(--color-brand-primary);
            background: var(--color-surface);
        }
        .perm-checkbox input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            width: 0;
            height: 0;
        }
        .perm-checkmark {
            position: relative;
            height: 18px;
            width: 18px;
            background-color: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: 4px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .perm-checkbox:hover .perm-checkmark {
            border-color: var(--color-brand-primary);
        }
        .perm-checkbox input:checked ~ .perm-checkmark {
            background-color: var(--color-brand-primary);
            border-color: var(--color-brand-primary);
        }
        .perm-checkmark::after {
            content: "";
            position: absolute;
            display: none;
            left: 5px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        .perm-checkbox input:checked ~ .perm-checkmark::after {
            display: block;
        }
        .perm-icon {
            font-size: 18px;
            color: var(--color-text-secondary);
            transition: color 0.2s;
            flex-shrink: 0;
        }
        .perm-checkbox input:checked ~ .perm-icon {
            color: var(--color-brand-primary);
        }
        .perm-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-primary);
            flex: 1;
        }
        
        /* Controles de Zoom do Organograma */
        .zoom-controls {
            display: flex !important;
            align-items: center;
        }
        .btn-icon-secondary {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--color-surface);
            color: var(--color-text-primary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-icon-secondary:hover {
            background: var(--color-background);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        .btn-icon-secondary .material-icons {
            font-size: 20px;
        }

        /* --- ORGANOGRAMA STYLES (RESTAURADO) --- */
        .org-tree-wrapper {
            width: 100%;
            overflow: auto;
            padding: 2rem 0;
            display: flex;
            justify-content: center;
            background: var(--color-background);
            position: relative;
            cursor: grab;
        }
        .org-tree-wrapper:active {
            cursor: grabbing;
        }
        .org-tree, .org-tree ul {
            display: flex;
            justify-content: center;
            list-style: none;
            padding: 0;
            margin: 0;
            position: relative;
        }
        .org-tree ul {
            padding-top: 20px;
        }
        .org-tree li {
            text-align: center;
            position: relative;
            padding: 20px 5px 0 5px;
            transition: all 0.5s;
        }
        .org-tree li::before, .org-tree li::after {
            content: '';
            position: absolute; top: 0; right: 50%;
            border-top: 2px solid var(--color-border);
            width: 50%; height: 20px;
        }
        .org-tree li::after {
            right: auto; left: 50%;
            border-left: 2px solid var(--color-border);
        }
        .org-tree li:only-child::after, .org-tree li:only-child::before {
            display: none;
        }
        .org-tree li:only-child { padding-top: 0; }
        .org-tree li:first-child::before, .org-tree li:last-child::after {
            border: 0 none;
        }
        .org-tree li:last-child::before {
            border-right: 2px solid var(--color-border);
            border-radius: 0 5px 0 0;
        }
        .org-tree li:first-child::after {
            border-radius: 5px 0 0 0;
        }
        .org-tree ul ul::before {
            content: '';
            position: absolute; top: 0; left: 50%;
            border-left: 2px solid var(--color-border);
            width: 0; height: 20px;
        }
        .org-node {
            border: 1px solid var(--color-border);
            padding: 10px 15px;
            display: inline-block;
            border-radius: 8px;
            background: var(--color-surface);
            min-width: 160px;
            box-shadow: var(--shadow);
            cursor: pointer;
            position: relative;
            z-index: 10;
        }
        .org-node:hover {
            border-color: var(--color-brand-primary);
            transform: translateY(-2px);
        }
        .org-node h4 { margin: 5px 0; font-size: 0.95rem; }
        .org-node p { margin: 0; font-size: 0.8rem; color: var(--color-text-secondary); }

        /* --- ORGANOGRAMA CONTEXT MENU (NEW) --- */
        .org-context-menu {
            position: fixed;
            z-index: 5000;
            background-color: var(--color-surface);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid var(--color-border);
            min-width: 180px;
            overflow: hidden;
            padding: 0.5rem 0;
        }
        .org-context-menu ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .org-context-menu li {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
        }
        .org-context-menu li:hover {
            background-color: var(--color-background);
        }
        .org-context-menu .material-icons {
            font-size: 18px;
            color: var(--color-text-secondary);
        }

        /* --- PROFILE PAGE REFACTOR --- */
        #profile-page .page-header { margin-bottom: 1rem; }
        .profile-header-card { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; margin-bottom: 2rem; }
        .profile-header-card .user-avatar { width: 80px; height: 80px; font-size: 2.5rem; margin-bottom: 1rem; transition: border-color 0.3s; border: 4px solid transparent; }
        .profile-info h3 { margin: 0; font-size: 1.5rem; }
        .profile-info p { margin: 0.25rem 0 0; color: var(--color-text-secondary); }
        
        /* Zonas de Risco */
        .status-badge { display: inline-block; margin-top: 0.5rem; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .zone-green .user-avatar { border-color: var(--color-success); }
        .zone-green .status-badge { background-color: var(--color-success-bg); color: var(--color-success); }
        .zone-yellow .user-avatar { border-color: var(--color-warning); }
        .zone-yellow .status-badge { background-color: var(--color-warning-bg); color: var(--color-warning); }
        .zone-red .user-avatar { border-color: var(--color-danger); }
        .zone-red .status-badge { background-color: var(--color-danger-bg); color: var(--color-danger); }

        .card-title { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; }
        .card-title .material-icons { color: var(--color-brand-primary); }
        .progress-bar-container { width: 100%; background-color: var(--color-background); border-radius: 8px; overflow: hidden; height: 12px; }
        .progress-bar { height: 100%; width: 0%; background-color: var(--color-brand-primary); border-radius: 8px; transition: width 0.5s ease-out; }
        .score-display { display: flex; justify-content: space-between; align-items: baseline; margin-top: 0.5rem; }
        .score-display .score-value { font-size: 1.2rem; font-weight: 700; }
        .score-display .score-label { font-size: 0.9rem; color: var(--color-text-secondary); }
        
        /* Grid para Pendências */
        .pendencies-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .pendency-card { padding: 1rem; border-left: 4px solid; display: flex; flex-direction: column; gap: 0.5rem; background-color: var(--color-surface); border-radius: 8px; border-top: 1px solid var(--color-border); border-right: 1px solid var(--color-border); border-bottom: 1px solid var(--color-border); box-shadow: var(--shadow); }
        .pendency-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
        .pendency-title { margin: 0; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; font-weight: 600; line-height: 1.2; }
        .pendency-meta { font-size: 0.85rem; color: var(--color-text-secondary); }
        .pendency-meta div { margin-bottom: 2px; }
        .pendency-alert { font-size: 0.85rem; font-weight: 600; color: var(--color-danger); margin-top: auto; }
        
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; text-align: center; }
        .achievement-badge { opacity: 0.4; }
        .achievement-badge.unlocked { opacity: 1; }
        .achievement-badge .badge-icon { font-size: 48px; color: var(--color-warning); }
        .achievement-badge p { font-weight: 500; margin: 0.5rem 0 0; font-size: 0.9rem; }
        
        /* --- History Section Styles --- */
        .history-card { margin-top: 1.5rem; }
        .history-summary { font-size: 1.1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
        .history-summary .material-icons { transition: transform 0.2s; }
        .history-details[open] .history-summary .material-icons { transform: rotate(90deg); }
        .history-list { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
        .history-item { display: flex; align-items: center; gap: 1rem; }
        .history-item .icon-wrapper { color: var(--color-success); }
        .history-item .info-wrapper .action-text { font-weight: 500; }
        .history-item .info-wrapper .timestamp { font-size: 0.85rem; color: var(--color-text-secondary); }

        /* --- TEAM PAGE STYLES (REFACTORED) --- */
        .team-section-title { grid-column: 1 / -1; margin: 2rem 0 1rem 0; font-size: 1.1rem; color: var(--color-text-primary); font-weight: 700; border-bottom: 1px solid var(--color-border); padding-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .team-section-title .material-icons { color: var(--color-text-secondary); }
        
        .team-user-card { background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 1.5rem; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .team-user-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); border-color: var(--color-info); }
        
        .team-avatar-img { width: 64px; height: 64px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 2px solid var(--color-border); }
        .team-user-card .user-avatar { width: 64px; height: 64px; font-size: 1.5rem; margin-bottom: 1rem; } /* Fallback */
        
        .team-user-card h3 { margin: 0 0 0.25rem 0; font-size: 1.1rem; font-weight: 600; }
        .team-user-card p { margin: 0; color: var(--color-text-secondary); font-size: 0.85rem; }
        
        .score-pill { display: inline-flex; align-items: center; gap: 0.25rem; background-color: var(--color-background); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-top: 0.75rem; border: 1px solid var(--color-border); }
        .score-pill.good { color: var(--color-success); border-color: var(--color-success-bg); background-color: var(--color-success-bg); }
        .score-pill.med { color: var(--color-warning); border-color: var(--color-warning-bg); background-color: var(--color-warning-bg); }
        .score-pill.bad { color: var(--color-danger); border-color: var(--color-danger-bg); background-color: var(--color-danger-bg); }
        
        #new-message-popup { position: fixed; bottom: 0; right: 3rem; width: 600px; max-width: 90vw; background-color: var(--color-surface); border: 1px solid var(--color-border); border-top-left-radius: 12px; border-top-right-radius: 12px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); z-index: 1001; display: none; flex-direction: column; transition: transform 0.3s ease-out; transform: translateY(100%); }
        #new-message-popup.visible { display: flex; transform: translateY(0); }
        .popup-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: var(--color-background); border-bottom: 1px solid var(--color-border); cursor: move; }
        .popup-header h3 { margin: 0; font-size: 1rem; }
        #new-message-form { display: flex; flex-direction: column; height: 500px; max-height: 70vh; }
        .popup-body { padding: 0.5rem 1rem; flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .popup-body .form-group { margin: 0; }
        .popup-body .input-field { background: transparent; border: none; border-bottom: 1px solid var(--color-border); border-radius: 0; padding: 0.75rem 0; font-size: 0.9rem; }
        .popup-body .input-field:focus { outline: none; border-bottom-color: var(--color-info); }
        .ql-editor.ql-blank::before { color: var(--color-text-secondary); font-style: normal; pointer-events: none; }
        #editor-wrapper { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        #editor-wrapper .ql-toolbar { flex-shrink: 0; border-bottom: 1px solid var(--color-border) !important; }
        #editor-wrapper .ql-container.ql-snow { border: none !important; flex-grow: 1; overflow-y: auto; }
        #recipient-group { position: relative; margin-bottom: 1.5rem !important;}
        #recipient-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; z-index: 1002; max-height: 200px; overflow-y: auto; display: none; box-shadow: var(--shadow); }
        .suggestion-item { padding: 0.5rem 1rem; cursor: pointer; }
        .suggestion-item:hover { background-color: var(--color-background); }
        .popup-footer { padding: 0.75rem 1rem; border-top: 1px solid var(--color-border); display: flex; flex-direction: column; align-items: stretch; gap: 0.75rem; }
        .popup-footer-top-row { display: flex; justify-content: space-between; align-items: center; min-height: 38px; }
        .popup-footer-main { display: flex; justify-content: space-between; align-items: center; }
        .popup-actions-left { display: flex; align-items: center; gap: 1rem; }
        #attachment-preview { font-size: 0.8rem; color: var(--color-text-secondary); background-color: var(--color-background); padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-flex; align-items: center; gap: 0.5rem; }
        #attachment-preview .remove-attachment { cursor: pointer; }
        .message-type-selector { display: flex; gap: 0.5rem; border: 1px solid var(--color-border); border-radius: 8px; padding: 0.25rem; background-color: var(--color-background);}
        .message-type-selector label { flex: 1; display: block; text-align: center; padding: 0.25rem 0.5rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 0.8rem; }
        .message-type-selector input[type="radio"] { display: none; }
        .message-type-selector input[type="radio"]:checked + label { background-color: var(--color-surface); box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-weight: 600; }
        .urgency-selector { display: flex; gap: 0.5rem; }
        .urgency-selector .btn { font-size: 0.8rem; padding: 0.4rem 0.8rem; border-radius: 20px; }
        .custom-checkbox { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem; white-space: nowrap; }
        .custom-checkbox input[type="checkbox"] { display: none; }
        .custom-checkbox .checkbox-box { width: 18px; height: 18px; border: 2px solid var(--color-border); border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .custom-checkbox .checkbox-box .material-icons { font-size: 14px; color: white; transform: scale(0); transition: transform 0.2s; }
        .custom-checkbox input[type="checkbox"]:checked + .checkbox-box { background-color: var(--color-info); border-color: var(--color-info); }
        .custom-checkbox input[type="checkbox"]:checked + .checkbox-box .material-icons { transform: scale(1); }
        #chamado-fields { display: flex; align-items: center; gap: 0.75rem; }
        #chamado-fields label { font-size: 0.9rem; margin-bottom: 0; color: var(--color-text-secondary); white-space: nowrap; }
        #chamado-fields .input-field { font-size: 0.9rem; padding: 0.4rem 0.8rem; border: 1px solid var(--color-border); background: var(--color-background); }
        #chamado-fields .date-presets { display: flex; gap: 0.25rem; }
        #chamado-fields .date-presets button { font-size: 0.8rem; padding: 0.25rem 0.5rem; }
        #recipient-input-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; border-bottom: 1px solid var(--color-border); padding: 0.375rem 0; cursor: text; }
        #recipient-input-wrapper:focus-within { border-bottom-color: var(--color-info); }
        .recipient-pill { display: inline-flex; align-items: center; gap: 0.5rem; background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: 16px; padding: 0.25rem 0.75rem; font-size: 0.9rem; }
        .recipient-pill .pill-remove { cursor: pointer; font-size: 1rem; font-weight: 700; color: var(--color-text-secondary); }
        #destinatario-input { border: none; outline: none; background: transparent; flex-grow: 1; min-width: 100px; font-size: 0.9rem; padding: 0.375rem 0; }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; gap: 1rem; padding: 1rem; background-color: var(--color-surface); border-radius: 8px; box-shadow: var(--shadow); border-left: 4px solid; min-width: 300px; transform: translateX(120%); opacity: 0; transition: transform 0.4s ease-out, opacity 0.4s ease-out; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast .toast-icon { font-size: 24px; }
        .toast .toast-message { flex: 1; font-weight: 500; font-size: 0.9rem; }
        .toast .toast-close { background: none; border: none; color: var(--color-text-secondary); cursor: pointer; }
        .toast.toast-success { border-color: var(--color-success); background-color: var(--color-success-bg); } .toast.toast-success .toast-icon { color: var(--color-success); }
        .toast.toast-danger { border-color: var(--color-danger); background-color: var(--color-danger-bg); } .toast.toast-danger .toast-icon { color: var(--color-danger); }
        .toast.toast-warning { border-color: var(--color-warning); background-color: var(--color-warning-bg); } .toast.toast-warning .toast-icon { color: var(--color-warning); }
        .toast.toast-info { border-color: var(--color-info); background-color: var(--color-info-bg); } .toast.toast-info .toast-icon { color: var(--color-info); }
        
        /* --- CONVERSATION VIEW REFACTOR --- */
        #conversation-view-page .page-header { flex-direction: column; align-items: stretch; gap: 0.75rem; }
        .conversation-main-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .conversation-info-block { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem; padding: 0.75rem; background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: 8px; font-size: 0.9rem; }
        .conversation-info-block h1 { font-size: 1.5rem; margin: 0 0 0.5rem 0; }
        .conversation-info-block p { color: var(--color-text-secondary); margin: 0; }
        .conversation-ticket-info { background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: 8px; padding: 0.75rem 1rem; display: flex; justify-content: space-around; align-items: center; font-size: 0.9rem; gap: 1rem; }
        .conversation-ticket-info div { display: flex; align-items: center; gap: 0.5rem; }
        .conversation-ticket-info .tag-fino { font-size: 0.8rem; }
        #conversation-view-page .card { display: flex; flex-direction: column; height: calc(100vh - 16rem); padding: 0; }
        #conversation-messages { flex-grow: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .message-bubble-wrapper { display: flex; flex-direction: column; max-width: 70%; }
        .message-bubble { padding: 0.75rem 1rem; border-radius: 18px; word-break: break-word; }
        .message-attachment { margin-top: 0.5rem; }
        .message-attachment-link { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background-color: rgba(0,0,0,0.05); border-radius: 8px; text-decoration: none; color: inherit; font-size: 0.9rem; border: 1px solid var(--color-border); }
        .message-attachment-link:hover { background-color: rgba(0,0,0,0.1); }
        .message-bubble.sent .message-attachment-link { background-color: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3); }
        .message-bubble.sent .message-attachment-link:hover { background-color: rgba(255,255,255,0.3); }
        .message-metadata { font-size: 0.75rem; color: var(--color-text-secondary); margin-top: 0.25rem; }
        .message-bubble-wrapper.sent { align-self: flex-end; align-items: flex-end; }
        .message-bubble-wrapper.received { align-self: flex-start; align-items: flex-start; }
        .message-bubble.sent { background-color: var(--color-brand-primary); color: white; border-bottom-right-radius: 4px; }
        .message-bubble.received { background-color: var(--color-background); border: 1px solid var(--color-border); border-bottom-left-radius: 4px; }
        #reply-form-wrapper { padding: 1rem 1.5rem; border-top: 1px solid var(--color-border); background-color: var(--color-surface); }
        #reply-form { display: flex; gap: 1rem; align-items: center; }
        #reply-input { flex-grow: 1; }
        #reply-attachment-preview { margin-top: 0.5rem; font-size: 0.8rem; }
        
        /* New Styles for Recipient Search Layout */
        .search-row { display: flex; align-items: flex-start; gap: 0.5rem; }
        #recipient-input-wrapper { flex-grow: 1; }
        
        /* New Styles for Recipient Modal */
        #recipient-modal .modal-content { max-width: 700px; height: 80vh; display: flex; flex-direction: column; }
        .filter-row { padding: 1rem; border-bottom: 1px solid var(--color-border); display: flex; gap: 0.75rem; background-color: var(--color-background); align-items: center;}
        .filter-row select, .filter-row input { flex: 1; padding: 0.6rem; border: 1px solid var(--color-border); border-radius: 8px; font-size: 0.9rem; background: var(--color-surface); color: var(--color-text-primary); }
        .recipient-table-container { flex: 1; overflow-y: auto; padding: 0; }
        .recipient-table-container thead { position: sticky; top: 0; background: var(--color-surface); z-index: 2; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .recipient-table-container th { padding: 0.75rem 1rem; text-align: left; font-size: 0.85rem; color: var(--color-text-secondary); font-weight: 600; border-bottom: 1px solid var(--color-border); }
        .selected-row { background-color: var(--color-info-bg); }
        .check-icon { color: var(--color-border); font-size: 24px; }
        .selected-row .check-icon { color: var(--color-success); }

        /* Custom Confirmation Modal Styles */
        #confirmation-modal .modal-content { max-width: 400px; text-align: center; }
        .confirm-icon { font-size: 48px; color: var(--color-warning); margin-bottom: 1rem; }
        .confirm-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .confirm-message { color: var(--color-text-secondary); margin-bottom: 2rem; }

        /* Team Page Styles */
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .team-user-card { background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 1.5rem; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .team-user-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
        .team-user-card .user-avatar { width: 64px; height: 64px; font-size: 2rem; margin-bottom: 1rem; }
        .team-user-card h3 { margin: 0 0 0.25rem 0; font-size: 1.1rem; }
        .team-user-card p { margin: 0; color: var(--color-text-secondary); font-size: 0.9rem; }
        /* TASK 3: TEAM FILTERS STYLE */
        .team-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }

        /* --- MURAL CULTURAL STYLES (REFACTORED) --- */
        .mural-post-card { margin-bottom: 2rem; overflow: hidden; padding: 1.5rem; }
        .post-header { display: flex; align-items: center; gap: 1rem; }
        .post-meta h3 { margin: 0; font-size: 1rem; font-weight: 600; }
        .post-meta p { margin: 0; font-size: 0.85rem; color: var(--color-text-secondary); }
        .post-title { margin: 1rem 0; font-size: 1.5rem; line-height: 1.3; }
        .post-content-text { white-space: pre-wrap; color: var(--color-text-primary); margin-bottom: 1rem; }
        .media-container { width: calc(100% + 3rem); margin: 0 -1.5rem 1rem -1.5rem; max-height: 500px; background-color: #000; display: flex; justify-content: center; align-items: center; }
        .media-container img { max-width: 100%; max-height: 500px; object-fit: contain; cursor: zoom-in; }
        .media-container iframe { width: 100%; aspect-ratio: 16/9; border: none; }
        .post-stats { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--color-border); font-size: 0.9rem; color: var(--color-text-secondary); }
        .post-stats-likes { display: flex; align-items: center; gap: 0.25rem; }
        .post-stats-likes .material-icons { font-size: 16px; color: var(--color-info); }
        .post-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; padding-top: 0.5rem; }
        .post-actions .btn-icon { width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem; border-radius: 8px; font-size: 0.9rem; }
        .post-actions .btn-icon:hover { background-color: var(--color-background); }
        .post-actions .btn-icon.liked { color: var(--color-info); font-weight: 700; }
        .comments-section { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-border); }
        .comments-section.visible { display: block; }
        .comment-item { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
        .comment-avatar { width: 32px; height: 32px; font-size: 0.8rem; border-radius: 50%; background-color: var(--color-border); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .comment-box { background-color: var(--color-background); padding: 0.75rem; border-radius: 12px; flex-grow: 1; }
        .comment-author { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem; display: block; }
        .comment-text { font-size: 0.9rem; margin: 0; }
        .comment-input-wrapper { display: flex; gap: 0.75rem; align-items: center; margin-top: 1rem; }
        .comment-input-wrapper input { flex-grow: 1; }
        #new-post-modal .modal-content { max-width: 600px; height: auto; max-height: 90vh; overflow-y: auto; }
        .media-type-options { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .media-option { flex: 1; border: 1px solid var(--color-border); border-radius: 8px; padding: 0.75rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .media-option:hover, .media-option.selected { background-color: var(--color-info-bg); border-color: var(--color-info); color: var(--color-info); font-weight: 600; }
        .media-option .material-icons { display: block; margin-bottom: 0.5rem; }
        #preview-area { margin-top: 1rem; padding: 1rem; background: var(--color-background); border-radius: 8px; text-align: center; display: none; }
        #preview-area img { max-width: 100%; max-height: 200px; border-radius: 4px; }
        #preview-area p { margin: 0; font-size: 0.8rem; color: var(--color-text-secondary); }
        #lightbox-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 5000; cursor: zoom-out; }
        #lightbox-overlay.visible { display: flex; }
        #lightbox-image { max-width: 90vw; max-height: 90vh; object-fit: contain; }
        #lightbox-close { position: absolute; top: 2rem; right: 2rem; color: white; font-size: 36px; cursor: pointer; }

        /* --- REQUESTS MODULE STYLES --- */
        .status-tag { padding: 0.2rem 0.6rem; border-radius: 12px; font-weight: 600; font-size: 0.8rem; text-transform: capitalize; }
        .status-pending { background-color: var(--color-warning-bg); color: var(--color-warning); }
        .status-approved { background-color: var(--color-success-bg); color: var(--color-success); }
        .status-rejected { background-color: var(--color-danger-bg); color: var(--color-danger); }

        #request-modal .modal-content { max-width: 700px; }
        #request-modal .modal-body { max-height: 70vh; overflow-y: auto; }
        .request-type-selection { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .type-card { border: 1px solid var(--color-border); border-radius: 8px; padding: 1.5rem 1rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .type-card:hover { background-color: var(--color-info-bg); border-color: var(--color-info); color: var(--color-info); }
        .type-card .material-icons { font-size: 36px; margin-bottom: 0.75rem; }
        .type-card h3 { margin: 0; font-size: 1rem; }
        .form-section-title { font-weight: 600; margin: 1.5rem 0 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--color-border); }
        .radio-group label { display: inline-flex; align-items: center; margin-right: 1.5rem; font-weight: normal; }
        .radio-group input { margin-right: 0.5rem; }
        textarea.input-field { resize: vertical; min-height: 100px; }

        /* --- ROUTINES MODULE STYLES --- */
        .manage-routines-layout { display: grid; grid-template-columns: 300px 1fr 300px; gap: 1.5rem; height: calc(100vh - 10rem); }
        .routines-column-card { display: flex; flex-direction: column; padding: 0; overflow: hidden; }
        .routines-column-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
        .routines-column-header h3 { margin: 0; font-size: 1.1rem; }
        .routines-list { flex-grow: 1; overflow-y: auto; padding: 0.5rem; }
        .routines-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; margin-bottom: 0.25rem; }
        .routines-list-item:hover { background-color: var(--color-background); }
        .routines-list-item.active { background-color: var(--color-info-bg); color: var(--color-info); font-weight: 600; }
        
        /* --- ROUTINES CALENDAR STYLES --- */
        #my-routines-page .grid { grid-template-columns: 350px 1fr; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0 0.5rem; }
        .calendar-header h3 { margin: 0; text-transform: capitalize; font-size: 1.1rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; }
        .calendar-day, .calendar-weekday { display: flex; align-items: center; justify-content: center; height: 40px; text-align: center; position: relative; }
        .calendar-weekday { font-weight: 600; color: var(--color-text-secondary); font-size: 0.8rem; text-transform: uppercase; }
        .calendar-day:not(.empty) { cursor: pointer; border-radius: 50%; transition: background-color 0.2s, color 0.2s; border: 2px solid transparent; }
        .calendar-day:not(.empty):hover { background-color: var(--color-background); }
        .calendar-day.today span { font-weight: 700; color: var(--color-brand-primary); }
        .calendar-day.active { background-color: var(--color-brand-primary); color: white; border-color: var(--color-brand-primary); }
        .calendar-day.active span { color: white !important; }
        .task-indicator { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); }
        .task-indicator.pending { width: 6px; height: 6px; border-radius: 50%; background-color: var(--color-warning); }
        .task-indicator.completed .material-icons { font-size: 14px; color: var(--color-success); }
        .day-completed { border-color: var(--color-success-bg); }
        .day-pending:not(.active) { font-weight: 600; }
        .active .task-indicator { display: none; }
        #tasks-list-container h3 { margin-top: 0; }
        .routine-group:last-child { margin-bottom: 0; }
        .task-item { padding: 0.5rem 0; }
        .task-item.completed label { text-decoration: line-through; color: var(--color-text-secondary); }

        .routine-group { margin-bottom: 1.5rem; }
        .routine-group summary { list-style: none; /* Esconde a seta padrão */ }
        .routine-group summary::-webkit-details-marker { display: none; /* Esconde a seta no Chrome/Safari */ }
        .routine-group-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 1px solid var(--color-border); margin-bottom: 0.75rem; }
        .routine-group-header h4 { margin: 0; font-size: 1rem; color: var(--color-brand-primary); display: flex; align-items: center; gap: 0.5rem; }
        .routine-group-header h4::before { content: 'expand_more'; font-family: 'Material Icons'; font-size: 20px; transition: transform 0.2s; }
        .routine-group[open] > .routine-group-header h4::before { transform: rotate(180deg); }
        .routine-group-meta { display: flex; align-items: center; gap: 1rem; font-size: 0.8rem; color: var(--color-text-secondary); }
        .task-item.completed .task-title-span { text-decoration: line-through; color: var(--color-text-secondary); }
        .task-description-span { font-size: 0.85rem; color: var(--color-text-secondary); }
        .task-due-time { font-weight: 600; margin-left: 0.5rem; font-size: 0.8rem; }

        /* --- RESPONSIVIDADE (FEATURE 1) --- */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }
            /* Oculta e move a Sidebar para o modo menu-hamburguer */
            .sidebar { 
                width: 100%; height: 100vh; transform: translateX(-100%); 
                transition: transform 0.3s; z-index: 4000; 
                position: fixed; 
            }
            .sidebar.open {
                transform: translateX(0);
            }
            
            /* Ajusta o conteúdo principal */
            main.content { 
                margin-left: 0; padding: 1rem 1rem; 
                padding-top: 3.5rem; /* Espaço para o botão de menu */
            }

            /* Exibe o botão de menu mobile e ajusta o FAB */
            #mobile-menu-toggle {
                display: flex !important;
                position: fixed; 
                top: 0.5rem; 
                left: 0.5rem; 
                z-index: 4001;
                background-color: var(--color-surface);
                border: 1px solid var(--color-border);
                box-shadow: var(--shadow);
                width: 40px; 
                height: 40px; 
                align-items: center;
                justify-content: center;
            }
            .fab {
                right: 1rem;
                bottom: 1rem;
            }

            /* Simplifica Grids */
            .grid, .grid-cols-2, .grid-cols-3 {
                display: block; 
                gap: 0; 
            }
            .grid > div {
                margin-bottom: 1rem;
            }

            /* Torna o pop-up de nova mensagem fullscreen */
            #new-message-popup {
                top: 0;
                right: 0;
                width: 100%;
                max-width: 100%;
                height: 100vh;
                border-radius: 0;
                transform: translateY(100%);
            }
            #new-message-form {
                height: calc(100% - 48px);
            }
            .popup-body {
                padding: 0.5rem;
            }
            
            /* Adaptação de tabelas longas - Garante que haja scroll em tabelas importantes */
            .data-table-fino {
                min-width: 600px;
            }
            
            #conversation-view-page .card {
                height: calc(100vh - 8rem);
            }
        }
        
        /* Estilo para o botão de menu padrão */
        #mobile-menu-toggle {
            position: fixed; 
            top: 1.5rem; 
            left: 1.5rem; 
            z-index: 3000; 
            display: none; 
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            width: 40px; 
            height: 40px; 
            align-items: center;
            justify-content: center;
        }

        /* --- FULLSCREEN FIXES --- */
        body.fullscreen .sidebar { display: none !important; }
        body.fullscreen .theme-toggle { display: none !important; }
        body.fullscreen main.content {
            margin-left: 0 !important;
            padding: 0 !important;
            width: 100vw; 
            height: 100vh;
            position: fixed; 
            top: 0; 
            left: 0; 
            z-index: 9999;
            background: var(--color-background);
            overflow: hidden;
        }
        body.fullscreen .organograma-header { display: none !important; }
        body.fullscreen .organograma-actions-bar { display: none !important; }
        body.fullscreen .organograma-tree-card {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            border: none !important;
            border-radius: 0 !important;
            z-index: 10000 !important;
            overflow: auto !important;
        }
        body.fullscreen .org-tree-wrapper {
            min-height: 100vh;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <button class="theme-toggle" id="theme-toggle" title="Alterar tema" style="display: none;"><span class="material-icons" id="icon-moon">dark_mode</span><span class="material-icons" id="icon-sun">light_mode</span></button>
    <div id="toast-container"></div>
    
    <!-- MAIN MESSAGE POPUP -->
    <div id="new-message-popup"><div class="popup-header"><h3>Nova Mensagem</h3><button onclick="closeNewMessagePopup()"><span class="material-icons">close</span></button></div><form id="new-message-form"><div class="popup-body">
        
        <div class="form-group" id="recipient-group">
            <div class="search-row">
                <div id="recipient-input-wrapper" onclick="document.getElementById('destinatario-input').focus()">
                    <input type="text" id="destinatario-input" placeholder="Digite ou busque ao lado..." autocomplete="off">
                </div>
                <button type="button" class="btn btn-secondary" onclick="openRecipientModal()" title="Abrir Lista Avançada">
                    <span class="material-icons">list</span>
                </button>
            </div>
            <div id="recipient-suggestions"></div>
        </div>

        <div class="form-group"><input type="text" id="assunto" class="input-field" placeholder="Assunto"></div><div id="editor-wrapper"><div id="editor-container"></div></div></div><div class="popup-footer"><div class="popup-footer-top-row"><div class="urgency-selector"><button type="button" class="btn btn-success active" data-priority="normal">Normal</button><button type="button" class="btn btn-secondary" data-priority="important">Importante</button><button type="button" class="btn btn-secondary" data-priority="urgent">Urgente</button></div><div id="chamado-fields" style="display:none;"><label for="due_date">Prazo:</label><input type="date" id="due_date" class="input-field"><div class="date-presets"><button type="button" class="btn btn-secondary" onclick="setDueDate(1)">+1d</button><button type="button" class="btn btn-secondary" onclick="setDueDate(7)">+7d</button></div></div></div><div class="popup-footer-main"><div class="popup-actions-left"><button type="submit" id="btn-send-message" class="btn btn-danger">Enviar</button><input type="file" id="attachment-input" style="display: none;"><button type="button" class="btn btn-icon" onclick="document.getElementById('attachment-input').click()" title="Anexar arquivo"><span class="material-icons">attachment</span></button><div id="attachment-preview"></div><div class="message-type-selector"><div><input type="radio" id="tipo-simples" name="message-type" value="message" checked onchange="toggleChamadoFields()"><label for="tipo-simples">Simples</label></div><div><input type="radio" id="tipo-chamado" name="message-type" value="ticket" onchange="toggleChamadoFields()"><label for="tipo-chamado">Chamado</label></div></div></div><label class="custom-checkbox"><input type="checkbox" id="requires_response"><span class="checkbox-box"><span class="material-icons">check</span></span> Exige Resposta</label></div></div></form></div>

    <!-- RECIPIENT SELECTION MODAL -->
    <div id="recipient-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Selecionar Destinatários</h3>
                <span class="material-icons" style="cursor:pointer;" onclick="closeRecipientModal()">close</span>
            </div>
            
            <div class="filter-row">
                <select id="filter-dept" onchange="applyRecipientFilters()" autocomplete="off">
                    <option value="">Todos Departamentos</option>
                </select>
                <select id="filter-role" onchange="applyRecipientFilters()" autocomplete="off">
                    <option value="">Todos Cargos</option>
                </select>
                <input type="text" id="filter-text" placeholder="Buscar Nome..." oninput="applyRecipientFilters()" autocomplete="off">
            </div>

            <div class="modal-body recipient-table-container">
                <table class="data-table-fino" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Funcionário</th>
                            <th style="width: 30%;">Departamento</th>
                            <th style="width: 20%;">Cargo</th>
                            <th style="width: 10%; text-align: center;">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="recipient-table-body">
                    </tbody>
                </table>
            </div>
            
            <div class="modal-footer">
                <div style="flex-grow: 1; font-size: 0.9rem; color: var(--color-text-secondary);" id="selected-count-display">0 selecionados</div>
                <button class="btn btn-danger" onclick="closeRecipientModal()">Concluir Seleção</button>
            </div>
        </div>
    </div>

    <!-- NEW POST MODAL (MURAL) -->
    <div id="new-post-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nova Publicação no Mural</h3>
                <span class="material-icons" style="cursor:pointer;" onclick="closeNewPostModal()">close</span>
            </div>
            <div class="modal-body">
                <form id="new-post-form">
                    <div class="form-group">
                        <label for="post-title">Título</label>
                        <input type="text" id="post-title" class="input-field" placeholder="Ex: Festa de Fim de Ano" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo de Mídia</label>
                        <div class="media-type-options">
                            <div class="media-option selected" onclick="selectMediaType('text')" id="opt-text">
                                <span class="material-icons">notes</span> Texto
                            </div>
                            <div class="media-option" onclick="selectMediaType('image')" id="opt-image">
                                <span class="material-icons">image</span> Imagem
                            </div>
                            <div class="media-option" onclick="selectMediaType('carousel')" id="opt-carousel">
                                <span class="material-icons">view_carousel</span> Carrossel
                            </div>
                            <div class="media-option" onclick="selectMediaType('video')" id="opt-video">
                                <span class="material-icons">smart_display</span> Vídeo
                            </div>
                        </div>
                        <input type="hidden" id="post-media-type" value="text">
                    </div>

                    <div class="form-group" id="media-input-group" style="display: none;">
                        <label id="media-input-label">Arquivo de Mídia</label>
                        <input type="file" id="post-media-file" class="input-field" accept="image/*">
                        <div id="preview-area"></div>
                    </div>

                    <div class="form-group">
                        <label for="post-content">Conteúdo</label>
                        <textarea id="post-content" class="input-field" rows="6" placeholder="Escreva a mensagem aqui..." style="resize: vertical;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeNewPostModal()">Cancelar</button>
                <button class="btn btn-danger" id="btn-publish-post" onclick="submitPost()">Publicar</button>
            </div>
        </div>
    </div>

    <!-- REQUESTS MODAL -->
    <div id="request-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="request-modal-title">Nova Requisição</h3>
                <span class="material-icons" style="cursor:pointer;" onclick="closeRequestModal()">close</span>
            </div>
            <div class="modal-body" id="request-modal-body">
                <!-- Dynamic Content will be injected here -->
            </div>
            <div class="modal-footer" id="request-modal-footer">
                <!-- Dynamic Buttons will be injected here -->
            </div>
        </div>
    </div>

    <!-- CONFIRMATION MODAL -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-body" style="display: flex; flex-direction: column; align-items: center; padding-top: 2rem;">
                <span class="material-icons confirm-icon">warning</span>
                <h3 class="confirm-title" id="confirm-title">Tem certeza?</h3>
                <p class="confirm-message" id="confirm-message">Esta ação é irreversível.</p>
                <div style="display: flex; gap: 1rem; width: 100%;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="closeConfirmationModal()">Cancelar</button>
                    <button class="btn btn-danger" style="flex: 1;" id="btn-confirm-action">Sim, confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX FOR IMAGES (NEW) -->
    <div id="lightbox-overlay" onclick="closeLightbox()">
        <span id="lightbox-close" onclick="closeLightbox()">&times;</span>
        <img id="lightbox-image" src="">
    </div>

    <!-- ROUTINE MODALS -->
    <div id="new-routine-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Nova Rotina</h3><span class="material-icons" style="cursor:pointer;" onclick="this.parentElement.parentElement.parentElement.classList.remove('visible')">close</span></div>
            <div class="modal-body">
                <form id="new-routine-form">
                    <div class="form-group"><label for="routine-title">Título da Rotina</label><input type="text" id="routine-title" class="input-field" required></div>
                    <div class="form-group"><label for="routine-description">Descrição</label><textarea id="routine-description" class="input-field" rows="3"></textarea></div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.classList.remove('visible')">Cancelar</button><button class="btn btn-danger" id="btn-create-routine">Criar Rotina</button></div>
        </div>
    </div>
    <div id="new-task-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Nova Tarefa</h3><span class="material-icons" style="cursor:pointer;" onclick="this.parentElement.parentElement.parentElement.classList.remove('visible')">close</span></div>
            <div class="modal-body">
                <form id="new-task-form">
                    <input type="hidden" id="task-routine-id">
                    <div class="form-group"><label for="task-title">Título da Tarefa</label><input type="text" id="task-title" class="input-field" required></div>
                    <div class="form-group"><label for="task-order">Ordem da Tarefa (#)</label><input type="number" id="task-order" class="input-field" required min="1"></div>
                    <div class="form-group"><label for="task-description">Descrição</label><textarea id="task-description" class="input-field" rows="3"></textarea></div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.classList.remove('visible')">Cancelar</button><button class="btn btn-danger" id="btn-create-task">Adicionar Tarefa</button></div>
        </div>
    </div>
    <div id="assign-users-modal" class="modal-overlay">
         <div class="modal-content" style="max-width: 700px; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header"><h3>Atribuir Usuários à Rotina</h3><span class="material-icons" style="cursor:pointer;" onclick="this.parentElement.parentElement.parentElement.classList.remove('visible')">close</span></div>
            <div class="modal-body" style="padding: 0; display:flex; flex-direction:column; overflow-y: auto;">
                <input type="hidden" id="assign-routine-id">
                <div class="recipient-table-container" style="padding: 1.5rem 1.5rem 0 1.5rem;">
                    <table class="data-table" style="width: 100%;">
                        <thead><tr><th><input type="checkbox" id="select-all-users-routine"></th><th>Funcionário</th><th>Departamento</th></tr></thead>
                        <tbody id="assign-users-table-body"></tbody>
                    </table>
                </div>
                
                <div style="padding: 1.5rem; background-color: var(--color-background); border-top: 1px solid var(--color-border); margin-top: auto;">
                    <div class="form-group">
                        <label for="assignment-date-input">Datas de Atribuição</label>
                        <div style="display: flex; gap: 1rem;">
                            <input type="date" id="assignment-date-input" class="input-field">
                            <button type="button" class="btn btn-secondary" id="add-date-btn">Adicionar</button>
                        </div>
                    </div>
                    <div id="selected-dates-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;">
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.classList.remove('visible')">Cancelar</button><button class="btn btn-danger" id="btn-assign-users">Salvar Atribuições</button></div>
        </div>
    </div>

    <!-- EDIT ROUTINE MODAL -->
    <div id="edit-routine-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Editar Rotina</h3><span class="material-icons" style="cursor:pointer;" onclick="this.parentElement.parentElement.parentElement.classList.remove('visible')">close</span></div>
            <div class="modal-body">
                <form id="edit-routine-form">
                    <input type="hidden" id="edit-routine-id">
                    <div class="form-group"><label for="edit-routine-title">Título da Rotina</label><input type="text" id="edit-routine-title" class="input-field" required></div>
                    <div class="form-group"><label for="edit-routine-description">Descrição</label><textarea id="edit-routine-description" class="input-field" rows="3"></textarea></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.classList.remove('visible')">Cancelar</button>
                <button class="btn btn-danger" id="btn-update-routine">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <!-- CANCELLATION MODAL -->
    <div id="cancellation-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>Confirmar Cancelamento</h3>
                <span class="material-icons" style="cursor:pointer;" onclick="this.parentElement.parentElement.parentElement.classList.remove('visible')">close</span>
            </div>
            <div class="modal-body">
                <p style="color: var(--color-text-secondary); margin-top: 0;">Para prosseguir, por favor, informe o motivo do cancelamento da requisição de viagem.</p>
                <div class="form-group">
                    <label for="cancellation-reason">Motivo do Cancelamento</label>
                    <textarea id="cancellation-reason" class="input-field" rows="3" placeholder="Ex: Mudança de data do evento..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.classList.remove('visible')">Voltar</button>
                <button class="btn btn-danger" id="btn-confirm-cancellation">Sim, Cancelar Requisição</button>
            </div>
        </div>
    </div>

    <!-- EDIT TASK MODAL -->
    <div id="edit-task-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Editar Tarefa</h3><span class="material-icons" style="cursor:pointer;" onclick="this.parentElement.parentElement.parentElement.classList.remove('visible')">close</span></div>
            <div class="modal-body">
                <form id="edit-task-form">
                    <input type="hidden" id="edit-task-id">
                    <div class="form-group"><label for="edit-task-title">Título da Tarefa</label><input type="text" id="edit-task-title" class="input-field" required></div>
                    <div class="form-group"><label for="edit-task-order">Ordem da Tarefa (#)</label><input type="number" id="edit-task-order" class="input-field" required min="1"></div>
                    <div class="form-group"><label for="edit-task-description">Descrição</label><textarea id="edit-task-description" class="input-field" rows="3"></textarea></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.classList.remove('visible')">Cancelar</button>
                <button class="btn btn-danger" id="btn-update-task">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://flegnghsopbrulnnpuvz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsZWduZ2hzb3BicnVsbm5wdXZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDc2MjMsImV4cCI6MjA3ODMyMzYyM30.oZN5gJyNemgYT8nKsXwK9y8cYY_SjLR-sfMqZeaOdQ4';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- LOGO URLS ---
        const LOGO_LIGHT_URL = 'https://ctfamadobrasil.com.br/wp-content/uploads/2025/09/logo.png';
        const LOGO_DARK_URL = 'https://ctfamadobrasil.com.br/wp-content/uploads/2025/12/Gemini_Generated_Image_v8cib8v8cib8v8ci-removebg-preview.png';

        // --- N8N WEBHOOK URLs ---
        const N8N_CREATE_USER_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/create-user';
        const N8N_UPDATE_USER_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/update-user';
        const N8N_DELETE_USER_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/delete-user';
        const N8N_SEND_MESSAGE_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/21446ed7-79bd-4a14-b954-ab729bb61f26';
        const N8N_SEND_REPLY_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/send-reply'; 
        const N8N_MARK_AS_READ_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/mark-as-read';
        const N8N_TOGGLE_ARCHIVE_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/toggle-archive';
        const N8N_RESOLVE_TICKET_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/resolve-ticket';
        const N8N_CREATE_POST_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/create-post';
        const N8N_LIKE_POST_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/like-post';
        const N8N_COMMENT_POST_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/comment-post';
        const N8N_CREATE_REQUEST_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/criar-requisicao';
        const N8N_APPROVE_REQUEST_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/aprova-requisicao';
        const N8N_REJECT_REQUEST_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/reprova-requisicao';
        const N8N_COMPLETE_TASK_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/toggle-task-status';
        const N8N_CREATE_ROUTINE_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/criar-rotina';
        const N8N_ADD_TASK_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/adicionar-tarefa';
        const N8N_ASSIGN_ROUTINE_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/atribuir-rotina';
        const N8N_UPDATE_ROUTINE_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/update-routine';
        const N8N_DELETE_ROUTINE_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/delete-routine';
        const N8N_UPDATE_TASK_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/update-routine-task';
        const N8N_DELETE_TASK_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/delete-routine-task';
        const N8N_REORDER_TASKS_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/reorder-tasks';
        const N8N_REMOVE_USER_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/remove-user-from-routine';
        // NEW WEBHOOK URLS FOR TRAVEL
        const N8N_CREATE_TRAVEL_REQUEST_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/create-travel-request';
        const N8N_REGISTER_DECISION_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/submit-travel-decision';
        const N8N_CANCEL_TRAVEL_REQUEST_URL = 'https://n8n-n8n.znxk1t.easypanel.host/webhook/cancel-travel-request';


        // Mapeamento de permissões RBAC
        const PERMISSION_MAPPING = {
            'manage_travel': 'Gerenciar Viagens (Controladoria)',
            'manage_hr': 'Gerenciar Requisições Gerais (RH)',
            'manage_routines': 'Gerenciar Rotinas do Setor',
            'manage_users': 'Administrador Geral'
        };

        let currentUserProfile = null;
        let quillEditor = null;
        let allUsers = [];
        let selectedRecipients = [];
        let selectedFile = null;
        let currentRequestType = null;
        let selectedAssignmentDates = [];
        let routineCurrentDate = new Date();
        let currentMenu = null;
        let currentEditingRequest = null; // <- NOVA VARIÁVEL GLOBAL
        let selectedParticipants = [];


        const root = document.getElementById('root');
        const themeToggleBtn = document.getElementById('theme-toggle');

        const authHTML = `<div class="login-wrapper visible" id="auth-wrapper"><div id="auth-container" class="login-container"><img src="${LOGO_LIGHT_URL}" alt="Logo Fama" class="login-logo"><p class="login-subtitle">Sistema de Governança Fama</p><form id="login-form"><div class="input-group"><input type="email" id="email" class="input-field" placeholder="Email" required></div><div class="input-group"><input type="password" id="password" class="input-field" placeholder="Senha" required></div><button type="submit" class="btn-primary" style="width: 100%;">Entrar</button></form></div></div>`;
        const appHTML = `<div id="app-container">
            <aside class="sidebar">
                <div class="sidebar-header"><img src="${LOGO_LIGHT_URL}" alt="Logo Fama" class="sidebar-logo"></div>
                <div class="sidebar-scroll-area">
                    <ul class="nav-menu">
                        <li><a href="#" class="nav-link" data-page="dashboard-page"><span class="material-icons">dashboard</span> Dashboard</a></li>
                        <li><a href="#" class="nav-link" data-page="messages-page"><span class="material-icons">inbox</span> Mensagens</a></li>
                        <li><a href="#" class="nav-link" data-page="requests-page"><span class="material-icons">description</span> Requisições</a></li>
                        <li><a href="#" class="nav-link" data-page="my-routines-page"><span class="material-icons">checklist</span> Minhas Rotinas</a></li>
                        <li><a href="#" class="nav-link" data-page="channels-page"><span class="material-icons">tag</span> Canais</a></li>
                        <li><a href="#" class="nav-link" data-page="team-page"><span class="material-icons">people</span> Equipe</a></li>
                        <li><a href="#" class="nav-link" data-page="organograma-page"><span class="material-icons">account_tree</span> Organograma</a></li>
                        <li><a href="#" class="nav-link" data-page="rankings-page"><span class="material-icons">leaderboard</span> Performance e Rankings</a></li>
                        <li><a href="#" class="nav-link" data-page="mural-page"><span class="material-icons">campaign</span> Mural Cultural</a></li>
                        <li><a href="#" class="nav-link" data-page="kb-page"><span class="material-icons">school</span> Base de Conhecimento</a></li>
                    </ul>
                    <div id="admin-section" style="display: none;">
                        <h3 class="nav-section-title">Administração</h3>
                        <ul class="nav-menu"></ul>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <div id="profile-shortcut" class="profile-shortcut"></div>
                    <ul class="nav-menu">
                        <li><a href="#" class="nav-link" id="logout-button"><span class="material-icons">logout</span> Sair</a></li>
                    </ul>
                </div>
            </aside>
            <main class="content">
                <button id="mobile-menu-toggle" class="btn btn-icon" title="Menu"><span class="material-icons">menu</span></button>
                <div id="dashboard-page" class="page-content"><div class="page-header"><div><h1 id="dashboard-title">Dashboard</h1><p>Visão geral do seu desempenho</p></div></div><div class="grid grid-cols-2"><div class="card stat-card card-warning"><div class="stat-icon"><span class="material-icons">mark_email_unread</span></div><div class="stat-info"><h3>Mensagens Pendentes</h3><p id="pending-messages-count">0</p></div></div><div class="card stat-card card-danger"><div class="stat-icon"><span class="material-icons">report_problem</span></div><div class="stat-info"><h3>Chamados Abertos</h3><p id="urgent-tickets-count">0</p></div></div></div></div>
                <div id="messages-page" class="page-content"><div class="page-header"><h1>Mensagens</h1></div><div class="message-actions-header"><div class="tabs-container"><button class="tab-link active" data-tab="inbox-content">Caixa de Entrada</button><button class="tab-link" data-tab="sent-content">Enviados</button><button class="tab-link" data-tab="tickets-content">Chamados</button><button class="tab-link" data-tab="archived-content">Arquivados</button></div><button id="refresh-messages-btn" class="refresh-btn" title="Atualizar mensagens"><span class="material-icons">refresh</span></button></div><div class="card" style="padding: 0; border-top-left-radius: 0; border-top-right-radius: 0;"><div id="inbox-content" class="tab-content active"></div><div id="sent-content" class="tab-content"></div><div id="tickets-content" class="tab-content"></div><div id="archived-content" class="tab-content"></div></div></div>
                <div id="requests-page" class="page-content"><div class="page-header"><div><h1>Requisições</h1><p>Gerencie solicitações de RH e administrativas.</p></div><div class="page-header-actions"><button id="btn-new-request" class="btn btn-danger"><span class="material-icons">add</span> Nova Requisição</button></div></div><div class="card" style="padding:0;"><table class="data-table"><thead><tr><th style="width: 18%;">Tipo</th><th style="width: 25%;">Solicitante</th><th style="width: 14%;">Data</th><th style="width: 20%;">Status</th><th style="width: 23%;">Ações</th></tr></thead><tbody id="request-table-body"></tbody></table></div></div>
                <div id="conversation-view-page" class="page-content"><div class="page-header" id="conversation-header"></div><div class="card"><div id="conversation-messages">Carregando conversa...</div><div id="reply-form-wrapper"><div id="reply-attachment-preview"></div><form id="reply-form" data-conversation-id=""><input type="file" id="reply-attachment-input" style="display: none;"><button type="button" class="btn btn-icon" onclick="document.getElementById('reply-attachment-input').click()" title="Anexar arquivo"><span class="material-icons">attachment</span></button><input type="text" id="reply-input" class="input-field" placeholder="Digite sua resposta..." required><button type="submit" class="btn btn-danger">Enviar</button></form></div></div></div>
                <div id="team-page" class="page-content"><div class="page-header"><h1>Equipe</h1><p>Veja os perfis e performance dos seus colegas.</p></div>
                    <div class="card team-filters">
                        <div class="form-group" style="margin:0;"><label for="team-search-name">Buscar por Nome</label><input type="text" id="team-search-name" class="input-field" placeholder="Digite um nome..."></div>
                        <div class="form-group" style="margin:0;"><label for="team-filter-dept">Filtrar por Setor</label><select id="team-filter-dept" class="input-field"></select></div>
                        <div class="form-group" style="margin:0;"><label for="team-filter-role">Filtrar por Cargo</label><select id="team-filter-role" class="input-field"></select></div>
                    </div>
                <div id="team-list-content">Carregando equipe...</div></div>
                <div id="organograma-page" class="page-content">
                    <div class="page-header organograma-header">
                        <div>
                            <h1>Organograma Vivo</h1>
                            <p>Estrutura hierárquica da empresa</p>
                        </div>
                    </div>
                    
                    <div class="card organograma-actions-bar" style="margin-bottom: 2rem; padding: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                            <label for="org-filter-dept" style="font-weight: 600; font-size: 0.9rem; color: var(--color-text-secondary); white-space: nowrap;">Visualizar Área:</label>
                            <select id="org-filter-dept" class="input-field" onchange="loadOrganogramaPage(this.value)" style="max-width: 300px; flex-grow: 1;"></select>
                        </div>
                        <button class="btn btn-danger" onclick="openUserModal(null)">
                            <span class="material-icons">person_add</span> Novo Colaborador
                        </button>
                    </div>
                    
                    <div class="card organograma-tree-card" id="organograma-tree-container" style="overflow-x: auto; position: relative;">
<div class="zoom-controls" style="position: absolute; top: 1rem; left: 1rem; z-index: 100; display: flex; gap: 0.5rem;">
                            <button onclick="zoomOrganograma(-0.1)" class="btn-icon-secondary" title="Diminuir Zoom">
                                <span class="material-icons">zoom_out</span>
                            </button>
                            <span id="zoom-level" style="padding: 0.5rem 1rem; background: var(--color-surface); border-radius: 6px; font-size: 0.9rem; font-weight: 600; min-width: 60px; text-align: center;">100%</span>
                            <button onclick="zoomOrganograma(0.1)" class="btn-icon-secondary" title="Aumentar Zoom">
                                <span class="material-icons">zoom_in</span>
                            </button>
                            <button onclick="resetZoomOrganograma()" class="btn-icon-secondary" title="Resetar Zoom">
                                <span class="material-icons">restart_alt</span>
                            </button>
                        </div>
                        <div class="empty-state">Carregando organograma...</div>
                    </div>
                </div>
                <div id="channels-page" class="page-content"><div class="page-header"><h1>Canais</h1></div><div class="empty-state">Funcionalidade em desenvolvimento.</div></div>
                <div id="rankings-page" class="page-content">
                    <div class="page-header">
                        <h1>Performance e Rankings</h1>
                        <p>Acompanhe o desempenho e celebre as conquistas da equipe</p>
                    </div>

                    <div class="grid grid-cols-2">
                        <!-- Card para Respondedores Rápidos -->
                        <div class="card">
                            <h3 class="card-title" style="margin-bottom: 2rem;">
                                <span class="material-icons" style="color: var(--color-success);">trending_up</span>
                                Top 5 - Respondedores Mais Rápidos
                            </h3>
                            <div id="fastest-responders-list">
                                <div class="empty-state">Carregando ranking...</div>
                            </div>
                        </div>

                        <!-- Card para Maior Volume de Pendências -->
                        <div class="card">
                            <h3 class="card-title" style="margin-bottom: 2rem;">
                                <span class="material-icons" style="color: var(--color-danger);">report_problem</span>
                                Top 5 - Maior Volume de Pendências
                            </h3>
                            <div id="most-pending-list">
                                <div class="empty-state">Carregando ranking...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="mural-page" class="page-content"><div class="page-header"><h1>Mural Cultural</h1><p>Acompanhe os eventos e novidades da Fama.</p></div><div id="mural-content">Carregando...</div><button class="fab hidden" id="fab-new-post" title="Nova Postagem"><span class="material-icons">add</span></button></div>
                <div id="kb-page" class="page-content"><div class="page-header"><h1>Base de Conhecimento</h1></div><div class="empty-state">Funcionalidade em desenvolvimento.</div></div>
                <div id="admin-dashboard-page" class="page-content"><div class="page-header"><h1>Dashboard Administrativo</h1></div><div class="card">Métricas da plataforma aparecerão aqui.</div></div>
                <div id="users-page" class="page-content"><div class="page-header"><div class="page-header-title"><h1>Gerenciamento de Usuários</h1></div><div class="page-header-actions"><button id="refresh-users-btn" class="refresh-btn" title="Atualizar usuários"><span class="material-icons">refresh</span></button><button id="btn-new-user" class="btn btn-danger"><span class="material-icons">add</span> Novo Usuário</button></div></div><div class="card" style="padding:0;"><table class="data-table"><thead><tr><th>Usuário & Email</th><th>Departamento & Cargo</th><th>Score</th><th>Ações</th></tr></thead><tbody id="user-table-body"></tbody></table></div></div>
                <div id="profile-page" class="page-content">
                    <div id="user-profile-content"></div>
                    <div id="user-history-content"></div>
                </div>
                <div id="request-management-page" class="page-content">
                    <div class="page-header">
                        <div>
                            <h1>Gerenciamento de Requisições</h1>
                            <p>Visualize e gerencie todas as solicitações da plataforma.</p>
                        </div>
                    </div>
                    <div class="card" style="padding:0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 20%;">Solicitante</th>
                                    <th style="width: 25%;">Tipo</th>
                                    <th style="width: 20%;">Data</th>
                                    <th style="width: 15%;">Status</th>
                                    <th style="width: 20%;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="request-management-table-body">
                                <tr><td colspan="5" class="empty-state">Carregando requisições...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- NEW TRAVEL MANAGEMENT PAGE -->
                <div id="travel-request-management-page" class="page-content">
                    <div class="page-header">
                        <div>
                            <h1>Gerenciamento de Requisições de Viagem</h1>
                            <p>Analise e gerencie todas as solicitações de viagem.</p>
                        </div>
                    </div>
                    <div class="card" style="padding:0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 20%;">Solicitante</th>
                                    <th style="width: 25%;">Título</th>
                                    <th style="width: 20%;">Destino</th>
                                    <th style="width: 15%;">Período</th>
                                    <th style="width: 10%;">Status</th>
                                    <th style="width: 10%;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="travel-request-management-table-body">
                                <tr><td colspan="6" class="empty-state">Carregando requisições...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="my-routines-page" class="page-content"></div>
                <div id="manage-routines-page" class="page-content"></div>
                <button class="fab" id="fab-new-message" title="Nova Mensagem"><span class="material-icons">add</span></button>
            </main>
<div id="user-modal" class="modal-overlay">
                <div class="modal-content" style="max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
                    <div class="modal-header">
                        <h2 id="user-modal-title">Novo Usuário</h2>
                        <span class="material-icons" style="cursor:pointer;" onclick="closeUserModal()">close</span>
                    </div>
                    
                    <div class="modal-body" style="overflow-y: auto; flex: 1; padding: 1.5rem;">
                        <form id="user-form">
                            <input type="hidden" id="user-id">
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="full_name">Nome Completo</label>
                                    <input type="text" id="full_name" class="input-field" required>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="user_email">Email</label>
                                    <input type="email" id="user_email" class="input-field" required>
                                </div>
                            </div>
                            
                            <div id="password-group" class="form-group">
                                <label for="user_password">Senha</label>
                                <input type="password" id="user_password" class="input-field">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="department">Departamento</label>
                                    <select id="department" class="input-field" onchange="toggleDepartmentOther()">
                                        <option value="">Selecione...</option>
                                        <option value="Administrativo">Administrativo</option>
                                        <option value="Controladoria">Controladoria</option>
                                        <option value="Recursos Humanos">Recursos Humanos</option>
                                        <option value="Comercial">Comercial</option>
                                        <option value="Produção">Produção</option>
                                        <option value="Fundição">Fundição</option>
                                        <option value="Grampos">Grampos</option>
                                        <option value="TI">TI</option>
                                        <option value="Outros">Outros</option>
                                    </select>
                                    <input type="text" id="department-other" class="input-field" placeholder="Especifique o departamento..." style="display: none; margin-top: 0.5rem;">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="role">Cargo</label>
                                    <select id="role" class="input-field">
                                        <option value="">Selecione...</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Gerente">Gerente</option>
                                        <option value="Supervisor">Supervisor</option>
                                        <option value="Líder">Líder</option>
                                        <option value="Auxiliar">Auxiliar</option>
                                        <option value="Colaborador">Colaborador</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="manager_id">Gerente Direto</label>
                                <select id="manager_id" class="input-field">
                                    <option value="">Nenhum</option>
                                </select>
                            </div>
                            
                            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--color-border);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <span class="material-icons" style="font-size: 20px; color: var(--color-brand-primary);">security</span>
                                    <label style="font-weight: 600; font-size: 0.95rem; margin: 0;">Permissões Especiais</label>
                                </div>
                                <p style="font-size: 0.8rem; color: var(--color-text-secondary); margin: 0 0 1rem 0;">
                                    Marcadas = substituem permissões do cargo
                                </p>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.625rem;">
                                    <label class="perm-checkbox">
                                        <input type="checkbox" id="perm-manage_travel">
                                        <span class="perm-checkmark"></span>
                                        <span class="material-icons perm-icon">flight_takeoff</span>
                                        <span class="perm-text">Gerenciar Viagens</span>
                                    </label>
                                    
                                    <label class="perm-checkbox">
                                        <input type="checkbox" id="perm-manage_hr">
                                        <span class="perm-checkmark"></span>
                                        <span class="material-icons perm-icon">assignment</span>
                                        <span class="perm-text">Gerenciar Requisições (Gerais)</span>
                                    </label>
                                    
                                    <label class="perm-checkbox">
                                        <input type="checkbox" id="perm-manage_routines">
                                        <span class="perm-checkmark"></span>
                                        <span class="material-icons perm-icon">checklist</span>
                                        <span class="perm-text">Gerenciar Rotinas (Do Departamento)</span>
                                    </label>
                                    
                                    <label class="perm-checkbox">
                                        <input type="checkbox" id="perm-manage_users">
                                        <span class="perm-checkmark"></span>
                                        <span class="material-icons perm-icon">admin_panel_settings</span>
                                        <span class="perm-text">Admin Geral</span>
                                    </label>
                                </div>
                                
                                <div style="margin-top: 1rem; padding: 0.875rem; background: var(--color-info-bg); border-left: 3px solid var(--color-info); border-radius: 6px;">
                                    <p style="margin: 0; font-size: 0.8rem; line-height: 1.5; color: var(--color-text-primary);">
                                        <strong style="display: flex; align-items: center; gap: 0.25rem; margin-bottom: 0.25rem;">
                                            <span style="font-size: 1rem;">💡</span> Entenda as Regras:
                                        </strong>
                                        <span style="color: var(--color-text-secondary);">
                                            Gerenciar Viagens é centralizado na <strong>Controladoria</strong>. Gerentes e Supervisores gerenciam Rotinas de seus setores <strong>por padrão</strong>. Use as permissões acima apenas para exceções ou cargos administrativos.
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeUserModal()">Cancelar</button>
                        <button class="btn btn-danger" onclick="saveUser()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>`;
        
        document.addEventListener('DOMContentLoaded', checkUserSession);
        
        function showToast(message, type = 'info') { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast toast-${type}`; const icons = { success: 'check_circle', danger: 'error', warning: 'warning', info: 'info' }; toast.innerHTML = `<span class="material-icons toast-icon">${icons[type]}</span><span class="toast-message">${message}</span><button class="toast-close">&times;</button>`; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 100); const removeToast = () => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }; const timeoutId = setTimeout(removeToast, 5000); toast.querySelector('.toast-close').addEventListener('click', () => { clearTimeout(timeoutId); removeToast(); }); }
        
        async function checkUserSession() {
            applyTheme(localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
            themeToggleBtn.style.display = 'flex';
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                await fetchUserProfile(session.user);
                renderAppLayout();
            } else {
                renderAuthLayout();
            }
        }
        
        function renderAuthLayout() { root.innerHTML = authHTML; updateLogos(); document.getElementById('login-form').addEventListener('submit', handleLogin); }
        function renderAppLayout() { root.innerHTML = appHTML; updateLogos(); setupEventListeners(); showApp(); }

        function setupEventListeners() {
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('new-message-form').addEventListener('submit', sendMessage);
            document.getElementById('btn-new-user')?.addEventListener('click', () => openUserModal(null));
            document.getElementById('fab-new-message').addEventListener('click', openNewMessagePopup);
            document.getElementById('fab-new-post').addEventListener('click', openNewPostModal); 
            document.getElementById('btn-new-request').addEventListener('click', openRequestModal);
            document.getElementById('attachment-input').addEventListener('change', handleFileSelection);

            document.getElementById('btn-confirm-cancellation').addEventListener('click', () => {
                const btn = document.getElementById('btn-confirm-cancellation');
                const reason = document.getElementById('cancellation-reason').value.trim();
                const requestId = btn.getAttribute('data-request-id');

                if (!requestId || requestId.trim() === '') {
                    showToast("Erro crítico: ID da requisição perdido. Feche o modal e tente novamente.", "danger");
                    return;
                }
                if (!reason) {
                    showToast("O motivo do cancelamento é obrigatório.", "warning");
                    return;
                }
                document.getElementById('cancellation-modal').classList.remove('visible');
                submitCancellation(requestId.trim(), reason);
            });
            
            document.getElementById('post-media-file').addEventListener('change', handlePostMediaPreview);

            const sidebar = document.querySelector('.sidebar');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                });
            }

            document.querySelectorAll('.nav-link[data-page]').forEach(link => { 
                link.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    showPage(e.currentTarget.dataset.page); 
                    
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('open');
                    }
                }); 
            });

            const replyForm = document.getElementById('reply-form');
            if (replyForm) {
                replyForm.onsubmit = handleReply;
            }


            document.querySelectorAll('.urgency-selector .btn').forEach(button => { button.addEventListener('click', (e) => { e.preventDefault(); document.querySelectorAll('.urgency-selector .btn').forEach(btn => { btn.classList.remove('btn-success', 'btn-warning', 'btn-danger', 'active'); btn.classList.add('btn-secondary'); }); const clickedButton = e.currentTarget; clickedButton.classList.remove('btn-secondary'); clickedButton.classList.add('active'); const priority = clickedButton.dataset.priority; if (priority === 'normal') clickedButton.classList.add('btn-success'); else if (priority === 'important') clickedButton.classList.add('btn-warning'); else if (priority === 'urgent') clickedButton.classList.add('btn-danger'); }); });
            const recipientInput = document.getElementById('destinatario-input');
            if (recipientInput) { recipientInput.addEventListener('input', handleRecipientSearch); recipientInput.addEventListener('keydown', handleRecipientBackspace); }
            document.querySelectorAll('#messages-page .tab-link').forEach(tab => { tab.addEventListener('click', (e) => { const targetId = e.currentTarget.dataset.tab; document.querySelectorAll('#messages-page .tab-link').forEach(t => t.classList.remove('active')); document.querySelectorAll('#messages-page .tab-content').forEach(c => c.classList.remove('active')); e.currentTarget.classList.add('active'); document.getElementById(targetId).classList.add('active'); }); });
            
            document.getElementById('team-search-name').addEventListener('input', loadTeamPage);
            document.getElementById('team-filter-dept').addEventListener('change', loadTeamPage);
            document.getElementById('team-filter-role').addEventListener('change', loadTeamPage);

            const refreshMessagesBtn = document.getElementById('refresh-messages-btn');
            if(refreshMessagesBtn) {
                refreshMessagesBtn.addEventListener('click', async () => {
                    refreshMessagesBtn.disabled = true;
                    refreshMessagesBtn.classList.add('loading');
                    try { await loadMessages(); showToast("Caixa de entrada atualizada!", "info"); } 
                    catch (e) { showToast("Falha ao atualizar.", "danger"); } 
                    finally { refreshMessagesBtn.classList.remove('loading'); refreshMessagesBtn.disabled = false; }
                });
            }

            const refreshUsersBtn = document.getElementById('refresh-users-btn');
            if(refreshUsersBtn) {
                refreshUsersBtn.addEventListener('click', async () => {
                    refreshUsersBtn.disabled = true;
                    refreshUsersBtn.classList.add('loading');
                    try { await loadUsersForAdmin(); showToast("Lista de usuários atualizada!", "info"); } 
                    catch (e) { showToast("Falha ao atualizar usuários.", "danger"); } 
                    finally { refreshUsersBtn.classList.remove('loading'); refreshUsersBtn.disabled = false; }
                });
            }
        }

        async function handleLogin(e) { e.preventDefault(); const email = document.getElementById('email').value; const password = document.getElementById('password').value; const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password }); if (error) { showToast('Erro no login: ' + error.message, 'danger'); } else if (data.user) { await fetchUserProfile(data.user); await showWelcomeNotification(); renderAppLayout(); } }
        async function handleLogout() { await supabaseClient.auth.signOut(); currentUserProfile = null; allUsers = []; renderAuthLayout(); }
        
        async function fetchUserProfile(user) {
            const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
            if (data) { currentUserProfile = { ...data, email: user.email }; } 
            else { console.error("Perfil não encontrado:", error); currentUserProfile = { id: user.id, email: user.email, full_name: 'Usuário' }; }
        }

        async function showApp() { 
            const appContainer = document.getElementById('app-container'); if (!appContainer) return;
            appContainer.classList.add('visible'); 

            checkNotificationTriggers(); // <-- CHAMA A CENTRAL DE ALERTAS 

            const { data: permissions, error: permissionsError } = await supabaseClient.rpc('get_user_permissions');
            if (permissionsError) {
                console.error('Erro ao buscar permissões:', permissionsError);
                currentUserProfile.permissions = [];
            } else {
                currentUserProfile.permissions = permissions;
            }

            const hasAdminPermissions = currentUserProfile && currentUserProfile.permissions && currentUserProfile.permissions.length > 0;
            const adminSection = document.getElementById('admin-section');
            if (adminSection) adminSection.style.display = hasAdminPermissions ? 'block' : 'none';
            
            const profileShortcut = document.getElementById('profile-shortcut');
            const avatarInitial = currentUserProfile.full_name ? currentUserProfile.full_name.charAt(0).toUpperCase() : '?';
            profileShortcut.innerHTML = `
                <div class="user-avatar">${avatarInitial}</div>
                <div>
                    <div class="user-name">${currentUserProfile.full_name}</div>
                    <div class="user-role">${currentUserProfile.role || 'Colaborador'}</div>
                </div>
            `;
            profileShortcut.onclick = () => showPage('profile-page');

            showPage('dashboard-page'); 
            loadAllDynamicData();
            document.getElementById('dashboard-title').textContent = `Dashboard de ${currentUserProfile.full_name.split(' ')[0]}`;

            const adminMenuUl = document.querySelector('#admin-section .nav-menu');
            if (adminMenuUl && currentUserProfile.permissions) {
                let menuHTML = '';
                const permissions = currentUserProfile.permissions;

                if (permissions.includes('manage_users') || permissions.includes('manage_requests') || permissions.includes('manage_routines')) {
                    
                    if (permissions.includes('manage_users')) {
                        menuHTML += `<li><a href="#" class="nav-link" data-page="admin-dashboard-page"><span class="material-icons">admin_panel_settings</span> Admin Dashboard</a></li>`;
                        menuHTML += `<li><a href="#" class="nav-link" data-page="users-page"><span class="material-icons">group_add</span> Usuários</a></li>`;
                    }
                    if (permissions.includes('manage_requests')) {
                        menuHTML += `<li><a href="#" class="nav-link" data-page="request-management-page"><span class="material-icons">rule_folder</span> Gerenciar Requisições</a></li>`;
                        menuHTML += `<li><a href="#" class="nav-link" data-page="travel-request-management-page"><span class="material-icons">flight_takeoff</span> Gerenciar Viagens</a></li>`;
                    }
                    if (permissions.includes('manage_routines')) {
                        menuHTML += `<li><a href="#" class="nav-link" data-page="manage-routines-page"><span class="material-icons">rule</span> Gerenciar Rotinas</a></li>`;
                    }

                    adminMenuUl.innerHTML = menuHTML;
                    
                    document.querySelectorAll('#admin-section .nav-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            showPage(e.currentTarget.dataset.page);
                        });
                    });

                    document.getElementById('admin-section').style.display = 'block';

                } else {
                    document.getElementById('admin-section').style.display = 'none';
                }
            }
        }
        
        function showPage(pageId, targetUserId = null) { 
            const appContainer = document.getElementById('app-container'); if (!appContainer) return;
            appContainer.querySelectorAll('.page-content').forEach(page => page.classList.remove('active')); 
            const targetPage = appContainer.querySelector(`#${pageId}`); 
            if (targetPage) targetPage.classList.add('active'); 
            appContainer.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active')); 

            const profileShortcut = document.getElementById('profile-shortcut');
            profileShortcut.classList.remove('active');

            if (pageId === 'profile-page' && (!targetUserId || targetUserId === currentUserProfile.id)) {
                 profileShortcut.classList.add('active');
                 appContainer.querySelector('.nav-link.active')?.classList.remove('active');
            } else {
                const activeLink = appContainer.querySelector(`.nav-link[data-page="${pageId}"]`); 
                if (activeLink) activeLink.classList.add('active');
            }
            
            const fabMessage = document.getElementById('fab-new-message');
            const fabPost = document.getElementById('fab-new-post');
            
            fabMessage.classList.add('hidden');
            fabPost.classList.add('hidden');
            
            if (pageId === 'mural-page' && currentUserProfile && (currentUserProfile.role === 'Admin' || currentUserProfile.role === 'RH')) {
                fabPost.classList.remove('hidden');
            } else if (!['conversation-view-page', 'mural-page', 'requests-page', 'organograma-page'].includes(pageId)) {
                fabMessage.classList.remove('hidden');
            }

            if (pageId === 'messages-page') loadMessages();
            if (pageId === 'requests-page') loadRequests();
            if (pageId === 'team-page') {
                document.getElementById('team-search-name').value = '';
                document.getElementById('team-filter-dept').value = '';
                document.getElementById('team-filter-role').value = '';
                loadTeamPage();
            }
            if (pageId === 'profile-page') loadUserProfileData(targetUserId);
            if (pageId === 'mural-page') loadMuralPage();
            if (pageId === 'rankings-page') loadRankingsPage();
            if (pageId === 'request-management-page') loadRequestManagementPage();
            if (pageId === 'travel-request-management-page') loadTravelRequestManagementPage();
            if (pageId === 'my-routines-page') loadMyRoutinesPage();
            if (pageId === 'manage-routines-page') loadManageRoutinesPage();
            if (pageId === 'organograma-page') loadOrganogramaPage();
        }

        async function loadAllDynamicData() { 
            loadDashboardStats(); 
            loadMessages(); 
            if (currentUserProfile && currentUserProfile.permissions && currentUserProfile.permissions.includes('manage_users')) {
                loadUsersForAdmin();
            }
            fetchAllUsersForSearch(); 
        }
        
        async function loadDashboardStats() {
            if (!currentUserProfile) return;
            const { data, error } = await supabaseClient.rpc('get_dashboard_stats').single();
            if (error) { 
                console.error('Error fetching dashboard stats:', error); 
                document.getElementById('pending-messages-count').textContent = '-';
                document.getElementById('urgent-tickets-count').textContent = '-';
                return;
            }
            document.getElementById('pending-messages-count').textContent = data.pending_messages_count || 0;
            document.getElementById('urgent-tickets-count').textContent = data.urgent_tickets_count || 0;
        }

        async function fetchAllUsersForSearch() { 
            const { data, error } = await supabaseClient.from('profiles').select('id, full_name, score, department, role'); 
            if(error) console.error("Erro ao buscar usuários para pesquisa:", error); 
            else allUsers = data; 
        }

async function loadOrganogramaPage(departmentFilter = '') {
    const container = document.getElementById('organograma-tree-container');
    if (!container) return;
    
    // Reset zoom quando recarregar o organograma
    currentZoom = 1.0;

            container.innerHTML = `<div class="empty-state">Carregando organograma...</div>`;

            const selectElement = document.getElementById('org-filter-dept');
            if (allUsers.length === 0) await fetchAllUsersForSearch();
            
            if (selectElement && selectElement.options.length <= 1) {
                const allDepartments = [...new Set(allUsers.map(u => u.department).filter(Boolean))].sort();
                selectElement.innerHTML = '<option value="">Organograma Geral (Empresa)</option>';
                allDepartments.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d; opt.textContent = d;
                    selectElement.appendChild(opt);
                });
            }
            
            if (selectElement) selectElement.value = departmentFilter;
            
            try {
                const { data: orgData, error } = await supabaseClient.rpc('get_org_chart_data', {
                    p_department_filter: departmentFilter || null 
                });
                
                if (error) throw error;

                if (!orgData || orgData.length === 0) {
                    container.innerHTML = `<div class="empty-state">Nenhum dado encontrado para o organograma.</div>`;
                    return;
                }

                

                let treeHTML = `<div class="org-tree-wrapper" style="position: relative;">
                    <div class="zoom-controls" style="position: absolute; top: 10px; left: 10px; z-index: 100; display: flex; gap: 0.5rem;">
                        <button onclick="zoomOrganograma(-0.1)" class="btn-icon-secondary" title="Diminuir Zoom">
                            <span class="material-icons">zoom_out</span>
                        </button>
                        <span id="zoom-level" style="padding: 0.5rem 1rem; background: var(--color-surface); border-radius: 6px; font-size: 0.9rem; font-weight: 600; min-width: 60px; text-align: center; border: 1px solid var(--color-border); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">100%</span>
                        <button onclick="zoomOrganograma(0.1)" class="btn-icon-secondary" title="Aumentar Zoom">
                            <span class="material-icons">zoom_in</span>
                        </button>
                        <button onclick="resetZoomOrganograma()" class="btn-icon-secondary" title="Resetar Zoom">
                            <span class="material-icons">restart_alt</span>
                        </button>
                    </div>
                    <button class="btn btn-icon" onclick="toggleFullscreenOrg()" title="Expandir Tela Cheia" style="position: absolute; top: 10px; right: 10px; z-index: 100; background: var(--color-surface); border: 1px solid var(--color-border); box-shadow: 0 2px 4px rgba(0,0,0,0.1);"><span class="material-icons">fullscreen</span></button>
                    <div class="org-tree"><ul>`;
                orgData.forEach(rootNode => {
                    treeHTML += renderOrgNode(rootNode);
                });
                treeHTML += `</ul></div></div>`;

                container.innerHTML = treeHTML;
                
                setTimeout(() => {
                    initOrganogramaZoomScroll();
                    initOrganogramaPan();
                }, 100);

            } catch (e) {
                console.error('Erro ao carregar organograma:', e);
                container.innerHTML = `<div class="empty-state" style="color: var(--color-danger);">Falha ao carregar o organograma.</div>`;
            }
        }

        function renderOrgNode(node) {
            if (!node) return '';
            
            const name = node.name;
            const role = node.title || 'Colaborador';
            const dept = node.department;

            let childrenHTML = '';
            if (node.children && node.children.length > 0) {
                childrenHTML += `<ul>`;
                node.children.forEach(child => childrenHTML += renderOrgNode(child));
                childrenHTML += `</ul>`;
            }

            return `
                <li>
                    <div class="org-node" onclick="openOrgMenu(event, '${node.id}', '${node.name.replace(/'/g, "\\'")}')">
                        <h4>${name}</h4>
                        <p>${role}</p>
                    </div>
                    ${childrenHTML}
                </li>
            `;
        }

        function openOrgMenu(event, userId, userName) {
            event.stopPropagation();
            if (currentMenu) {
                currentMenu.remove();
            }
            const menu = document.createElement('div');
            menu.className = 'org-context-menu';
            menu.innerHTML = `
                <ul>
                    <li onclick="handleOrgMenuAction('view', '${userId}')"><span class="material-icons">visibility</span> Ver Perfil</li>
                    <li onclick="handleOrgMenuAction('edit', '${userId}')"><span class="material-icons">edit</span> Editar Colaborador</li>
                </ul>
            `;
            document.body.appendChild(menu);
            currentMenu = menu;
            const { clientX: mouseX, clientY: mouseY } = event;
            const { innerWidth, innerHeight } = window;
            const menuRect = menu.getBoundingClientRect();
            let top = mouseY;
            let left = mouseX;
            if (mouseX + menuRect.width > innerWidth) { left = mouseX - menuRect.width; }
            if (mouseY + menuRect.height > innerHeight) { top = mouseY - menuRect.height; }
            menu.style.top = `${top}px`;
            menu.style.left = `${left}px`;
            document.addEventListener('click', closeOrgMenuListener, { once: true });
        }

        function closeOrgMenuListener(event) {
            if (currentMenu && !currentMenu.contains(event.target)) {
                currentMenu.remove();
                currentMenu = null;
            }
        }

        function handleOrgMenuAction(action, userId) {
            if (currentMenu) {
                currentMenu.remove();
                currentMenu = null;
            }
            if (action === 'view') {
                showPage('profile-page', userId);
            } else if (action === 'edit') {
                openUserModalForEdit(userId);
            }
        }

        async function openUserModalForEdit(userId) {
            const { data: fullUserData, error } = await supabaseClient.from('users_with_email').select('*').eq('id', userId).single();
            if (fullUserData) {
                openUserModal(fullUserData);
            } else {
                console.error("Could not fetch full user data for editing:", error);
                showToast("Não foi possível carregar os dados do usuário para edição.", "danger");
            }
        }
        
function toggleFullscreenOrg() {
    const body = document.body;
    const isFullscreen = body.classList.toggle('fullscreen');
    const expandButton = document.querySelector('.org-tree-wrapper > button.btn.btn-icon');
    const icon = expandButton?.querySelector('.material-icons');
    
    if (!expandButton || !icon) return;
    
    if (isFullscreen) {
        icon.textContent = 'fullscreen_exit';
        expandButton.title = 'Sair da Tela Cheia';
    } else {
        icon.textContent = 'fullscreen';
        expandButton.title = 'Expandir Tela Cheia';
        
        // Resetar zoom ao sair do fullscreen
        currentZoom = 1.0;
        const orgTree = document.querySelector('.org-tree');
        if (orgTree) {
            orgTree.style.transform = 'scale(1)';
        }
        const zoomLabel = document.getElementById('zoom-level');
        if (zoomLabel) {
            zoomLabel.textContent = '100%';
        }
    }
}

let currentZoom = 1.0;

function zoomOrganograma(delta) {
    const orgTree = document.querySelector('.org-tree');
    if (!orgTree) {
        console.error('Árvore do organograma não encontrada');
        return;
    }
    
    currentZoom += delta;
    currentZoom = Math.max(0.3, Math.min(currentZoom, 2.0));
    
    orgTree.style.transform = `scale(${currentZoom})`;
    orgTree.style.transformOrigin = 'top center';
    
    const zoomLabel = document.getElementById('zoom-level');
    if (zoomLabel) {
        zoomLabel.textContent = Math.round(currentZoom * 100) + '%';
    }
}

function resetZoomOrganograma() {
    const orgTree = document.querySelector('.org-tree');
    if (!orgTree) {
        console.error('Árvore do organograma não encontrada');
        return;
    }
    
    currentZoom = 1.0;
    orgTree.style.transform = 'scale(1)';
    
    const zoomLabel = document.getElementById('zoom-level');
    if (zoomLabel) {
        zoomLabel.textContent = '100%';
    }
}





// Ativar zoom com scroll do mouse
function initOrganogramaZoomScroll() {
    const wrapper = document.querySelector('.org-tree-wrapper');
    if (!wrapper) return;
    
    wrapper.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        zoomOrganograma(delta);
    }, { passive: false });
}

// Ativar arrastar para mover (pan)
function initOrganogramaPan() {
    const wrapper = document.querySelector('.org-tree-wrapper');
    if (!wrapper) return;
    
    wrapper.addEventListener('mousedown', (e) => {
        if (e.target.closest('.btn-icon-secondary') || 
            e.target.closest('.btn') || 
            e.target.closest('.org-node')) {
            return;
        }
        isPanning = true;
        wrapper.style.cursor = 'grabbing';
        startPanX = e.clientX;
        startPanY = e.clientY;
        scrollLeftStart = wrapper.scrollLeft;
        scrollTopStart = wrapper.scrollTop;
        e.preventDefault();
    });
    
    wrapper.addEventListener('mouseleave', () => {
        isPanning = false;
        wrapper.style.cursor = 'grab';
    });
    
    wrapper.addEventListener('mouseup', () => {
        isPanning = false;
        wrapper.style.cursor = 'grab';
    });
    
    wrapper.addEventListener('mousemove', (e) => {
        if (!isPanning) return;
        e.preventDefault();
        const deltaX = e.clientX - startPanX;
        const deltaY = e.clientY - startPanY;
        wrapper.scrollLeft = scrollLeftStart - deltaX;
        wrapper.scrollTop = scrollTopStart - deltaY;
    });
}

        // --- REQUESTS MODULE LOGIC ---

        async function loadRequests() {
            const tableBody = document.getElementById('request-table-body');
            tableBody.innerHTML = `<tr><td colspan="5" class="empty-state">Carregando requisições...</td></tr>`;

            const { data, error } = await supabaseClient.rpc('get_my_requests');
            
            if (error) {
                console.error("Erro ao buscar requisições:", error);
                tableBody.innerHTML = `<tr><td colspan="5" class="empty-state" style="color: var(--color-danger)">Falha ao carregar requisições.</td></tr>`;
                return;
            }

            if (!data || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="empty-state">Nenhuma requisição encontrada.</td></tr>`;
                return;
            }
            
            const requestTypeLabels = {
                'new_hire': 'Contratação', 'termination': 'Desligamento', 'promotion': 'Promoção Interna',
                'overtime': 'Horas Extras', 'training': 'Treinamento', 'travel': 'Viagem'
            };
            
            const travelStatusLabels = {
                'pending_review': 'Aguardando Análise', 'approved_by_director': 'Aprovado (Diretor)',
                'rejected_by_director': 'Recusado (Diretor)', 'pending_final_approval': 'Aprovação Final Pendente',
                'approved_definitively': 'Aprovada', 'rejected_definitively': 'Recusada',
                'cancelled_by_requester': 'Cancelada pelo Solicitante'
            };

            tableBody.innerHTML = data.map(req => {
                let statusLabel, statusClass;

                if (req.type === 'travel') {
                    statusLabel = travelStatusLabels[req.status] || req.status.replace(/_/g, ' ');
                    
                    if (req.status === 'pending_review' || req.status === 'pending_final_approval') {
                        statusClass = 'status-pending';
                    } else if (req.status === 'cancelled_by_requester') {
                        statusClass = 'status-rejected';
                    } else {
                        statusClass = req.status.includes('approved') ? 'status-approved' : 'status-rejected';
                    }
                } else {
                    statusLabel = req.status === 'pending' ? 'Pendente' : (req.status === 'approved' ? 'Aprovada' : 'Recusada');
                    statusClass = `status-${req.status}`;
                }
                
                const typeLabel = requestTypeLabels[req.type] || req.type;
                const date = new Date(req.created_at).toLocaleDateString('pt-BR');

// Lógica para Botões de Ação movida para dentro do template HTML

return `
            <tr>
                <td style="width: 18%;"><strong>${typeLabel}</strong></td>
                <td style="width: 25%;">${currentUserProfile.full_name}</td>
                <td style="width: 14%;">${date}</td>
                <td style="width: 20%;"><span class="status-tag ${statusClass}">${statusLabel}</span></td>
                <td style="width: 23%;">
                    <div style="display: flex; gap: 0.4rem; justify-content: flex-start;">
                        <button class="btn btn-secondary" style="padding: 0.35rem 0.7rem; font-size: 0.9rem; white-space: nowrap;" onclick="openRequestDetailsModal('${req.id}')">Ver Detalhes</button>
                        ${req.type === 'travel' && req.status === 'approved_by_director' ? `
                            <button class="btn btn-warning" style="padding: 0.35rem 0.7rem; font-size: 0.9rem; white-space: nowrap;" onclick="promptCancellation('${req.id}')">Cancelar</button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

        // NOVAS FUNÇÕES DE CANCELAMENTO
        function promptCancellation(requestId) {
            if (!requestId || typeof requestId !== 'string' || requestId.trim() === '') {
                showToast("Erro: ID da requisição inválido. Tente recarregar a página.", "danger");
                return;
            }
            const modal = document.getElementById('cancellation-modal');
            const confirmBtn = document.getElementById('btn-confirm-cancellation');
            const reasonInput = document.getElementById('cancellation-reason');
            reasonInput.value = '';
            confirmBtn.setAttribute('data-request-id', requestId.trim());
            modal.classList.add('visible');
            reasonInput.focus();
        }

        async function submitCancellation(requestId, reason) {
            if (!requestId || typeof requestId !== 'string' || requestId.trim() === '') {
                showToast("Erro de segurança: request_id inválido. Operação abortada.", "danger");
                console.error("submitCancellation bloqueado: requestId inválido →", requestId);
                return;
            }

            // Atualização otimista: muda a linha visualmente antes da resposta do servidor
            const tableBody = document.getElementById('request-table-body');
            if (tableBody) {
                tableBody.querySelectorAll('tr').forEach(row => {
                    const btn = row.querySelector(`button[onclick*="${requestId}"]`);
                    if (btn) {
                        const statusCell = row.querySelector('.status-tag');
                        if (statusCell) {
                            statusCell.className = 'status-tag status-rejected';
                            statusCell.textContent = 'Cancelada pelo Solicitante';
                        }
                        btn.remove();
                    }
                });
            }

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error("Sessão inválida.");

                const response = await fetch(N8N_CANCEL_TRAVEL_REQUEST_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({ 
                        request_id: requestId, 
                        reason: reason 
                    })
                });

                if (!response.ok) throw new Error('Falha ao processar o cancelamento.');

                showToast("Requisição de viagem cancelada com sucesso!", "success");
                setTimeout(() => loadRequests(), 1500);

            } catch (error) {
                console.error("Erro ao cancelar viagem:", error);
                showToast(error.message, "danger");
                loadRequests(); // Reverte para o estado real em caso de erro
            }
        }

        async function openRequestDetailsModal(requestId) {
            const modal = document.getElementById('request-modal');
            const modalTitle = document.getElementById('request-modal-title');
            const modalBody = document.getElementById('request-modal-body');
            const modalFooter = document.getElementById('request-modal-footer');

            modalTitle.textContent = 'Carregando Detalhes...';
            modalBody.innerHTML = '<div class="empty-state">Buscando informações...</div>';
            modal.classList.add('visible');

            try {
                const { data: request, error } = await supabaseClient
                    .from('requests')
                    .select('*, requester:profiles(full_name)')
                    .eq('id', requestId)
                    .single();

                if (error || !request) {
                    throw new Error('Não foi possível carregar os detalhes da requisição.');
                }
                
                if (request.type === 'travel') {
                    await openTravelRequestDetailsModal(requestId);
                    return; 
                }
                
                modalTitle.textContent = 'Detalhes da Requisição';

                const translations = {
                    funcao: 'Função', quantidade: 'Quantidade de Vagas', motivo_contratacao: 'Motivo da Contratação',
                    substituicao_nome: 'Nome do Colaborador Substituído', substituicao_motivo: 'Motivo da Saída',
                    tipo_contrato: 'Tipo de Contrato', horario: 'Horário de Trabalho', escolaridade: 'Escolaridade Mínima',
                    experiencia: 'Experiência Necessária', conhecimentos: 'Conhecimentos Específicos',
                    competencias: 'Competências Comportamentais', local_trabalho: 'Local de Trabalho',
                    candidato_interno: 'Possui Candidato Interno?', candidato_interno_nome: 'Nome do Candidato Interno',
                    urgencia: 'Urgência', urgencia_data: 'Data Limite (Urgência)', nome_colaborador: 'Nome do Colaborador',
                    cargo_colaborador: 'Cargo', data_demissao: 'Data da Demissão', tipo_rescisao: 'Tipo de Rescisão',
                    aviso_previo: 'Aviso Prévio', reposicao_vaga: 'Reposição da Vaga',
                    motivo_desligamento: 'Motivos do Desligamento', motivo_breve: 'Relato do Motivo',
                    observacoes_adicionais: 'Observações Adicionais', nome_funcionario: 'Nome do Funcionário',
                    data_admissao: 'Data de Admissão', cargo_atual: 'Cargo Atual', salario_atual: 'Salário Atual (R$)',
                    cargo_pretendido: 'Cargo Pretendido', salario_pretendido: 'Salário Pretendido (R$)',
                    justificativa: 'Justificativa', data_he: 'Data das Horas Extras',
                    horario_adicional: 'Horário Adicional', qtd_funcionarios: 'Qtd. de Funcionários',
                    setor_he: 'Setor', titulo: 'Título do Treinamento/Evento', instituicao: 'Instituição',
                    modalidade: 'Modalidade', local: 'Local', datas: 'Datas', carga_horaria: 'Carga Horária',
                    participacao_tipo: 'Tipo de Participação', nomes_participantes: 'Participantes',
                    custo_inscricao: 'Custo Inscrição (R$)', custo_transporte: 'Custo Transporte (R$)',
                    custo_hospedagem: 'Custo Hospedagem (R$)', custo_outras: 'Outras Despesas (R$)'
                };

                let detailsHTML = `<div class="card" style="margin:0; box-shadow:none; border:none; padding:0;">`;
                for (const key in request.data) {
                    if (Object.hasOwnProperty.call(request.data, key) && request.data[key]) {
                        const label = translations[key] || key.replace(/_/g, ' ');
                        const value = request.data[key];
                        detailsHTML += `
                            <div class="form-group" style="border-bottom: 1px solid var(--color-border); padding-bottom: 0.75rem; margin-bottom: 0.75rem;">
                                <label style="font-size:0.8rem; color: var(--color-text-secondary);">${label}</label>
                                <p style="margin:0; font-weight: 500;">${value}</p>
                            </div>
                        `;
                    }
                }
                detailsHTML += `</div>`;

                modalBody.innerHTML = detailsHTML;
                modalFooter.innerHTML = `<button class="btn btn-secondary" onclick="closeRequestModal()">Fechar</button>`;

            } catch (error) {
                console.error(error);
                modalBody.innerHTML = `<div class="empty-state" style="color:var(--color-danger);">${error.message}</div>`;
                modalFooter.innerHTML = `<button class="btn btn-secondary" onclick="closeRequestModal()">Fechar</button>`;
            }
        }

        function openRequestModal() {
            const modal = document.getElementById('request-modal');
            const modalBody = document.getElementById('request-modal-body');
            const modalFooter = document.getElementById('request-modal-footer');
            
            document.getElementById('request-modal-title').textContent = 'Nova Requisição';

            modalBody.innerHTML = `
                <h3>Selecione o tipo de solicitação</h3>
                <div class="request-type-selection">
                    <div class="type-card" data-type="new_hire">
                        <span class="material-icons">person_add</span>
                        <h3>Contratação de Pessoal</h3>
                    </div>
                    <div class="type-card" data-type="termination">
                        <span class="material-icons">person_remove</span>
                        <h3>Solicitar Desligamento</h3>
                    </div>
                    <div class="type-card" data-type="promotion">
                        <span class="material-icons">trending_up</span>
                        <h3>Promoção Interna</h3>
                    </div>
                    <div class="type-card" data-type="overtime">
                        <span class="material-icons">schedule</span>
                        <h3>Solicitar Horas Extras</h3>
                    </div>
                     <div class="type-card" data-type="training">
                        <span class="material-icons">school</span>
                        <h3>Solicitar Treinamento</h3>
                    </div>
                    <div class="type-card" data-type="travel">
                        <span class="material-icons">flight_takeoff</span>
                        <h3>Requisição de Viagem</h3>
                    </div>
                </div>
            `;

            modalFooter.innerHTML = `<button class="btn btn-secondary" onclick="closeRequestModal()">Cancelar</button>`;

            modal.querySelectorAll('.type-card').forEach(card => {
                card.addEventListener('click', () => renderRequestForm(card.dataset.type));
            });
            
            modal.classList.add('visible');
        }

        function closeRequestModal() {
            document.getElementById('request-modal').classList.remove('visible');
            currentRequestType = null;
            currentEditingRequest = null; // Limpa a variável global ao fechar
        }

        function renderRequestForm(type) {
            currentRequestType = type;
            const modalBody = document.getElementById('request-modal-body');
            const modalFooter = document.getElementById('request-modal-footer');
            const modalTitle = document.getElementById('request-modal-title');

            let formHTML = '';
            let title = 'Nova Requisição';

            const backButtonHTML = `<button class="btn btn-icon" onclick="openRequestModal()" title="Voltar" style="position: absolute; left: 1.5rem; top: 1rem;"><span class="material-icons">arrow_back</span></button>`;

            switch (type) {
                case 'travel': 
                    title = 'Requisição de Viagem';
                    formHTML = `
                        <h3 class="form-section-title">1. Informações da Viagem</h3>
                        <div class="form-group"><label for="req-travel-title">Título da Viagem*</label><input type="text" id="req-travel-title" name="titulo" class="input-field" required></div>
                        <div class="form-group"><label for="req-travel-destination">Destino / Local*</label><input type="text" id="req-travel-destination" name="local" class="input-field" required></div>
                        <div class="grid grid-cols-2">
                            <div class="form-group"><label for="req-travel-start-date">Data Saída*</label><input type="date" id="req-travel-start-date" name="data_saida" class="input-field" required></div>
                            <div class="form-group"><label for="req-travel-end-date">Data Retorno*</label><input type="date" id="req-travel-end-date" name="data_retorno" class="input-field" required></div>
                        </div>
                        <div class="grid grid-cols-2">
                            <div class="form-group"><label for="req-travel-start-time">Horário Sugestivo de Saída</label><input type="time" id="req-travel-start-time" name="hora_saida" class="input-field"></div>
                            <div class="form-group"><label for="req-travel-end-time">Horário Sugestivo de Retorno</label><input type="time" id="req-travel-end-time" name="hora_retorno" class="input-field"></div>
                        </div>
                        <div class="form-group">
                            <label>Participantes da Viagem*</label>
                            <div id="participants-pills-wrapper" style="display:flex; flex-wrap:wrap; gap:0.5rem; min-height:40px; padding:0.5rem; background:var(--color-background); border:1px solid var(--color-border); border-radius:8px; margin-bottom:0.5rem;"></div>
                            <button type="button" class="btn btn-secondary" onclick="selectedParticipants = []; openUserSelectorModal({ title: 'Selecionar Participantes da Viagem', targetArray: selectedParticipants, onComplete: renderParticipantPills })">
                                <span class="material-icons" style="font-size:18px;">group_add</span> Selecionar Participantes
                            </button>
                        </div>
                        
                        <h3 class="form-section-title">2. Detalhes Adicionais</h3>
                        <div class="form-group">
                            <label>Tipo de Transporte Preferencial</label>
                            <div class="radio-group">
                                <label><input type="radio" name="tipo_transporte" value="carro" checked> Carro</label>
                                <label><input type="radio" name="tipo_transporte" value="aviao"> Avião</label>
                                <label><input type="radio" name="tipo_transporte" value="onibus"> Ônibus</label>
                            </div>
                        </div>
                        <div class="grid grid-cols-2">
                            <div class="form-group"><label for="req-travel-registration-cost">Custo de Inscrição (Evento/Curso)</label><input type="number" id="req-travel-registration-cost" name="custo_inscricao" class="input-field" placeholder="R$ (se aplicável)"></div>
                            <div class="form-group"><label for="req-travel-hotel-suggestion">Sugestão de Hotel (Nome ou Link)</label><input type="text" id="req-travel-hotel-suggestion" name="sugestao_hotel" class="input-field" placeholder="Ex: Hotel Ibis ou link do Booking/Airbnb"></div>
                        </div>

                        <h3 class="form-section-title">3. Justificativa*</h3>
                        <div class="form-group"><textarea name="justificativa" class="input-field" rows="3" required></textarea></div>
                    `;
                    break;
                case 'new_hire':
                    title = 'Requisição de Contratação de Pessoal';
                    formHTML = `
                        <h3 class="form-section-title">Informações da Vaga</h3>
                        <div class="grid grid-cols-2">
                            <div class="form-group"><label for="req-funcao">Função*</label><input type="text" id="req-funcao" name="funcao" class="input-field" required></div>
                            <div class="form-group"><label for="req-quantidade">Quantidade de Vagas*</label><input type="number" id="req-quantidade" name="quantidade" class="input-field" value="1" required></div>
                        </div>
                        <div class="form-group">
                            <label>Motivo da Contratação*</label>
                            <div class="radio-group">
                                <label><input type="radio" name="motivo_contratacao" value="aumento_quadro" checked onchange="toggleSubstituicaoFields()"> Aumento de Quadro</label>
                                <label><input type="radio" name="motivo_contratacao" value="substituicao" onchange="toggleSubstituicaoFields()"> Substituição</label>
                                <label><input type="radio" name="motivo_contratacao" value="outro" onchange="toggleSubstituicaoFields()"> Outro</label>
                            </div>
                        </div>
                        <div id="substituicao-fields" style="display:none;" class="card" >
                             <div class="form-group"><label for="req-subst-nome">Nome do colaborador substituído</label><input type="text" id="req-subst-nome" name="substituicao_nome" class="input-field"></div>
                             <div class="form-group"><label for="req-subst-motivo">Motivo da saída</label><input type="text" id="req-subst-motivo" name="substituicao_motivo" class="input-field"></div>
                        </div>
                        <div class="form-group">
                            <label>Tipo de Contrato*</label>
                            <div class="radio-group">
                                <label><input type="radio" name="tipo_contrato" value="clt" checked> CLT</label>
                                <label><input type="radio" name="tipo_contrato" value="temporario"> Temporário</label>
                                <label><input type="radio" name="tipo_contrato" value="estagio"> Estágio</label>
                                <label><input type="radio" name="tipo_contrato" value="jovem_aprendiz"> Jovem Aprendiz</label>
                            </div>
                        </div>
                        <div class="form-group"><label for="req-horario">Horário de Trabalho</label><input type="text" id="req-horario" name="horario" class="input-field"></div>
                        
                        <h3 class="form-section-title">Requisitos e Perfil Desejado</h3>
                        <div class="form-group"><label for="req-escolaridade">Escolaridade Mínima</label>
                            <select id="req-escolaridade" name="escolaridade" class="input-field">
                                <option value="">-- Selecione --</option>
                                <option value="fundamental_incompleto">Ensino Fundamental Incompleto</option>
                                <option value="fundamental_completo">Ensino Fundamental Completo</option>
                                <option value="medio_incompleto">Ensino Médio Incompleto</option>
                                <option value="medio_completo">Ensino Médio Completo</option>
                                <option value="tecnico">Ensino Técnico</option>
                                <option value="superior_incompleto">Ensino Superior Incompleto</option>
                                <option value="superior_completo">Ensino Superior Completo</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="req-experiencia">Experiência Necessária</label><textarea id="req-experiencia" name="experiencia" class="input-field"></textarea></div>
                        <div class="form-group"><label for="req-conhecimentos">Conhecimentos Específicos (máquinas, ferramentas, processos)</label><textarea id="req-conhecimentos" name="conhecimentos" class="input-field"></textarea></div>
                        <div class="form-group"><label for="req-competencias">Competências Comportamentais Desejadas</label><textarea id="req-competencias" name="competencias" class="input-field"></textarea></div>

                        <h3 class="form-section-title">Informações Adicionais</h3>
                        <div class="form-group"><label for="req-local">Local de Trabalho (planta/unidade)</label><input type="text" id="req-local" name="local_trabalho" class="input-field"></div>
                        <div class="form-group">
                            <label>Possui Candidato Interno em Vista?</label>
                            <div class="radio-group">
                                <label><input type="radio" name="candidato_interno" value="sim" onchange="toggleCandidatoInterno()"> Sim</label>
                                <label><input type="radio" name="candidato_interno" value="nao" checked onchange="toggleCandidatoInterno()"> Não</label>
                            </div>
                        </div>
                        <div id="candidato-interno-nome" style="display:none;" class="form-group">
                            <label for="req-candidato-nome">Nome do candidato interno</label><input type="text" id="req-candidato-nome" name="candidato_interno_nome" class="input-field">
                        </div>
                         <div class="form-group">
                            <label>Urgência da Contratação*</label>
                            <div class="radio-group">
                                <label><input type="radio" name="urgencia" value="urgente"> Urgente</label>
                                <label><input type="radio" name="urgencia" value="ate_data"> Até</label>
                                <label><input type="radio" name="urgencia" value="sem_urgencia" checked> Sem urgência</label>
                            </div>
                            <input type="date" name="urgencia_data" class="input-field" style="max-width: 150px; margin-top: 8px; display: none;">
                        </div>
                    `;
                    break;

                case 'termination':
                    title = 'Solicitação de Rescisão de Contrato';
                    formHTML = `
                        <h3 class="form-section-title">1. Dados do Colaborador</h3>
                        <div class="form-group"><label for="req-nome-colaborador">Nome Completo*</label><input type="text" id="req-nome-colaborador" name="nome_colaborador" class="input-field" required></div>
                        <div class="grid grid-cols-2">
                            <div class="form-group"><label for="req-cargo-colaborador">Cargo</label><input type="text" id="req-cargo-colaborador" name="cargo_colaborador" class="input-field"></div>
                            <div class="form-group"><label for="req-data-demissao">Data Prevista Demissão*</label><input type="date" id="req-data-demissao" name="data_demissao" class="input-field" required></div>
                        </div>

                        <h3 class="form-section-title">2. Informações da Rescisão</h3>
                        <div class="form-group"><label>Tipo de rescisão solicitada*</label>
                            <div class="radio-group" style="flex-direction: column; align-items: flex-start;">
                                <label><input type="radio" name="tipo_rescisao" value="pedido_demissao"> Pedido de demissão (iniciativa do colaborador)</label>
                                <label><input type="radio" name="tipo_rescisao" value="sem_justa_causa"> Demissão sem justa causa (iniciativa da empresa)</label>
                                <label><input type="radio" name="tipo_rescisao" value="com_justa_causa"> Demissão com justa causa</label>
                                <label><input type="radio" name="tipo_rescisao" value="termino_contrato"> Término de contrato por prazo determinado</label>
                                <label><input type="radio" name="tipo_rescisao" value="acordo_partes"> Acordo entre as partes (Art. 484-A da CLT)</label>
                                <label><input type="radio" name="tipo_rescisao" value="outros"> Outros</label>
                            </div>
                        </div>
                        <div class="form-group"><label>Aviso prévio*</label>
                            <div class="radio-group">
                                <label><input type="radio" name="aviso_previo" value="cumprido"> Cumprido</label>
                                <label><input type="radio" name="aviso_previo" value="indenizado"> Indenizado</label>
                                <label><input type="radio" name="aviso_previo" value="dispensado"> Dispensado</label>
                                <label><input type="radio" name="aviso_previo" value="nao_aplicavel"> Não aplicável</label>
                            </div>
                        </div>
                        <div class="form-group"><label>Reposição da Vaga?*</label>
                            <div class="radio-group">
                                <label><input type="radio" name="reposicao_vaga" value="sim"> SIM</label>
                                <label><input type="radio" name="reposicao_vaga" value="nao"> NÃO</label>
                            </div>
                        </div>

                        <h3 class="form-section-title">3. Motivo do Desligamento (para iniciativa da empresa)</h3>
                        <div class="form-group"><label>Marcar um ou mais, se aplicável:</label>
                            <div class="radio-group" style="flex-direction: column; align-items: flex-start;">
                                <label><input type="checkbox" name="motivo_desligamento" value="desempenho_abaixo"> Desempenho abaixo do esperado</label>
                                <label><input type="checkbox" name="motivo_desligamento" value="inadequacao_cultura"> Inadequação à cultura organizacional</label>
                                <label><input type="checkbox" name="motivo_desligamento" value="comportamento_incompativel"> Comportamento incompatível com as diretrizes</label>
                                <label><input type="checkbox" name="motivo_desligamento" value="reestruturacao"> Reestruturação / corte de custos</label>
                                <label><input type="checkbox" name="motivo_desligamento" value="fim_projeto"> Fim de projeto ou contrato</label>
                                <label><input type="checkbox" name="motivo_desligamento" value="faltas"> Faltas injustificadas ou indisciplina</label>
                                <label><input type="checkbox" name="motivo_desligamento" value="outras"> Outras razões</label>
                            </div>
                        </div>
                        <div class="form-group"><label for="req-motivo-breve">Relate brevemente o Motivo</label><textarea id="req-motivo-breve" name="motivo_breve" class="input-field"></textarea></div>
                        
                        <h3 class="form-section-title">4. Observações Adicionais</h3>
                        <div class="form-group"><textarea name="observacoes_adicionais" class="input-field"></textarea></div>
                    `;
                    break;

                case 'promotion':
                    title = 'Requisição de Promoção Interna';
                     formHTML = `
                        <div class="form-group"><label for="req-nome-funcionario">Nome do Funcionário*</label><input type="text" id="req-nome-funcionario" name="nome_funcionario" class="input-field" required></div>
                        <div class="form-group"><label for="req-data-admissao">Data de Admissão</label><input type="date" id="req-data-admissao" name="data_admissao" class="input-field"></div>
                        
                        <h3 class="form-section-title">Detalhes da Solicitação</h3>
                        <div class="grid grid-cols-2">
                            <div class="form-group"><label for="req-cargo-atual">Cargo ATUAL*</label><input type="text" id="req-cargo-atual" name="cargo_atual" class="input-field" required></div>
                            <div class="form-group"><label for="req-salario-atual">Salário ATUAL (R$)*</label><input type="number" id="req-salario-atual" name="salario_atual" class="input-field" placeholder="0.00" required></div>
                        </div>
                        <div class="grid grid-cols-2">
                            <div class="form-group"><label for="req-cargo-pretendido">Cargo PRETENDIDO*</label><input type="text" id="req-cargo-pretendido" name="cargo_pretendido" class="input-field" required></div>
                            <div class="form-group"><label for="req-salario-pretendido">Salário PRETENDIDO (R$)*</label><input type="number" id="req-salario-pretendido" name="salario_pretendido" class="input-field" placeholder="0.00" required></div>
                        </div>
                        <div class="form-group"><label for="req-justificativa-promocao">Justificativa da solicitação*</label><textarea id="req-justificativa-promocao" name="justificativa" class="input-field" required placeholder="Descreva as motivações, resultados obtidos, conquistas e razões..."></textarea></div>
                    `;
                    break;

                case 'overtime':
                    title = 'Requisição de Horas Extras';
                    formHTML = `
                        <h3 class="form-section-title">Informações das Horas Extras</h3>
                        <div class="form-group"><label for="req-data-he">Data a ser realizada*</label><input type="date" id="req-data-he" name="data_he" class="input-field" required></div>
                        <div class="form-group"><label for="req-horario-adicional">Horário Adicional (Ex: Das 08h às 16h - 8 horas)*</label><input type="text" id="req-horario-adicional" name="horario_adicional" class="input-field" required></div>
                        <div class="grid grid-cols-2">
                            <div class="form-group"><label for="req-qtd-funcionarios">Quantidade de Funcionários*</label><input type="number" id="req-qtd-funcionarios" name="qtd_funcionarios" class="input-field" value="1" required></div>
                            <div class="form-group"><label for="req-setor-he">Setor a realizar as Horas Extras*</label><input type="text" id="req-setor-he" name="setor_he" class="input-field" required></div>
                        </div>
                    `;
                    break;

                case 'training':
                    title = 'Requisição de Treinamento / Evento';
                    formHTML = `
                        <h3 class="form-section-title">1. Informações do Treinamento ou Evento</h3>
                        <div class="form-group"><label for="req-titulo-treinamento">Título (Nome do curso, treinamento ou evento)*</label><input type="text" id="req-titulo-treinamento" name="titulo" class="input-field" required></div>
                        <div class="form-group"><label for="req-instituicao">Instituição/Fornecedor</label><input type="text" id="req-instituicao" name="instituicao" class="input-field"></div>
                        <div class="form-group"><label>Modalidade*</label>
                            <div class="radio-group">
                                <label><input type="radio" name="modalidade" value="presencial"> Presencial</label>
                                <label><input type="radio" name="modalidade" value="online"> Online</label>
                                <label><input type="radio" name="modalidade" value="hibrido"> Híbrido</label>
                            </div>
                        </div>
                        <div class="form-group"><label for="req-local-treinamento">Local (Cidade/Plataforma online)</label><input type="text" id="req-local-treinamento" name="local" class="input-field"></div>
                        <div class="grid grid-cols-2">
                            <div class="form-group"><label for="req-datas-treinamento">Data(s) de início e término</label><input type="text" id="req-datas-treinamento" name="datas" class="input-field"></div>
                            <div class="form-group"><label for="req-carga-horaria">Carga horária</label><input type="text" id="req-carga-horaria" name="carga_horaria" class="input-field"></div>
                        </div>

                        <h3 class="form-section-title">2. Objetivo da Participação</h3>
                        <div class="form-group">
                            <div class="radio-group">
                                <label><input type="radio" name="participacao_tipo" value="individual" checked onchange="toggleParticipantes()"> Colaborador individual</label>
                                <label><input type="radio" name="participacao_tipo" value="equipe" onchange="toggleParticipantes()"> Equipe ou grupo</label>
                            </div>
                        </div>
                        <div id="participantes-group" style="display:none;" class="form-group">
                            <label for="req-nomes-participantes">Nome(s) dos participantes (Listar nomes)</label>
                            <textarea id="req-nomes-participantes" name="nomes_participantes" class="input-field"></textarea>
                        </div>

                        <h3 class="form-section-title">3. Custos Estimados</h3>
                        <div class="grid grid-cols-2">
                            <div class="form-group"><label for="req-custo-inscricao">Inscrição (R$)</label><input type="number" id="req-custo-inscricao" name="custo_inscricao" class="input-field" placeholder="0.00"></div>
                            <div class="form-group"><label for="req-custo-transporte">Transporte (R$)</label><input type="number" id="req-custo-transporte" name="custo_transporte" class="input-field" placeholder="0.00"></div>
                            <div class="form-group"><label for="req-custo-hospedagem">Hospedagem/Alimentação (R$)</label><input type="number" id="req-custo-hospedagem" name="custo_hospedagem" class="input-field" placeholder="0.00"></div>
                            <div class="form-group"><label for="req-custo-outras">Outras despesas (R$)</label><input type="number" id="req-custo-outras" name="custo_outras" class="input-field" placeholder="0.00"></div>
                        </div>
                    `;
                    break;
            }

            modalTitle.textContent = title;
            modalBody.innerHTML = backButtonHTML + `<form id="dynamic-request-form">${formHTML}</form>`;
            
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="openRequestModal()">Cancelar</button>
                <button class="btn btn-danger" id="btn-submit-request">Enviar Requisição</button>
            `;

document.getElementById('btn-submit-request').addEventListener('click', submitRequest);
            
            addConditionalFieldListeners();

if (type === 'travel') {
                setTimeout(async () => {
                    const input = document.getElementById('req-travel-destination');
if (input && window.google && google.maps.importLibrary) {
        try {
            const { PlaceAutocompleteElement } = await google.maps.importLibrary("places");
            const autocomplete = new PlaceAutocompleteElement({
                componentRestrictions: { country: 'br' },
            });
            autocomplete.style.width = '100%';
            // Substitui o input original pelo elemento nativo
            input.parentNode.replaceChild(autocomplete, input);
            autocomplete.addEventListener('gmp-placeselect', (e) => {
                const place = e.placePrediction.toPlace();
                // Cria um input hidden para guardar o valor
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'local';
                hidden.value = e.placePrediction.text.toString();
                autocomplete.parentNode.appendChild(hidden);
            });
        } catch (err) {
            console.error("Erro Google Autocomplete:", err);
        }
    }
                }, 300);
            }
		}

async function submitRequest(event) {
            event.preventDefault();
            const btn = event.target;
            const form = document.getElementById('dynamic-request-form');

            // Captura do local via PlaceAutocompleteElement (substituiu o input original)
            let localValue = "";
            if (currentRequestType === 'travel') {
                // Prioridade 1: input hidden criado pelo evento gmp-placeselect (usuário selecionou sugestão)
                const hiddenLocal = form.querySelector('input[type="hidden"][name="local"]');
                if (hiddenLocal && hiddenLocal.value) {
                    localValue = hiddenLocal.value;
                } else {
                    // Prioridade 2: lê direto do elemento gmp-place-autocomplete (texto digitado)
                    const autocompleteEl = form.querySelector('gmp-place-autocomplete');
                    if (autocompleteEl) {
                        localValue = autocompleteEl.value || '';
                    }
                    // Prioridade 3: fallback para o input original (caso o autocomplete não tenha carregado)
                    if (!localValue) {
                        const inputFallback = document.getElementById('req-travel-destination');
                        if (inputFallback) localValue = inputFallback.value || '';
                    }
                }
            }
            if (!form.checkValidity()) {
                showToast("Por favor, preencha todos os campos obrigatórios (*).", 'warning');
                return;
            }

            if (!currentRequestType) {
                showToast("Tipo de requisição inválido.", "danger");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Enviando...';

            try {
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                if (sessionError || !session) throw new Error("Sessão inválida. Faça login novamente.");
                
                const formData = new FormData(form);
                const dataObject = {};
                formData.forEach((value, key) => { dataObject[key] = value; });
                
                let webhookUrl = N8N_CREATE_REQUEST_URL;
                let payload = {
                    type: currentRequestType,
                    data: dataObject
                };

                if (currentRequestType === 'travel') {
                    if (selectedParticipants.length === 0) {
                        showToast('Selecione pelo menos um participante para a viagem.', 'warning');
                        btn.disabled = false;
                        btn.innerHTML = 'Enviar Requisição';
                        return;
                    }
                    webhookUrl = N8N_CREATE_TRAVEL_REQUEST_URL;
                    payload = {
                        ...dataObject,
                        local: localValue,
                        participantes_nomes: selectedParticipants.map(p => p.full_name).join(', '),
                        solicitante_nome: currentUserProfile.full_name,
                        cargo: currentUserProfile.role,
                        setor: currentUserProfile.department
                    };
                    selectedParticipants = [];
                }

                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Falha ao enviar requisição.');
                }

                showToast("Requisição enviada com sucesso!", "success");
                closeRequestModal();
                loadRequests(); 

            } catch (error) {
                console.error("Erro ao enviar requisição:", error);
                showToast(error.message, "danger");
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Enviar Requisição';
            }
        }
        
        function toggleSubstituicaoFields() {
            const isSubstituicao = document.querySelector('input[name="motivo_contratacao"]:checked')?.value === 'substituicao';
            const fields = document.getElementById('substituicao-fields');
            if (fields) fields.style.display = isSubstituicao ? 'block' : 'none';
        }

        function toggleCandidatoInterno() {
            const temCandidato = document.querySelector('input[name="candidato_interno"]:checked')?.value === 'sim';
            const fields = document.getElementById('candidato-interno-nome');
            if (fields) fields.style.display = temCandidato ? 'block' : 'none';
        }

        function toggleParticipantes() {
            const isEquipe = document.querySelector('input[name="participacao_tipo"]:checked')?.value === 'equipe';
            const fields = document.getElementById('participantes-group');
            if (fields) fields.style.display = isEquipe ? 'block' : 'none';
        }

        function addConditionalFieldListeners() {
            const motivoContratacaoRadios = document.querySelectorAll('input[name="motivo_contratacao"]');
            motivoContratacaoRadios.forEach(radio => radio.addEventListener('change', toggleSubstituicaoFields));
            
            const candidatoInternoRadios = document.querySelectorAll('input[name="candidato_interno"]');
            candidatoInternoRadios.forEach(radio => radio.addEventListener('change', toggleCandidatoInterno));

            const urgenciaRadios = document.querySelectorAll('input[name="urgencia"]');
            const urgenciaDataInput = document.querySelector('input[name="urgencia_data"]');
            
            if (urgenciaRadios.length > 0 && urgenciaDataInput) {
                const toggleUrgenciaInput = () => {
                    const isAteData = document.querySelector('input[name="urgencia"]:checked')?.value === 'ate_data';
                    urgenciaDataInput.style.display = isAteData ? 'block' : 'none';
                    urgenciaDataInput.required = isAteData;
                };
                urgenciaRadios.forEach(radio => radio.addEventListener('change', toggleUrgenciaInput));
                toggleUrgenciaInput();
            }
        }
                        
        function openNewPostModal() {
            document.getElementById('new-post-modal').classList.add('visible');
            selectMediaType('text');
            document.getElementById('post-title').value = '';
            document.getElementById('post-content').value = '';
            document.getElementById('post-media-file').value = '';
            document.getElementById('preview-area').innerHTML = '';
            document.getElementById('preview-area').style.display = 'none';
        }

        function closeNewPostModal() {
            document.getElementById('new-post-modal').classList.remove('visible');
        }

        function selectMediaType(type) {
            document.querySelectorAll('.media-option').forEach(el => el.classList.remove('selected'));
            document.getElementById(`opt-${type}`).classList.add('selected');
            document.getElementById('post-media-type').value = type;

            const mediaGroup = document.getElementById('media-input-group');
            const fileInput = document.getElementById('post-media-file');
            const label = document.getElementById('media-input-label');
            const preview = document.getElementById('preview-area');

            preview.innerHTML = '';
            preview.style.display = 'none';
            fileInput.value = '';

            if (type === 'text') {
                mediaGroup.style.display = 'none';
            } else {
                mediaGroup.style.display = 'block';
                if (type === 'image') {
                    label.textContent = "Selecione a Imagem";
                    fileInput.accept = "image/*";
                    fileInput.removeAttribute('multiple');
                } else if (type === 'carousel') {
                    label.textContent = "Selecione as Imagens (Múltiplas)";
                    fileInput.accept = "image/*";
                    fileInput.setAttribute('multiple', 'multiple');
                } else if (type === 'video') {
                    label.textContent = "Selecione o Vídeo";
                    fileInput.accept = "video/*";
                    fileInput.removeAttribute('multiple');
                }
            }
        }

        function handlePostMediaPreview(event) {
            const files = event.target.files;
            const preview = document.getElementById('preview-area');
            const type = document.getElementById('post-media-type').value;

            if (files.length > 0) {
                preview.style.display = 'block';
                if (type === 'video') {
                     preview.innerHTML = `<p><span class="material-icons">movie</span> ${files[0].name} selecionado para upload.</p>`;
                } else {
                    let html = `<p>${files.length} arquivo(s) selecionado(s)</p><div style="display:flex; gap:5px; overflow-x:auto; margin-top:5px;">`;
                    const limit = Math.min(files.length, 5); 
                    for(let i=0; i<limit; i++) {
                        const src = URL.createObjectURL(files[i]);
                        html += `<img src="${src}" style="height:60px; width:auto;">`;
                    }
                    if(files.length > 5) html += `<span>...</span>`;
                    html += `</div>`;
                    preview.innerHTML = html;
                }
            } else {
                preview.style.display = 'none';
            }
        }

        async function submitPost() {
            const btn = document.getElementById('btn-publish-post');
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            const mediaType = document.getElementById('post-media-type').value;
            const fileInput = document.getElementById('post-media-file');

            if (!title) { showToast('O título é obrigatório.', 'warning'); return; }
            if (mediaType !== 'text' && fileInput.files.length === 0) { showToast('Selecione o arquivo de mídia.', 'warning'); return; }

            btn.disabled = true;
            btn.innerHTML = 'Publicando...';

            try {
                const formData = new FormData();
                formData.append('title', title);
                formData.append('content', content);
                formData.append('author_id', currentUserProfile.id);
                formData.append('media_type', mediaType);

                if (mediaType !== 'text') {
                    for (let i = 0; i < fileInput.files.length; i++) {
                        formData.append('file', fileInput.files[i]);
                    }
                }

                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error("Sessão expirou.");

                const response = await fetch(N8N_CREATE_POST_URL, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${session.access_token}` },
                    body: formData
                });

                if (!response.ok) throw new Error('Erro ao comunicar com n8n.');

                showToast('Publicação enviada com sucesso!', 'success');
                closeNewPostModal();
                loadMuralPage(); 

            } catch (error) {
                console.error(error);
                showToast('Erro ao publicar: ' + error.message, 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Publicar';
            }
        }

        async function loadMuralPage() {
            const container = document.getElementById('mural-content');
            container.innerHTML = `<div class="empty-state">Carregando mural...</div>`;
            
            const { data: posts, error: postsError } = await supabaseClient
                .from('posts')
                .select('*, author:profiles(full_name, avatar_url)')
                .order('created_at', { ascending: false });

            if (postsError) {
                console.error("Erro no mural:", postsError);
                container.innerHTML = `<div class="empty-state" style="color: var(--color-danger)">Erro ao carregar o mural.</div>`;
                return;
            }

            if (!posts || posts.length === 0) {
                container.innerHTML = `<div class="empty-state">Nenhuma publicação no mural ainda.</div>`;
                return;
            }

            const postsHTML = await Promise.all(posts.map(async (post) => {
                const [likesRes, commentsRes, myLikeRes] = await Promise.all([
                    supabaseClient.from('post_likes').select('id', { count: 'exact', head: true }).eq('post_id', post.id),
                    supabaseClient.from('post_comments').select('id', { count: 'exact', head: true }).eq('post_id', post.id),
                    supabaseClient.from('post_likes').select('id').eq('post_id', post.id).eq('user_id', currentUserProfile.id)
                ]);

                const likesCount = likesRes.count || 0;
                const commentsCount = commentsRes.count || 0;
                const isLiked = myLikeRes.data && myLikeRes.data.length > 0;
                const avatarInitial = post.author.full_name ? post.author.full_name.charAt(0).toUpperCase() : '?';
                
                let mediaHTML = '';
                if (post.media_data && post.media_data.type !== 'text') {
                    const md = post.media_data;
                    if (md.type === 'image' && md.id) {
                        const src = `https://lh3.googleusercontent.com/d/${md.id}`;
                        mediaHTML = `<div class="media-container"><img src="${src}" loading="lazy" onclick="openLightbox(event, '${src}')"></div>`;
                    } else if (md.type === 'video') {
                         if(md.source === 'youtube' && md.id) {
                             mediaHTML = `<div class="media-container"><iframe src="https://www.youtube.com/embed/${md.id}" allowfullscreen></iframe></div>`;
                        } else if (md.embed_url) {
                             mediaHTML = `<div class="media-container"><iframe src="${md.embed_url}" allowfullscreen></iframe></div>`;
                        }
                    } 
                }

                const likeBtnClass = isLiked ? 'btn-icon liked' : 'btn-icon';

                return `
                    <div class="card mural-post-card">
                        <div class="post-header">
                            <div class="user-avatar">${avatarInitial}</div>
                            <div class="post-meta">
                                <h3>${post.author.full_name}</h3>
                                <p>${new Date(post.created_at).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', hour: '2-digit', minute:'2-digit' })}</p>
                            </div>
                        </div>
                        <h2 class="post-title">${post.title}</h2>
                        <div class="post-content-text">${post.content || ''}</div>
                        ${mediaHTML}
                        
                        <div class="post-stats">
                            <div class="post-stats-likes">
                                ${likesCount > 0 ? '<span class="material-icons">thumb_up</span>' : ''}
                                <span id="likes-count-${post.id}">${likesCount > 0 ? (likesCount + (likesCount > 1 ? ' curtidas' : ' curtida')) : ''}</span>
                            </div>
                            <span id="comments-count-display-${post.id}">${commentsCount} comentários</span>
                        </div>
                        
                        <div class="post-actions">
                            <button class="${likeBtnClass}" onclick="likePost('${post.id}')" id="like-btn-${post.id}">
                                <span class="material-icons">thumb_up</span> Curtir
                            </button>
                            <button class="btn btn-icon" onclick="toggleComments('${post.id}')">
                                <span class="material-icons">comment</span> Comentar
                            </button>
                        </div>
                        
                        <div class="comments-section" id="comments-${post.id}">
                            <div id="comments-list-${post.id}"></div>
                            <div class="comment-input-wrapper">
                                <div class="user-avatar" style="width:32px; height:32px; font-size:0.8rem;">${currentUserProfile.full_name.charAt(0)}</div>
                                <input type="text" class="input-field" id="comment-input-${post.id}" placeholder="Escreva um comentário...">
                                <button class="btn btn-icon" onclick="submitComment('${post.id}')"><span class="material-icons">send</span></button>
                            </div>
                        </div>
                    </div>
                `;
            }));

            container.innerHTML = postsHTML.join('');
        }

        async function likePost(postId) {
            const btn = document.getElementById(`like-btn-${postId}`);
            const countSpan = document.getElementById(`likes-count-${postId}`);
            const statsContainer = document.querySelector(`#likes-count-${postId}`).parentElement;
            
            const isLiked = btn.classList.contains('liked');

            btn.classList.toggle('liked');

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error("Sessão inválida");

                fetch(N8N_LIKE_POST_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                    body: JSON.stringify({ post_id: postId })
                }).catch(e => {
                    console.error("Erro na chamada de rede para curtir:", e);
                    btn.classList.toggle('liked');
                });

            } catch (e) {
                console.error("Falha ao curtir:", e);
                showToast("Erro ao processar curtida", "danger");
                btn.classList.toggle('liked');
            }
        }

        async function toggleComments(postId) {
            const section = document.getElementById(`comments-${postId}`);
            const isVisible = section.classList.contains('visible');
            
            if (isVisible) {
                section.classList.remove('visible');
            } else {
                section.classList.add('visible');
                loadComments(postId);
            }
        }

        async function loadComments(postId) {
            const list = document.getElementById(`comments-list-${postId}`);
            list.innerHTML = '<p style="font-size: 0.9rem; color: var(--color-text-secondary)">Carregando...</p>';

            const { data: comments, error } = await supabaseClient
                .from('post_comments')
                .select('*, author:profiles(full_name)')
                .eq('post_id', postId)
                .order('created_at', { ascending: true });

            if (error) {
                list.innerHTML = '<p class="text-error">Erro ao carregar comentários.</p>';
                return;
            }

            if (comments.length === 0) {
                list.innerHTML = ''; 
                return;
            }

            list.innerHTML = comments.map(c => `
                <div class="comment-item">
                    <div class="comment-avatar">${c.author.full_name.charAt(0)}</div>
                    <div class="comment-box">
                        <span class="comment-author">${c.author.full_name}</span>
                        <p class="comment-text">${c.content}</p>
                    </div>
                </div>
            `).join('');
        }

        async function submitComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value.trim();
            if (!content) return;

            const list = document.getElementById(`comments-list-${postId}`);
            const tempId = `temp-${Date.now()}`;
            const tempHTML = `
                <div class="comment-item" id="${tempId}" style="opacity: 0.6;">
                    <div class="comment-avatar">${currentUserProfile.full_name.charAt(0)}</div>
                    <div class="comment-box"><span class="comment-author">${currentUserProfile.full_name}</span><p class="comment-text">${content}</p></div>
                </div>`;
            list.insertAdjacentHTML('beforeend', tempHTML);
            input.value = '';

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                const res = await fetch(N8N_COMMENT_POST_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                    body: JSON.stringify({ post_id: postId, content: content })
                });
                
                if(!res.ok) throw new Error("Falha ao enviar comentário.");

                document.getElementById(tempId)?.remove();
                loadComments(postId);

            } catch (e) {
                showToast("Erro ao enviar comentário", "danger");
                document.getElementById(tempId)?.remove(); 
            }
        }
        
        function openLightbox(event, src) {
            event.stopPropagation();
            const overlay = document.getElementById('lightbox-overlay');
            const img = document.getElementById('lightbox-image');
            img.src = src;
            overlay.classList.add('visible');
        }

        function closeLightbox() {
            document.getElementById('lightbox-overlay').classList.remove('visible');
        }
        
        async function loadTeamPage() {
            const container = document.getElementById('team-list-content');
            container.innerHTML = `<div class="empty-state">Carregando equipe...</div>`;
            
            const { data: users, error } = await supabaseClient.from('profiles').select('*').order('full_name');
            if (error) {
                container.innerHTML = `<div class="empty-state">Falha ao carregar a equipe.</div>`;
                console.error("Erro ao carregar equipe:", error);
                return;
            }

            populateTeamFilters(users);

            const nameFilter = document.getElementById('team-search-name').value.toLowerCase();
            const deptFilter = document.getElementById('team-filter-dept').value;
            const roleFilter = document.getElementById('team-filter-role').value;

            const filteredUsers = users.filter(user => {
                const isCurrentUser = user.id === currentUserProfile.id;
                const nameMatch = user.full_name && user.full_name.toLowerCase().includes(nameFilter);
                const deptMatch = !deptFilter || user.department === deptFilter;
                const roleMatch = !roleFilter || user.role === roleFilter;
                return !isCurrentUser && nameMatch && deptMatch && roleMatch;
            });

            const myDept = currentUserProfile.department;
            const myTeam = filteredUsers.filter(u => u.department === myDept);
            const others = filteredUsers.filter(u => u.department !== myDept);

            const generateCardHTML = (user) => {
                let avatarHTML = '';
                if (user.avatar_url) {
                    const src = user.avatar_url.includes('http') ? user.avatar_url : `https://lh3.googleusercontent.com/d/${user.avatar_url}`;
                    avatarHTML = `<img src="${src}" class="team-avatar-img" alt="${user.full_name}">`;
                } else {
                    const initial = user.full_name ? user.full_name.charAt(0).toUpperCase() : '?';
                    avatarHTML = `<div class="user-avatar">${initial}</div>`;
                }

                const score = user.score || 100;
                let scoreClass = 'good';
                if (score < 50) scoreClass = 'bad';
                else if (score < 80) scoreClass = 'med';

                return `
                    <div class="team-user-card" onclick="showPage('profile-page', '${user.id}')">
                        ${avatarHTML}
                        <h3>${user.full_name}</h3>
                        <p>${user.role || 'Colaborador'} • ${user.department || 'Geral'}</p>
                        <div class="score-pill ${scoreClass}">
                            <span class="material-icons" style="font-size:12px;">star</span> ${score}
                        </div>
                    </div>
                `;
            };

            let html = '';

            if (myDept && myTeam.length > 0) {
                html += `<div class="team-section-title"><span class="material-icons">groups</span> MEU SETOR (${myDept.toUpperCase()})</div>`;
                html += `<div class="team-grid">`;
                html += myTeam.map(generateCardHTML).join('');
                html += `</div>`;
            }

            if (others.length > 0) {
                html += `<div class="team-section-title" style="margin-top: 2rem;"><span class="material-icons">public</span> OUTROS COLABORADORES</div>`;
                html += `<div class="team-grid">`;
                html += others.map(generateCardHTML).join('');
                html += `</div>`;
            }

            if (html === '') {
                html = `<div class="empty-state">Nenhum outro membro encontrado.</div>`;
            }

            container.innerHTML = html;
        }

        function populateTeamFilters(users) {
            const deptSelect = document.getElementById('team-filter-dept');
            const roleSelect = document.getElementById('team-filter-role');
            
            const depts = [...new Set(users.map(u => u.department).filter(Boolean))].sort();
            const roles = [...new Set(users.map(u => u.role).filter(Boolean))].sort();
            
            if(deptSelect.options.length <= 1) {
                deptSelect.innerHTML = '<option value="">Todos os Setores</option>';
                depts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d; opt.textContent = d;
                    deptSelect.appendChild(opt);
                });
            }
            if(roleSelect.options.length <= 1) {
                roleSelect.innerHTML = '<option value="">Todos os Cargos</option>';
                roles.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r; opt.textContent = r;
                    roleSelect.appendChild(opt);
                });
            }
        }

        let _selectorConfig = null;

        function openUserSelectorModal(config) {
            _selectorConfig = config || { title: 'Selecionar Destinatários', targetArray: selectedRecipients, onComplete: renderRecipientPills };
            const modal = document.getElementById('recipient-modal');
            modal.querySelector('.modal-header h3').textContent = _selectorConfig.title;
            modal.classList.add('visible');
            populateRecipientFilters();
            applyRecipientFilters();
        }

        function openRecipientModal() {
            openUserSelectorModal({ title: 'Selecionar Destinatários', targetArray: selectedRecipients, onComplete: renderRecipientPills });
        }

        function closeRecipientModal() {
            document.getElementById('recipient-modal').classList.remove('visible');
            if (_selectorConfig && typeof _selectorConfig.onComplete === 'function') {
                _selectorConfig.onComplete();
            }
            _selectorConfig = null;
        }

        function populateRecipientFilters() {
            const depts = [...new Set(allUsers.map(u => u.department).filter(Boolean))].sort();
            const roles = [...new Set(allUsers.map(u => u.role).filter(Boolean))].sort();

            const deptSelect = document.getElementById('filter-dept');
            const roleSelect = document.getElementById('filter-role');
            
            deptSelect.innerHTML = '<option value="">Todos Departamentos</option>';
            roleSelect.innerHTML = '<option value="">Todos Cargos</option>';

            depts.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d; opt.textContent = d;
                deptSelect.appendChild(opt);
            });
            roles.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r; opt.textContent = r;
                roleSelect.appendChild(opt);
            });
        }

        function applyRecipientFilters() {
            const deptFilter = document.getElementById('filter-dept').value;
            const roleFilter = document.getElementById('filter-role').value;
            const textFilter = document.getElementById('filter-text').value.toLowerCase();

            const isParticipantSelector = _selectorConfig && _selectorConfig.targetArray === selectedParticipants;

            const filtered = allUsers.filter(user => {
                const isCurrentUser = user.id === currentUserProfile.id;
                if(isCurrentUser && !isParticipantSelector) return false;

                const matchDept = deptFilter === "" || user.department === deptFilter;
                const matchRole = roleFilter === "" || user.role === roleFilter;
                const matchText = user.full_name.toLowerCase().includes(textFilter) || 
                                  (user.role && user.role.toLowerCase().includes(textFilter)) ||
                                  (user.department && user.department.toLowerCase().includes(textFilter));
                return matchDept && matchRole && matchText;
            });

            renderRecipientModalTable(filtered);
        }

        function renderRecipientModalTable(users) {
            const tbody = document.getElementById('recipient-table-body');
            tbody.innerHTML = '';
            const targetArray = (_selectorConfig && _selectorConfig.targetArray) ? _selectorConfig.targetArray : selectedRecipients;

            users.forEach(user => {
                const isSelected = targetArray.some(r => r.id === user.id);
                const tr = document.createElement('tr');
                tr.onclick = (event) => toggleRecipientSelection(user, event.currentTarget);
                if (isSelected) tr.classList.add('selected-row');

                const avatarInitial = user.full_name ? user.full_name.charAt(0).toUpperCase() : '?';

                tr.innerHTML = `
                    <td style="padding: 0.75rem 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div class="user-avatar" style="width: 32px; height: 32px; font-size: 0.8rem;">${avatarInitial}</div>
                            <strong>${user.full_name}</strong>
                        </div>
                    </td>
                    <td style="padding: 0.75rem 1rem;">
                        ${user.department ? `<span class="tag-fino" style="background: var(--color-info-bg); color: var(--color-info);">${user.department}</span>` : '-'}
                    </td>
                    <td style="padding: 0.75rem 1rem;">${user.role || '-'}</td>
                    <td style="text-align: center;">
                        <span class="material-icons check-icon">${isSelected ? 'check_circle' : 'radio_button_unchecked'}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('selected-count-display').textContent = `${targetArray.length} selecionados`;
        }

function toggleRecipientSelection(user) {
            const targetArray = (_selectorConfig && _selectorConfig.targetArray) ? _selectorConfig.targetArray : selectedRecipients;
            const exists = targetArray.find(r => r.id === user.id);
            if (exists) {
                const idx = targetArray.findIndex(r => r.id === user.id);
                targetArray.splice(idx, 1);
            } else {
                targetArray.push(user);
            }
            document.getElementById('selected-count-display').textContent = `${targetArray.length} selecionados`;
            applyRecipientFilters();
        }

        function showConfirmation(title, message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            
            const btnConfirm = document.getElementById('btn-confirm-action');
            const newBtn = btnConfirm.cloneNode(true);
            btnConfirm.parentNode.replaceChild(newBtn, btnConfirm);
            
            newBtn.onclick = () => {
                onConfirm();
                closeConfirmationModal();
            };
            
            modal.classList.add('visible');
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').classList.remove('visible');
        }

        async function loadUserProfileData(userId) {
            const container = document.getElementById('user-profile-content');
            const targetId = userId || currentUserProfile.id;
            if (!targetId) {
                container.innerHTML = '<p>Usuário não encontrado.</p>';
                return;
            }
            
            container.innerHTML = `<div class="page-header"><h1>Carregando Perfil...</h1></div>`;

            const isMyProfile = targetId === currentUserProfile.id;

            const promises = [
                supabaseClient.from('profiles').select('*').eq('id', targetId).single(),
                supabaseClient.rpc('get_user_pendencies', { target_user_id: targetId }),
                supabaseClient.rpc('calculate_user_score', { target_user_id: targetId }),
                supabaseClient.rpc('get_resolved_tickets', { target_user_id: targetId })
            ];
            
            if (isMyProfile) {
                promises.push(supabaseClient.rpc('get_created_pendencies', { creator_user_id: targetId }));
            }

            const [profileRes, pendenciesRes, scoreRes, resolvedTicketsRes, createdPendenciesRes] = await Promise.all(promises);

            const { data: profile, error: profileError } = profileRes;
            if (profileError || !profile) {
                container.innerHTML = '<p>Erro ao carregar perfil.</p>';
                console.error(profileError);
                return;
            }

            const { data: pendencies, error: pendenciesError } = pendenciesRes;
            const { data: resolvedTickets, error: resolvedTicketsError } = resolvedTicketsRes || { data: null };
            const { data: createdPendencies, error: createdPendenciesError } = createdPendenciesRes || { data: null };
            
            const score = Math.min(profile.score || 100, 100);
            
            let riskZone = 'green';
            let riskText = 'Em Dia';
            let barColor = 'var(--color-success)'; 
            
            if (score < 50) {
                riskZone = 'red'; riskText = 'Crítico'; barColor = 'var(--color-danger)';
            } else if (score < 80) {
                riskZone = 'yellow'; riskText = 'Atenção'; barColor = 'var(--color-warning)';
            }

            const avatarInitial = profile.full_name ? profile.full_name.charAt(0).toUpperCase() : '?';
            const roleAndDept = [profile.role, profile.department].filter(Boolean).join(' • ');

            let pendenciesHTML = `<div class="empty-state" style="grid-column: 1/-1;">Nenhuma pendência encontrada.</div>`;
            if (pendencies && pendencies.length > 0) {
                pendenciesHTML = pendencies.map(p => {
                    const readStatus = p.first_read_at
                        ? `<div style="color:var(--color-text-secondary); margin-top: 4px; border-top: 1px dashed var(--color-border); padding-top: 4px;">Visto em: ${new Date(p.first_read_at).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}</div>`
                        : `<div class="pendency-alert">⚠️ Ainda não visualizado</div>`;
                    return `<div class="pendency-card" style="border-left-color: ${p.priority === 'urgent' ? 'var(--color-danger)' : 'var(--color-warning)'}">
                                <div class="pendency-header">
                                    <h4 class="pendency-title"><span class="material-icons" style="font-size: 18px;">${p.type === 'ticket' ? 'support_agent' : 'mail'}</span> Chamado Aberto</h4>
                                    ${p.priority === 'urgent' ? `<span class="tag-fino tag-urgent">Urgente</span>` : ''}
                                </div>
                                <div class="pendency-meta">
                                    <div>De: ${p.sender_name.split(' ')[0]} (${p.sender_department || '-'})</div>
                                    ${p.due_date ? `<div>Prazo: ${new Date(p.due_date).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</div>` : ''}
                                </div>
                                ${readStatus}
                            </div>`;
                }).join('');
            }

            let createdPendenciesHTML = '';
            if (isMyProfile && createdPendencies && createdPendencies.length > 0) {
                 createdPendenciesHTML = `
                    <div class="card">
                        <h3 class="card-title"><span class="material-icons">outbox</span> Chamados que eu abri (${createdPendencies.length})</h3>
                        <div class="pendencies-grid">
                            ${createdPendencies.map(p => {
                                const readStatusText = p.first_read_at
                                    ? `Visto em: ${new Date(p.first_read_at).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}`
                                    : 'Aguardando visualização';
                                const readStatusClass = p.first_read_at ? '' : 'pendency-alert';
                                
                                return `
                                <div class="pendency-card" style="border-left-color: var(--color-info)">
                                    <div class="pendency-header">
                                        <h4 class="pendency-title"><span class="material-icons" style="font-size: 18px;">${p.type === 'ticket' ? 'support_agent' : 'mail'}</span> Chamado Aberto</h4>
                                        ${p.priority === 'urgent' ? `<span class="tag-fino tag-urgent">Urgente</span>` : ''}
                                    </div>
                                    <div class="pendency-meta">
                                        <div>Para: ${p.recipients_names || 'N/A'}</div>
                                        ${p.due_date ? `<div>Prazo: ${new Date(p.due_date).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</div>` : ''}
                                    </div>
                                    <div class="${readStatusClass}" style="margin-top: auto;">${readStatusText}</div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>`;
            }

            container.innerHTML = `
                <div class="profile-header-card zone-${riskZone}">
                    <div class="user-avatar">${avatarInitial}</div>
                    <div class="profile-info">
                        <h3>${profile.full_name}</h3>
                        <p>${roleAndDept || 'Colaborador Fama'}</p>
                        <span class="status-badge">${riskText}</span>
                    </div>
                </div>
                
                <div class="card"><h3 class="card-title"><span class="material-icons">radar</span> Radar de Engajamento</h3>
                    <div>
                        <div class="score-display"><span class="score-label">Score Atual</span><span class="score-value">${score}</span></div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${score}%; background-color: ${barColor};"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title"><span class="material-icons">pending_actions</span> ${isMyProfile ? 'Minhas Pendências' : `Pendências com ${profile.full_name.split(' ')[0]}`} (${pendencies ? pendencies.length : 0})</h3>
                    <div class="pendencies-grid">${pendenciesHTML}</div>
                </div>
                
                ${createdPendenciesHTML}
            `;

            const historyContainer = document.getElementById('user-history-content');
            let historyHTML = '';
            if (resolvedTickets && resolvedTickets.length > 0) {
                historyHTML = `
                    <div class="card">
                        <h3 class="card-title"><span class="material-icons">history</span> Histórico de Atividades (${resolvedTickets.length})</h3>
                        <div class="pendencies-grid">
                            ${resolvedTickets.map(ticket => {
                                const ticketIdShort = `#${ticket.id.substring(0, 4).toUpperCase()}`;
                                const priorityTag = ticket.priority === 'urgent' ? `<span class="tag-fino tag-urgent">Urgente</span>` : (ticket.priority === 'important' ? `<span class="tag-fino tag-important">Importante</span>` : '');

                                const firstReadDate = ticket.first_read_at
                                    ? `Visualizado em: ${new Date(ticket.first_read_at).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}`
                                    : 'Não visualizado antes da resolução';

                                const resolvedDate = ticket.resolved_at
                                    ? `Resolvido em: ${new Date(ticket.resolved_at).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}`
                                    : 'Data de resolução indisponível';

                                return `
                                    <div class="pendency-card" style="border-left-color: var(--color-success);">
                                        <div class="pendency-header">
                                            <h4 class="pendency-title">
                                                <span class="material-icons" style="color: var(--color-success);">check_circle</span>
                                                Chamado Resolvido
                                            </h4>
                                            <div>
                                                <span style="font-size: 0.8rem; font-weight: 500; color: var(--color-text-secondary);">${ticketIdShort}</span>
                                                ${priorityTag}
                                            </div>
                                        </div>
                                        <div class="pendency-meta">
                                            <div>De: ${ticket.creator_name}</div>
                                            ${ticket.due_date ? `<div>Prazo Final: ${new Date(ticket.due_date).toLocaleDateString('pt-BR')}</div>` : ''}
                                        </div>
                                        <div style="font-size: 0.85rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed var(--color-border); display: flex; flex-direction: column; gap: 0.25rem;">
                                            <div>${firstReadDate}</div>
                                            <div>${resolvedDate}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            historyContainer.innerHTML = historyHTML;
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            showToast(`Simulando upload da imagem: ${file.name}. Backend a ser implementado.`, 'info');
        }
        function initializeQuillEditor() {
            if (document.getElementById('editor-container') && !quillEditor) {
                const toolbarOptions = [ ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link'], [{ 'header': [1, 2, 3, false] }], ['clean'] ];
                quillEditor = new Quill('#editor-container', { modules: { toolbar: toolbarOptions }, placeholder: 'Escreva sua mensagem...', theme: 'snow' });
            }
        }
        function openNewMessagePopup() { document.getElementById('new-message-popup').classList.add('visible'); if (!quillEditor) initializeQuillEditor(); }
        function closeNewMessagePopup() { document.getElementById('new-message-popup').classList.remove('visible'); document.getElementById('new-message-form').reset(); selectedRecipients = []; renderRecipientPills(); document.getElementById('recipient-suggestions').style.display = 'none'; if (quillEditor) quillEditor.setContents([]); document.getElementById('tipo-simples').checked = true; toggleChamadoFields(); clearAttachment(); }
        function toggleChamadoFields() { const isChamado = document.getElementById('tipo-chamado').checked; document.getElementById('chamado-fields').style.display = isChamado ? 'flex' : 'none'; }
        function setDueDate(days) { const date = new Date(); date.setDate(date.getDate() + days); document.getElementById('due_date').value = date.toISOString().split('T')[0]; }
        function renderParticipantPills() {
            const wrapper = document.getElementById('participants-pills-wrapper');
            if (!wrapper) return;
            wrapper.innerHTML = '';
            selectedParticipants.forEach(user => {
                const pill = document.createElement('span');
                pill.className = 'recipient-pill';
                pill.innerHTML = `${user.full_name} <span class="pill-remove" onclick="selectedParticipants = selectedParticipants.filter(p => p.id !== '${user.id}'); renderParticipantPills()">&times;</span>`;
                wrapper.appendChild(pill);
            });
            if (selectedParticipants.length === 0) {
                wrapper.innerHTML = `<span style="color:var(--color-text-secondary); font-size:0.9rem;">Nenhum participante selecionado</span>`;
            }
        }

        function renderRecipientPills() { const wrapper = document.getElementById('recipient-input-wrapper'); const input = document.getElementById('destinatario-input'); wrapper.querySelectorAll('.recipient-pill').forEach(pill => pill.remove()); selectedRecipients.forEach(user => { const pill = document.createElement('span'); pill.className = 'recipient-pill'; pill.dataset.userId = user.id; pill.innerHTML = `${user.full_name} <span class="pill-remove" onclick="removeRecipient('${user.id}')">&times;</span>`; wrapper.insertBefore(pill, input); }); input.placeholder = selectedRecipients.length > 0 ? '' : 'Para:'; }
        function addRecipient(user) { if (!selectedRecipients.some(r => r.id === user.id)) { selectedRecipients.push(user); renderRecipientPills(); } const input = document.getElementById('destinatario-input'); input.value = ''; input.focus(); document.getElementById('recipient-suggestions').style.display = 'none'; }
        window.removeRecipient = (userId) => { selectedRecipients = selectedRecipients.filter(r => r.id !== userId); renderRecipientPills(); }
        function handleRecipientBackspace(e) { const input = e.target; if (e.key === 'Backspace' && input.value === '' && selectedRecipients.length > 0) { removeRecipient(selectedRecipients[selectedRecipients.length - 1].id); } }
        function handleRecipientSearch(e) { const query = e.target.value.toLowerCase(); const suggestionsContainer = document.getElementById('recipient-suggestions'); if (query.length < 1) { suggestionsContainer.style.display = 'none'; return; } const filteredUsers = allUsers.filter(user => (user.full_name && user.full_name.toLowerCase().includes(query))); suggestionsContainer.innerHTML = ''; if (filteredUsers.length > 0) { filteredUsers.forEach(user => { const item = document.createElement('div'); item.className = 'suggestion-item'; item.textContent = `${user.full_name}`; item.onclick = () => addRecipient(user); suggestionsContainer.appendChild(item); }); suggestionsContainer.style.display = 'block'; } else { suggestionsContainer.style.display = 'none'; } }
        
        function handleFileSelection(event) {
            const file = event.target.files[0];
            const previewContainer = document.getElementById('attachment-preview');
            if (file) {
                selectedFile = file;
                previewContainer.innerHTML = `<span>${file.name}</span> <span class="material-icons remove-attachment" onclick="clearAttachment()">close</span>`;
            } else { clearAttachment(); }
        }
        function clearAttachment() { selectedFile = null; document.getElementById('attachment-input').value = ''; document.getElementById('attachment-preview').innerHTML = ''; }

        async function sendMessage(e) {
            e.preventDefault();
            const sendButton = document.getElementById('btn-send-message');
            if (sendButton.disabled) return;
            if (!currentUserProfile) { showToast("Você precisa estar logado.", 'warning'); return; }
            if (selectedRecipients.length === 0) { showToast("Adicione pelo menos um destinatário.", 'warning'); return; }

            sendButton.disabled = true; sendButton.innerHTML = '<span class="material-icons" style="font-size: 18px; margin-right: 8px;">hourglass_top</span> Enviando...';

            try {
                const formData = new FormData();
                formData.append('p_subject', document.getElementById('assunto').value || "Sem assunto");
                formData.append('p_type', document.querySelector('input[name="message-type"]:checked').value);
                formData.append('p_priority', document.querySelector('.urgency-selector .btn.active').dataset.priority);
                formData.append('p_requires_response', document.getElementById('requires_response').checked);
                const dueDate = document.getElementById('due_date').value;
                if (dueDate) { formData.append('p_due_date', dueDate); }
                formData.append('p_content', quillEditor.root.innerHTML);
                formData.append('p_recipient_ids', JSON.stringify(selectedRecipients.map(u => u.id)));
                if (selectedFile) { formData.append('file', selectedFile); }

                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error("Usuário não autenticado.");

                const response = await fetch(N8N_SEND_MESSAGE_URL, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${session.access_token}` },
                    body: formData
                });

                if (!response.ok) { throw new Error('Falha na comunicação com o servidor n8n.'); }
                
                showToast("Mensagem enviada com sucesso!", 'success'); closeNewMessagePopup();
                await Promise.all([loadMessages(), loadDashboardStats()]);
            } catch (error) {
                console.error("Erro ao enviar mensagem via n8n:", error);
                showToast("Falha ao enviar mensagem: " + error.message, 'danger');
            } finally {
                sendButton.disabled = false; sendButton.innerHTML = 'Enviar';
            }
        }

        async function handleReply(e) {
            e.preventDefault();
            const replyInput = document.getElementById('reply-input');
            const replyContent = replyInput.value.trim();
            
            if (!replyContent) return;
            const conversationId = document.getElementById('reply-form').dataset.conversationId;
            const replyButton = e.submitter; 
            
            if (!conversationId || !currentUserProfile) {
                showToast('Erro: ID da conversa ou perfil não encontrado.', 'danger');
                return;
            }

            replyButton.disabled = true;
            const originalText = replyButton.innerHTML;
            replyButton.innerHTML = 'Enviando...';
            
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error('Sessão expirada.');

                const payload = { conversation_id: conversationId, content: replyContent };

                const response = await fetch(N8N_SEND_REPLY_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Falha ao enviar resposta.');
                }
                
                showToast('Resposta enviada!', 'success');
                replyInput.value = '';
                
                await openConversation(null, conversationId);
                await loadMessages();
                
            } catch (error) {
                console.error('Erro ao responder:', error);
                showToast('Erro ao enviar: ' + error.message, 'danger');
            } finally {
                replyButton.disabled = false;
                replyButton.innerHTML = originalText;
            }
        }

        function cleanParticipantList(namesString, senderName = null) {
            if (!namesString || !currentUserProfile) return '';
            let names = namesString.split(',').map(n => n.trim());
            let filtered = names.filter(n => {
                let isCurrentUser = n === currentUserProfile.full_name;
                let isSender = senderName ? n === senderName : false;
                return !isCurrentUser && !isSender;
            });
            return filtered.join(', ');
        }

        function renderMessageTable(conversations, containerId, type) {
            const container = document.getElementById(containerId);
            if (!conversations || conversations.length === 0) {
                container.innerHTML = `<div class="empty-state">Nenhuma mensagem aqui.</div>`; return;
            }
            const tableRows = conversations.map(conv => {
                const preview = conv.last_message_content ? conv.last_message_content.replace(/<[^>]*>?/gm, ' ') : '';
                const timestamp = conv.last_message_created_at ? new Date(conv.last_message_created_at).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }) : '';
                
                let who = '';
                const cleanNames = cleanParticipantList(conv.other_participants_names, conv.last_message_sender_name);

                if (type === 'sent') {
                    who = cleanNames || conv.other_participants_names || 'Destinatário Desconhecido';
                } else if (type === 'inbox') {
                    who = conv.last_message_sender_name || 'Desconhecido';
                } else { 
                    if (conv.last_message_sender_id === currentUserProfile.id) {
                        who = `Para: ${cleanNames}`;
                    } else {
                        who = conv.last_message_sender_name;
                    }
                }

                let priorityTag = '';
                if (conv.priority === 'urgent') priorityTag = `<span class="tag-fino tag-urgent">Urgente</span>`;
                if (conv.priority === 'important') priorityTag = `<span class="tag-fino tag-important">Importante</span>`;
                let metaTagsHTML = '';
                if (conv.due_date) metaTagsHTML += `<span class="tag-icon due-date-tag" title="Prazo"><span class="material-icons">event</span> ${new Date(conv.due_date).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</span>`;
                if (conv.type === 'ticket') {
                    const statusIcon = conv.status === 'resolved' ? 'check_circle' : 'support_agent';
                    const statusTitle = conv.status === 'resolved' ? 'Chamado Resolvido' : 'Chamado';
                    metaTagsHTML += `<span class="tag-icon" title="${statusTitle}"><span class="material-icons">${statusIcon}</span></span>`;
                }
                if (conv.requires_response) metaTagsHTML += '<span class="tag-icon" title="Exige Resposta"><span class="material-icons">reply</span></span>';
                const isUnread = type === 'inbox' && conv.is_unread;
                const rowClass = isUnread ? 'row-unread' : 'row-read';
                let readReceiptHTML = '';
                if (type === 'sent') {
                    const isReadByRecipient = conv.recipient_read_at && new Date(conv.recipient_read_at) >= new Date(conv.last_message_created_at);
                    if (isReadByRecipient) {
                         const readDate = new Date(conv.recipient_read_at).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                         readReceiptHTML = `<span class="read-receipt read" title="Lida em: ${readDate}"><span class="material-icons">done_all</span></span>`;
                    } else { readReceiptHTML = `<span class="read-receipt delivered" title="Enviada"><span class="material-icons">check</span></span>`; }
                }
                const archiveIcon = conv.is_archived ? 'unarchive' : 'archive';
                const archiveTitle = conv.is_archived ? 'Desarquivar' : 'Arquivar';
                return `<tr class="${rowClass}" data-conversation-id="${conv.id}">
                        <td class="col-who" onclick="openConversation(this.parentElement)">${who}</td>
                        <td class="col-subject" onclick="openConversation(this.parentElement)">${readReceiptHTML}<span class="subject-title">${conv.subject}</span>${priorityTag}<span class="subject-preview"> - ${preview}</span></td>
                        <td class="col-meta" onclick="openConversation(this.parentElement)"><div class="meta-tags">${metaTagsHTML}</div></td>
                        <td class="col-date" onclick="openConversation(this.parentElement)">${timestamp}</td>
                        <td class="col-actions"><button title="${archiveTitle}" onclick="toggleArchive(this, '${conv.id}')"><span class="material-icons">${archiveIcon}</span></button></td>
                    </tr>`;
            }).join('');
            container.innerHTML = `<table class="data-table-fino"><tbody>${tableRows}</tbody></table>`;
        }

        async function loadMessages() {
            if (!currentUserProfile) return;
            const containers = ['inbox-content', 'sent-content', 'tickets-content', 'archived-content']; 
            containers.forEach(id => document.getElementById(id).innerHTML = '<div class="empty-state">Carregando...</div>');
            
            const { data, error } = await supabaseClient.from('user_conversations_view').select('*').order('last_message_created_at', { ascending: false, nulls: 'last' });

            if (error) {
                console.error('Erro ao buscar mensagens:', error);
                const errorMsg = `<div class="empty-state" style="color: var(--color-danger);">Erro ao carregar mensagens.</div>`;
                containers.forEach(id => document.getElementById(id).innerHTML = errorMsg); return;
            }
            
            const nonArchived = data.filter(conv => !conv.is_archived);
            const archived = data.filter(conv => conv.is_archived);
            
            const inboxMessages = nonArchived.filter(conv => 
                conv.status !== 'resolved' && conv.last_message_sender_id !== currentUserProfile.id
            );

            const ticketMessages = data.filter(conv => conv.type === 'ticket');
            const sentMessages = nonArchived.filter(conv => !inboxMessages.some(i => i.id === conv.id));

            renderMessageTable(inboxMessages, 'inbox-content', 'inbox');
            renderMessageTable(sentMessages, 'sent-content', 'sent');
            renderMessageTable(ticketMessages, 'tickets-content', 'tickets');
            renderMessageTable(archived, 'archived-content', 'archived');
        }

        async function toggleArchive(buttonElement, conversationId) {
            const row = buttonElement.closest('tr');
            if (row) { row.style.transition = 'opacity 0.3s ease-out'; row.style.opacity = '0'; setTimeout(() => row.remove(), 300); }
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error("Sessão expirou.");
                const response = await fetch(N8N_TOGGLE_ARCHIVE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                    body: JSON.stringify({ conversation_id: conversationId })
                });
                if (!response.ok) throw new Error("Falha ao comunicar com o servidor.");
                showToast("Status da conversa alterado.", 'success');
            } catch (e) {
                console.error("Erro ao arquivar:", e.message); showToast("Falha ao arquivar conversa.", 'danger');
                if (row) row.style.opacity = '1';
            }
        }
        
        async function resolveTicket(conversationId) {
            showConfirmation(
                "Confirmar Resolução",
                "Tem certeza que deseja marcar este chamado como resolvido? Esta ação não pode ser desfeita.",
                async () => {
                    try {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        if (!session) throw new Error("Sessão expirou.");
                        const response = await fetch(N8N_RESOLVE_TICKET_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                            body: JSON.stringify({ conversation_id: conversationId, resolved_at: new Date().toISOString() })
                        });
                        if (!response.ok) throw new Error("Falha ao resolver o chamado. Você pode não ter permissão.");
                        
                        showToast("Chamado resolvido com sucesso!", 'success');
                        showPage('messages-page'); 
                        await Promise.all([loadMessages(), loadDashboardStats()]);

                    } catch(e) {
                        console.error("Erro ao resolver chamado:", e.message);
                        showToast(e.message, 'danger');
                    }
                }
            );
        }

        async function openConversation(rowElement, conversationIdOverride = null) {
            const conversationId = conversationIdOverride || rowElement?.dataset.conversationId;

            if (!conversationId) { showToast('ID da conversa não encontrado.', 'danger'); return; }

            if (rowElement && rowElement.classList.contains('row-unread')) {
                rowElement.classList.remove('row-unread'); 
                rowElement.classList.add('row-read');

                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session) {
                        fetch(N8N_MARK_AS_READ_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                            body: JSON.stringify({ conversation_id: conversationId, first_read_at: new Date().toISOString() })
                        });
                    }
                } catch (e) { console.warn("Não foi possível marcar a mensagem como lida:", e.message); }
            }

            showPage('conversation-view-page');
            document.getElementById('conversation-header').innerHTML = '<div class="empty-state">Carregando...</div>';
            document.getElementById('conversation-messages').innerHTML = '<div class="empty-state">Carregando mensagens...</div>';
            
            const replyForm = document.getElementById('reply-form');
            if (replyForm) {
                replyForm.dataset.conversationId = conversationId;
            }

            const [messagesRes, attachmentsRes, convDataRes] = await Promise.all([
                supabaseClient.from('conversation_messages_view').select('*').eq('conversation_id', conversationId).order('created_at', { ascending: true }),
                supabaseClient.from('message_attachments_view').select('*'),
                supabaseClient.from('user_conversations_view').select('*').eq('id', conversationId).single()
            ]);

            if (messagesRes.error || attachmentsRes.error || convDataRes.error) {
                showToast('Erro ao carregar detalhes da conversa.', 'danger');
                console.error(messagesRes.error || attachmentsRes.error || convDataRes.error);
                document.getElementById('conversation-header').innerHTML = ''; document.getElementById('conversation-messages').innerHTML = '<div class="empty-state">Falha ao carregar.</div>'; return;
            }

            const { data: messages } = messagesRes;
            const { data: allAttachments } = attachmentsRes;
            const { data: convData } = convDataRes;
            
            const headerContainer = document.getElementById('conversation-header');
            let ticketInfoHTML = '';
            let actionButtonsHTML = '';
            
            if (convData.type === 'ticket') {
                let priorityTag = '';
                if (convData.priority === 'urgent') priorityTag = `<span class="tag-fino tag-urgent">Urgente</span>`;
                else if (convData.priority === 'important') priorityTag = `<span class="tag-fino tag-important">Importante</span>`;
                
                const dueDateHTML = convData.due_date ? `<div><span class="material-icons">event</span><strong>Prazo:</strong> ${new Date(convData.due_date).toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</div>` : '';
                
                if (convData.status === 'resolved') {
                    ticketInfoHTML = `<div class="conversation-ticket-info" style="justify-content:center;"><div><span class="material-icons" style="color: var(--color-success);">check_circle</span><strong>Chamado Resolvido</strong></div></div>`;
                    document.getElementById('reply-form-wrapper').style.display = 'none';
                } else {
                    ticketInfoHTML = `<div class="conversation-ticket-info"><div><span class="material-icons">support_agent</span> <strong>Chamado Aberto</strong></div> <div>${priorityTag}</div> ${dueDateHTML}</div>`;
                    document.getElementById('reply-form-wrapper').style.display = 'block';
                }

                if (convData.created_by === currentUserProfile.id && convData.status === 'open') {
                    actionButtonsHTML = `<button class="btn btn-success" onclick="resolveTicket('${convData.id}')"><span class="material-icons">check_circle</span> Resolver Chamado</button>`;
                }
            } else {
                document.getElementById('reply-form-wrapper').style.display = 'block';
            }

            const creatorProfile = await supabaseClient.from('profiles').select('full_name').eq('id', convData.created_by).single();
            const senderName = creatorProfile.data ? creatorProfile.data.full_name : 'Desconhecido';
            
            let displayTo = '';
            let allRecipientNames = convData.other_participants_names ? convData.other_participants_names.split(',').map(n => n.trim()) : [];

            if (convData.created_by === currentUserProfile.id) {
                displayTo = allRecipientNames.filter(n => n !== currentUserProfile.full_name).join(', ') || 'Sem destinatários';
            } else {
                let coRecipients = allRecipientNames.filter(n => n !== senderName && n !== currentUserProfile.full_name);
                if (coRecipients.length > 0) {
                    displayTo = `Você, ${coRecipients.join(', ')}`;
                } else {
                    displayTo = 'Você';
                }
            }
            
            headerContainer.innerHTML = `
                <div class="conversation-main-header">
                    <button class="btn btn-secondary" onclick="showPage('messages-page'); loadMessages();"><span class="material-icons">arrow_back</span> Voltar</button>
                    <div class="page-header-actions">${actionButtonsHTML}<button class="btn btn-icon" title="Mais opções"><span class="material-icons">more_vert</span></button></div>
                </div>
                <div class="conversation-info-block">
                    <h1>${convData.subject}</h1>
                    <p><strong>De:</strong> ${senderName}</p>
                    <p><strong>Para:</strong> ${displayTo}</p>
                </div>
                ${ticketInfoHTML}
            `;

            const messagesContainer = document.getElementById('conversation-messages');
            messagesContainer.innerHTML = messages.map(msg => {
                const isSent = msg.sender_id === currentUserProfile.id;
                const timestamp = new Date(msg.created_at).toLocaleString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
                const msgAttachments = allAttachments.filter(att => att.message_id === msg.id);
                const attachmentsHTML = msgAttachments.map(att => `
                    <div class="message-attachment">
                        <a href="https://drive.google.com/file/d/${att.google_drive_file_id}/view" target="_blank" class="message-attachment-link">
                            <span class="material-icons">attach_file</span>${att.file_name}
                        </a>
                    </div>`).join('');
                return `<div class="message-bubble-wrapper ${isSent ? 'sent' : 'received'}">
                            <div class="message-bubble ${isSent ? 'sent' : 'received'}">${msg.content}${attachmentsHTML}</div>
                            <div class="message-metadata">${isSent ? 'Você' : msg.sender_name} • ${timestamp}</div>
                        </div>`;
            }).join('');
            
            messagesContainer.lastElementChild?.scrollIntoView({ behavior: 'smooth' });
        }

        async function loadUsersForAdmin() {
            const tableBody = document.getElementById('user-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = `<tr><td colspan="4">Carregando usuários...</td></tr>`;
            try {
                const { data: users, error } = await supabaseClient.from('users_with_email').select('*');
                if (error) throw error;
                tableBody.innerHTML = users.map(user => {
                    const avatarInitial = user.full_name ? user.full_name.charAt(0).toUpperCase() : '?';
                    const roleTag = user.role === 'Admin' ? `<span class="user-tag role-admin">Admin</span>` : (user.role ? `<span class="user-tag role">${user.role}</span>` : '');
                    const departmentTag = user.department ? `<span class="user-tag department">${user.department}</span>` : '';
                    return `<tr>
                        <td><div class="user-info-cell"><div class="user-avatar">${avatarInitial}</div><div><div class="user-name">${user.full_name||'N/A'}</div><div class="user-email">${user.email||'N/A'}</div></div></div></td>
                        <td><div class="user-meta-cell"><div class="user-tags">${departmentTag}${roleTag}</div></div></td>
                        <td class="score-cell"><span class="material-icons">star</span> ${user.score||100}</td>
                        <td class="action-buttons">
                            <button class="btn btn-icon" onclick='openUserModal(${JSON.stringify(user)})' title="Editar"><span class="material-icons">edit</span></button>
                            <button class="btn btn-icon" onclick="deleteUser('${user.id}')" title="Excluir"><span class="material-icons">delete</span></button>
                        </td>
                    </tr>`;
                }).join('');
            } catch(error) { 
                console.error("Erro ao carregar usuários:", error);
                tableBody.innerHTML = `<tr><td colspan="4">Erro ao carregar usuários.</td></tr>`;
            }
        }

async function openUserModal(user) {
            const modal = document.querySelector('#app-container #user-modal');
            const form = document.getElementById('user-form');
            form.reset();

            const userEmailField = document.getElementById('user_email');
            const passwordGroup = document.getElementById('password-group');
            const managerSelect = document.getElementById('manager_id');
            const deptSelect = document.getElementById('department');
            const deptOtherInput = document.getElementById('department-other');

            userEmailField.disabled = !!user;
            passwordGroup.style.display = user ? 'none' : 'block';
            document.getElementById('user_password').required = !user;
            
            // Resetar campo "Outros"
            deptOtherInput.style.display = 'none';
            deptOtherInput.required = false;
            deptOtherInput.value = '';
            
            managerSelect.innerHTML = '<option value="">Nenhum</option>';
            allUsers.forEach(u => {
                if (!user || u.id !== user.id) {
                    const option = document.createElement('option');
                    option.value = u.id;
                    option.textContent = u.full_name;
                    managerSelect.appendChild(option);
                }
            });

            if (user) {
                document.getElementById('user-modal-title').textContent = 'Editar Usuário';
                document.getElementById('user-id').value = user.id;
                document.getElementById('full_name').value = user.full_name;
                userEmailField.value = user.email || '';
                
                // Lógica para Departamento (verificar se é "Outros")
                const validDepartments = ['Administrativo', 'Controladoria', 'Recursos Humanos', 'Comercial', 'Produção', 'Fundição', 'Grampos', 'TI'];
                if (user.department && validDepartments.includes(user.department)) {
                    deptSelect.value = user.department;
                } else if (user.department) {
                    deptSelect.value = 'Outros';
                    deptOtherInput.value = user.department;
                    deptOtherInput.style.display = 'block';
                    deptOtherInput.required = true;
                }
                
                document.getElementById('role').value = user.role || '';
                managerSelect.value = user.manager_id || '';
                
                // Carregar permissões específicas do usuário
                await loadUserPermissions(user.id);
            } else {
                document.getElementById('user-modal-title').textContent = 'Novo Usuário';
                document.getElementById('user-id').value = '';
                
                // Desmarcar todas as permissões
                Object.keys(PERMISSION_MAPPING).forEach(key => {
                    const checkbox = document.getElementById(`perm-${key}`);
                    if (checkbox) checkbox.checked = false;
                });
            }
            
            modal.classList.add('visible');
        }
        function closeUserModal() { document.querySelector('#app-container #user-modal')?.classList.remove('visible'); }

        function toggleDepartmentOther() {
            const deptSelect = document.getElementById('department');
            const deptOtherInput = document.getElementById('department-other');
            
            if (deptSelect.value === 'Outros') {
                deptOtherInput.style.display = 'block';
                deptOtherInput.required = true;
                deptOtherInput.focus();
            } else {
                deptOtherInput.style.display = 'none';
                deptOtherInput.required = false;
                deptOtherInput.value = '';
            }
        }
		
async function loadUserPermissions(userId) {
    try {
        const { data: permissions, error } = await supabaseClient
            .from('user_specific_permissions')
            .select('permission_key')
            .eq('user_id', userId);
        
        if (error) throw error;
        
        // Desmarcar todos primeiro
        Object.keys(PERMISSION_MAPPING).forEach(key => {
            const checkbox = document.getElementById(`perm-${key}`);
            if (checkbox) checkbox.checked = false;
        });
        
        // Marcar os que o usuário possui
        if (permissions && permissions.length > 0) {
            permissions.forEach(perm => {
                const checkbox = document.getElementById(`perm-${perm.permission_key}`);
                if (checkbox) checkbox.checked = true;
            });
        }
    } catch (error) {
        console.error('Erro ao carregar permissões:', error);
        showToast('Erro ao carregar permissões do usuário', 'danger');
    }
}

async function saveUser() {
const userId = document.getElementById('user-id').value;
            const fullName = document.getElementById('full_name').value;
            const deptSelect = document.getElementById('department');
            const department = deptSelect.value === 'Outros' 
                ? document.getElementById('department-other').value 
                : deptSelect.value;
            const role = document.getElementById('role').value;
    const managerIdValue = document.getElementById('manager_id').value;
    const managerId = managerIdValue === "" ? null : managerIdValue;
    const email = document.getElementById('user_email').value;
    const password = document.getElementById('user_password').value;
    
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) { showToast("Sessão inválida.", 'danger'); return; }
    const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` };
    const btnSave = document.querySelector('#user-modal .btn-danger');
    btnSave.disabled = true; btnSave.textContent = "Salvando...";
    
    try {
        let finalUserId = userId;
        
        if (userId) {
            // Atualizar usuário existente
            const payload = { 
                id: userId, 
                full_name: fullName, 
                department: department, 
                role: role, 
                manager_id: managerId 
            };
            const response = await fetch(N8N_UPDATE_USER_URL, { 
                method: 'POST', 
                headers: headers, 
                body: JSON.stringify(payload) 
            });
            if (!response.ok) throw new Error('Falha ao atualizar usuário.');
} else {
                    // Criar novo usuário
                    if (!password) { throw new Error("Senha é obrigatória para novos usuários."); }
                    
                    // Coletar permissões marcadas
                    const selectedPermissions = [];
                    Object.keys(PERMISSION_MAPPING).forEach(key => {
                        const checkbox = document.getElementById(`perm-${key}`);
                        if (checkbox && checkbox.checked) {
                            selectedPermissions.push(key);
                        }
                    });
                    
                    const payload = { 
                        email: email, 
                        password: password, 
                        full_name: fullName, 
                        department: department, 
                        role: role,
                        manager_id: managerId,
                        permissions: selectedPermissions
                    };
                    const response = await fetch(N8N_CREATE_USER_URL, { 
                        method: 'POST', 
                        headers: headers, 
                        body: JSON.stringify(payload) 
                    });
                    if (!response.ok) throw new Error('Falha ao criar usuário.');
                    
                    const result = await response.json();
                    console.log('Resposta do n8n:', result); // DEBUG
                    
                    // Task: Fix User ID Recognition (Busca o ID no objeto retornado pelo n8n)
                    finalUserId = result.user_id || (result.json && result.json.id) || (result[0] && result[0].id) || result.id;
                    
                    console.log('finalUserId capturado:', finalUserId); // DEBUG
                    
                    if (!finalUserId) {
                        console.error('Resultado completo:', JSON.stringify(result));
                        throw new Error('ID do usuário não foi retornado');
                    }
                }
        
        // Sincronizar permissões individuais
        await syncUserPermissions(finalUserId);
        
        showToast(userId ? "Usuário atualizado com sucesso!" : "Usuário criado com sucesso!", 'success');
        closeUserModal();
        await fetchAllUsersForSearch();
        loadUsersForAdmin();

        const organogramaPage = document.getElementById('organograma-page');
        if (organogramaPage && organogramaPage.classList.contains('active')) {
            const currentFilter = document.getElementById('org-filter-dept')?.value || '';
            loadOrganogramaPage(currentFilter);
        }

    } catch (error) {
        console.error(error);
        showToast(error.message, 'danger');
    } finally {
        btnSave.disabled = false;
        btnSave.textContent = "Salvar";
    }
}

async function syncUserPermissions(userId) {
            try {
                // Coletar permissões marcadas
                const selectedPermissions = [];
                Object.keys(PERMISSION_MAPPING).forEach(key => {
                    const checkbox = document.getElementById(`perm-${key}`);
                    if (checkbox && checkbox.checked) {
                        selectedPermissions.push(key);
                    }
                });
                
                // Passo 1: Remover todas as permissões antigas do usuário
                const { error: deleteError } = await supabaseClient
                    .from('user_specific_permissions')
                    .delete()
                    .eq('user_id', userId);
                
                if (deleteError) throw deleteError;
                
                // Passo 2: Inserir novas permissões
                if (selectedPermissions.length > 0) {
                    const permissionsToInsert = selectedPermissions.map(permKey => ({
                        user_id: userId,
                        permission_key: permKey
                    }));
                    
                    const { error: insertError } = await supabaseClient
                        .from('user_specific_permissions')
                        .insert(permissionsToInsert);
                    
                    if (insertError) throw insertError;
                }
                
                console.log(`Permissões sincronizadas para usuário ${userId}:`, selectedPermissions);
                
            } catch (error) {
                console.error('Erro ao sincronizar permissões:', error);
                throw new Error('Falha ao salvar permissões do usuário');
            }
        }

        async function deleteUser(userId) {
            showConfirmation(
                "Excluir Usuário",
                "Tem certeza que deseja excluir este usuário? Esta ação é irreversível.",
                async () => {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (!session) return;
                    try {
                        const response = await fetch(N8N_DELETE_USER_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` }, body: JSON.stringify({ id: userId }) });
                        if (!response.ok) throw new Error('Falha ao excluir usuário.');
                        showToast("Usuário excluído com sucesso!", 'success'); loadUsersForAdmin();
                    } catch (error) {
                        console.error(error); showToast(error.message, 'danger');
                    }
                }
            );
        }
        
        const body = document.body;
        themeToggleBtn.addEventListener('click', () => applyTheme(body.classList.contains('dark-mode') ? 'light' : 'dark'));
        
        function applyTheme(theme) {
            body.classList.toggle('dark-mode', theme === 'dark');
            localStorage.setItem('theme', theme);
            updateLogos();
        }

        function updateLogos() {
            const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            const logoSrc = theme === 'dark' ? LOGO_DARK_URL : LOGO_LIGHT_URL;
            document.querySelectorAll('.sidebar-logo, .login-logo').forEach(img => {
                if (img) img.src = logoSrc;
            });
        }

        async function loadRankingsPage() {
            const fastestList = document.getElementById('fastest-responders-list');
            const pendingList = document.getElementById('most-pending-list');

            fastestList.innerHTML = '<div class="empty-state">Carregando ranking...</div>';
            pendingList.innerHTML = '<div class="empty-state">Carregando ranking...</div>';

            const [fastestRes, pendingRes] = await Promise.all([
                supabaseClient.rpc('get_fastest_responders'),
                supabaseClient.rpc('get_users_with_most_pending')
            ]);

            if (fastestRes.error || !fastestRes.data || fastestRes.data.length === 0) {
                fastestList.innerHTML = '<div class="empty-state">Não há dados de agilidade para exibir.</div>';
            } else {
                const fastestHTML = fastestRes.data.map((user, index) => {
                    const avatarInitial = user.full_name ? user.full_name.charAt(0).toUpperCase() : '?';
                    return `
                        <div class="user-info-cell" style="padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; background-color: var(--color-background);">
                            <div style="font-weight: 700; color: var(--color-text-secondary); width: 20px;">${index + 1}</div>
                            <div class="user-avatar" style="width: 36px; height: 36px;">${avatarInitial}</div>
                            <div style="flex-grow: 1;">
                                <div class="user-name">${user.full_name}</div>
                                <div class="user-email">${user.department}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; font-size: 1.1rem; color: var(--color-success);">${user.avg_response_time}</div>
                                <div class="user-email">tempo médio</div>
                            </div>
                        </div>
                    `;
                }).join('');
                fastestList.innerHTML = fastestHTML;
            }

            if (pendingRes.error || !pendingRes.data || pendingRes.data.length === 0) {
                pendingList.innerHTML = '<div class="empty-state">Ninguém com pendências. Ótimo!</div>';
            } else {
                const pendingHTML = pendingRes.data.map((user, index) => {
                    const avatarInitial = user.full_name ? user.full_name.charAt(0).toUpperCase() : '?';
                    return `
                        <div class="user-info-cell" style="padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; background-color: var(--color-background);">
                            <div style="font-weight: 700; color: var(--color-danger); width: 20px;">${index + 1}</div>
                            <div class="user-avatar" style="width: 36px; height: 36px;">${avatarInitial}</div>
                            <div style="flex-grow: 1;">
                                <div class="user-name">${user.full_name}</div>
                                <div class="user-email">${user.department}</div>
                                ${user.overdue_count > 0 ? `<div style="font-size: 0.8rem; color: var(--color-danger); font-weight: 500;">${user.overdue_count} mensagens em atraso</div>` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--color-danger);">${user.pending_count}</div>
                                    <div class="user-email">pendentes</div>
                                </div>
                                <button class="btn-icon" onclick="showPage('profile-page', '${user.id}')" title="Ver perfil de ${user.full_name}">
                                    <span class="material-icons">visibility</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                pendingList.innerHTML = pendingHTML;
            }
        }

        async function handleRequestAction(action, requestId) {
            const url = action === 'approve' ? N8N_APPROVE_REQUEST_URL : N8N_REJECT_REQUEST_URL;
            
            const buttons = document.querySelectorAll(`[data-request-id='${requestId}'] button`);
            buttons.forEach(btn => btn.disabled = true);

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error("Sessão inválida.");

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({ request_id: requestId })
                });

                if (!response.ok) throw new Error(`Falha ao ${action === 'approve' ? 'aprovar' : 'reprovar'} a requisição.`);

                showToast(`Requisição ${action === 'approve' ? 'aprovada' : 'reprovada'} com sucesso!`, 'success');
                loadRequestManagementPage();
            } catch (error) {
                console.error("Erro na ação da requisição:", error);
                showToast(error.message, "danger");
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        async function loadRequestManagementPage() {
            const tableBody = document.getElementById('request-management-table-body');
            tableBody.innerHTML = `<tr><td colspan="5" class="empty-state">Carregando requisições...</td></tr>`;

            const { data, error } = await supabaseClient.rpc('get_all_requests_for_viewing');
            
            if (error) {
                console.error("Erro ao buscar requisições para gerenciamento:", error);
                tableBody.innerHTML = `<tr><td colspan="5" class="empty-state" style="color: var(--color-danger)">Falha ao carregar.</td></tr>`;
                return;
            }
            
            const filteredData = data.filter(req => req.type !== 'travel');

            if (!filteredData || filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="empty-state">Nenhuma requisição encontrada.</td></tr>`;
                return;
            }

            const requestTypeLabels = {
                'new_hire': 'Contratação', 'termination': 'Desligamento', 'promotion': 'Promoção',
                'overtime': 'Horas Extras', 'training': 'Treinamento'
            };
            
            const statusLabels = {
                pending: 'Pendente',
                approved: 'Aprovado',
                rejected: 'Recusado',
                cancelled_by_requester: 'Cancelada pelo Solicitante'
            };

            tableBody.innerHTML = filteredData.map(req => {
                const typeLabel = requestTypeLabels[req.type] || req.type.replace(/_/g, ' ');
                const date = new Date(req.created_at).toLocaleDateString('pt-BR');
                const statusLabel = statusLabels[req.status] || req.status;
                const statusClass = req.status === 'cancelled_by_requester' ? 'status-rejected' : `status-${req.status}`;
                
                const actionsHTML = `
                    <button class="btn btn-secondary" style="padding: 0.4rem 0.8rem;" onclick="openRequestDetailsModal('${req.id}')">Ver Detalhes</button>
                    ${req.status === 'pending' ? `
                        <span data-request-id="${req.id}">
                            <button class="btn btn-icon" title="Aprovar" onclick="handleRequestAction('approve', '${req.id}')"><span class="material-icons" style="color:var(--color-success);">check_circle</span></button>
                            <button class="btn btn-icon" title="Reprovar" onclick="handleRequestAction('reject', '${req.id}')"><span class="material-icons" style="color:var(--color-danger);">cancel</span></button>
                        </span>
                    ` : ''}
                `;

                return `
                    <tr>
                        <td>${req.requester_name || 'Desconhecido'}</td>
                        <td><strong>${typeLabel}</strong></td>
                        <td>${date}</td>
                        <td><span class="status-tag ${statusClass}">${statusLabel}</span></td>
                        <td>${actionsHTML}</td>
                    </tr>
                `;
            }).join('');
        }
        
        async function loadTravelRequestManagementPage() {
            const tableBody = document.getElementById('travel-request-management-table-body');
            tableBody.innerHTML = `<tr><td colspan="6" class="empty-state">Carregando requisições de viagem...</td></tr>`;

            const { data, error } = await supabaseClient.rpc('get_all_requests_for_viewing');

            if (error) {
                console.error("Erro ao buscar requisições de viagem:", error);
                tableBody.innerHTML = `<tr><td colspan="6" class="empty-state" style="color: var(--color-danger)">Falha ao carregar.</td></tr>`;
                return;
            }

            const travelRequests = data.filter(req => req.type === 'travel');

            if (travelRequests.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="empty-state">Nenhuma requisição de viagem encontrada.</td></tr>`;
                return;
            }
            
            const travelStatusLabels = {
                'pending_review': 'Aguardando Análise', 'approved_by_director': 'Aprovado (Diretor)',
                'rejected_by_director': 'Recusado (Diretor)', 'pending_final_approval': 'Aprovação Final Pendente',
                'approved_definitively': 'Aprovada', 'rejected_definitively': 'Recusada',
                'cancelled_by_requester': 'Cancelada pelo Solicitante'
            };

            tableBody.innerHTML = travelRequests.map(req => {
                const statusLabel = travelStatusLabels[req.status] || req.status.replace(/_/g, ' ');
                let statusClass;
                if (req.status === 'pending_review' || req.status === 'pending_final_approval') {
                    statusClass = 'status-pending';
                } else if (req.status === 'cancelled_by_requester') {
                    statusClass = 'status-rejected';
                } else {
                    statusClass = req.status.includes('approved') ? 'status-approved' : 'status-rejected';
                }
                const startDate = req.data.data_saida ? new Date(req.data.data_saida + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
                const endDate = req.data.data_retorno ? new Date(req.data.data_retorno + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
                return `
                    <tr>
                        <td>${req.requester_name || 'N/A'}</td>
                        <td>${req.data.titulo || 'Sem Título'}</td>
                        <td>${req.data.local || 'N/A'}</td>
                        <td>${startDate} - ${endDate}</td>
                        <td><span class="status-tag ${statusClass}">${statusLabel}</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 0.4rem 0.8rem;" onclick="openTravelRequestDetailsModal('${req.id}')">Ver Análise</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function openTravelRequestDetailsModal(requestId) {
            const modal = document.getElementById('request-modal');
            const modalTitle = document.getElementById('request-modal-title');
            const modalBody = document.getElementById('request-modal-body');
            const modalFooter = document.getElementById('request-modal-footer');
            const formatCurrency = (value) => `R$ ${parseFloat(value || 0).toFixed(2).replace('.', ',')}`;

            modalTitle.textContent = 'Carregando Análise de Viagem...';
            modalBody.innerHTML = '<div class="empty-state">Buscando dados e custos...</div>';
            modalFooter.innerHTML = '';
            modal.classList.add('visible');

            try {
                const { data: request, error } = await supabaseClient.from('requests').select('*, requester:profiles(full_name)').eq('id', requestId).single();
                if (error || !request) throw new Error('Não foi possível carregar os detalhes da requisição.');

                currentEditingRequest = request;

                const reqData = request.data || {};
                const cCarro  = reqData.cenario_carro  || {};
                const cAviao  = reqData.cenario_aviao  || {};
                const cOnibus = reqData.cenario_onibus || {};

                // 1. CORREÇÃO DO SOLICITANTE
                const solicitanteNome = reqData.solicitante || request.requester?.full_name || 'N/A';
                
                // Dados de Aprovação (Task: Veredito)
                const isApproved = request.status.includes('approved');
                const selectedScenario = reqData.selected_scenario;
                const vereditoHTML = isApproved ? `
                    <div class="card" style="border-left: 4px solid var(--color-success); background: var(--color-success-bg); margin-bottom: 1.5rem; padding: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--color-success); display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons">gavel</span> Veredito da Gestão
                        </h4>
                        <p style="margin: 0; font-size: 0.9rem;"><strong>Cenário Eleito:</strong> <span class="tag-fino status-approved">${selectedScenario.toUpperCase()}</span></p>
                        <p style="margin: 4px 0; font-size: 0.9rem;"><strong>Decidido por:</strong> ${reqData.decided_by} em ${new Date(reqData.decided_at).toLocaleString('pt-BR')}</p>
                        ${reqData.decision_notes ? `<p style="margin: 4px 0; font-size: 0.9rem; font-style: italic;">"${reqData.decision_notes}"</p>` : ''}
                    </div>
                ` : '';

                modalTitle.textContent = `Análise de Viagem: ${reqData.titulo || 'Sem Título'}`;

                // 3. CONTEÚDO DAS ABAS
                const canApprove = currentUserProfile.permissions &&
                                   currentUserProfile.permissions.includes('manage_requests');

                const tabCarroHTML = `
                    <div class="card" style="border-left: 4px solid var(--color-brand-primary); margin: 0;">
                        <p><strong>Combustível (Estimado):</strong> ${formatCurrency(cCarro.combustivel_estimado || cCarro.transporte)}
                            <span class="material-icons calc-info" title="Distância calculada via Google Maps x preço médio do combustível na rota. Inclui ida e volta.">info</span>
                        </p>
                        <p><strong>Hospedagem:</strong> ${formatCurrency(cCarro.hospedagem)}
                            <span class="material-icons calc-info" title="Valor médio de R$ 450,00 por diária/pessoa x ${reqData.num_participantes || 1} pessoas x ${reqData.analise_viagem?.dias || 1} dias.">info</span>
                        </p>
                        <p><strong>Alimentação:</strong> ${formatCurrency(cCarro.alimentacao)}
                            <span class="material-icons calc-info" title="Soma das 4 refeições diárias (R$ 150,00) x ${reqData.num_participantes || 1} pessoas x ${reqData.analise_viagem?.dias || 1} dias.">info</span>
                        </p>
                        <hr style="margin: 1rem 0; border-color: var(--color-border);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin: 0; color: var(--color-brand-primary);">TOTAL: ${formatCurrency(cCarro.total)}</h3>
                            ${canApprove && request.status === 'pending_review' ? `<button class="btn btn-danger" onclick="openDecisionModal('carro')">Escolher Carro</button>` : ''}
                        </div>
                    </div>
                `;

                const voosHTML = (reqData.analise_viagem?.melhores_voos || []).length > 0
                    ? (reqData.analise_viagem.melhores_voos).map(voo => {
                        const isSelecionado = isApproved && reqData.approved_flight_link && voo.link === reqData.approved_flight_link;
                        return `
                        <div class="${isSelecionado ? 'voo-selecionado' : ''}" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); padding: 6px 0;">
                            <div>
                                <strong style="font-size: 0.9rem;">${voo.cia}</strong>
                                <span style="font-size: 0.85rem; color: var(--color-text-secondary);"> — ${formatCurrency(voo.preco_unitario)} / pessoa</span>
                                ${isSelecionado ? `<span class="material-icons" style="font-size: 16px; color: var(--color-success); vertical-align: middle; margin-left: 4px;">check_circle</span>` : ''}
                            </div>
                            <div style="display:flex; gap:5px; align-items:center;">
                                ${isSelecionado
                                    ? `<span class="status-tag status-approved" style="font-size: 0.75rem;">SELECIONADO</span>`
                                    : `<a href="${voo.link}" target="_blank" class="btn btn-secondary" title="Ver no site" style="padding: 0.3rem; border-radius: 4px;"><span class="material-icons" style="font-size: 16px;">open_in_new</span></a>`
                                }
                                ${canApprove && request.status === 'pending_review' ? `
                                    <button class="btn btn-success" onclick="openDecisionModal('aviao', '${voo.link}', '${voo.preco_unitario}')" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;">Escolher e Ajustar</button>
                                ` : ''}
                            </div>
                        </div>
                    `}).join('')
                    : `<p style="color: var(--color-text-secondary); font-size: 0.85rem;">Nenhuma opção de voo encontrada.</p>`;

                const tabAviaoHTML = `
                    <div class="card" style="border-left: 4px solid var(--color-info); margin: 0;">
                        <p style="font-weight: 600; margin-bottom: 0.5rem;">Melhores Opções de Voos:</p>
                        <div style="background: var(--color-background); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            ${voosHTML}
                        </div>
                        <p><strong>Passagem (Total Grupo):</strong> ${formatCurrency(cAviao.passagem_total || cAviao.passagem)}
                            <span class="material-icons calc-info" title="Menor tarifa encontrada pela API Amadeus + 20% de margem de segurança para variação de preço até a compra.">info</span>
                        </p>
                        <p><strong>Uber / Deslocamento Local:</strong> ${formatCurrency(cAviao.uber_local || 0)}
                            <span class="material-icons calc-info" title="Custo diário de R$ 80,00 (padrão Fama) x ${reqData.analise_viagem?.dias || 1} dias de estadia.">info</span>
                        </p>
                        <p><strong>Hospedagem:</strong> ${formatCurrency(cAviao.hospedagem)}
                            <span class="material-icons calc-info" title="Valor médio de R$ 450,00 por diária/pessoa x ${reqData.num_participantes || 1} pessoas x ${reqData.analise_viagem?.dias || 1} dias.">info</span>
                        </p>
                        <p><strong>Alimentação:</strong> ${formatCurrency(cAviao.alimentacao)}
                            <span class="material-icons calc-info" title="Soma das 4 refeições diárias (R$ 150,00) x ${reqData.num_participantes || 1} pessoas x ${reqData.analise_viagem?.dias || 1} dias.">info</span>
                        </p>
                        <hr style="margin: 1rem 0; border-color: var(--color-border);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin: 0; color: var(--color-info);">TOTAL: ${formatCurrency(cAviao.total)}</h3>
                            ${canApprove && request.status === 'pending_review' ? `<button class="btn btn-danger" onclick="openDecisionModal('aviao')">Escolher Avião</button>` : ''}
                        </div>
                    </div>
                `;

                const tabOnibusHTML = `
                    <div class="card" style="border-left: 4px solid var(--color-warning); margin: 0;">
                        <p><strong>Passagem Ônibus:</strong> ${formatCurrency(cOnibus.transporte_passagem || cOnibus.transporte)}
                            <span class="material-icons calc-info" title="Melhor tarifa de passagem rodoviária encontrada para a rota, incluindo ida e volta para todos os participantes.">info</span>
                        </p>
                        <p><strong>Hospedagem:</strong> ${formatCurrency(cOnibus.hospedagem)}
                            <span class="material-icons calc-info" title="Valor médio de R$ 450,00 por diária/pessoa x ${reqData.num_participantes || 1} pessoas x ${reqData.analise_viagem?.dias || 1} dias.">info</span>
                        </p>
                        <p><strong>Alimentação:</strong> ${formatCurrency(cOnibus.alimentacao)}
                            <span class="material-icons calc-info" title="Soma das 4 refeições diárias (R$ 150,00) x ${reqData.num_participantes || 1} pessoas x ${reqData.analise_viagem?.dias || 1} dias.">info</span>
                        </p>
                        <hr style="margin: 1rem 0; border-color: var(--color-border);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin: 0; color: var(--color-warning);">TOTAL: ${formatCurrency(cOnibus.total)}</h3>
                            ${canApprove && request.status === 'pending_review' ? `<button class="btn btn-danger" onclick="openDecisionModal('onibus')">Escolher Ônibus</button>` : ''}
                        </div>
                    </div>
                `;

                // 2. MONTAGEM DO MODAL COM SISTEMA DE ABAS
                modalBody.innerHTML = `
                    <div style="padding: 1rem;">
                        <h4 class="form-section-title" style="margin-top: 0;">Informações Gerais</h4>
                        <p><strong>Solicitante:</strong> ${solicitanteNome}</p>
                        <p><strong>Destino:</strong> ${reqData.local || 'N/A'}</p>
                        <p><strong>Período:</strong> ${new Date(reqData.data_saida + 'T00:00:00').toLocaleDateString('pt-BR')} a ${new Date(reqData.data_retorno + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                        <p><strong>Participantes:</strong> ${reqData.participantes_nomes || 'N/A'}</p>
                        <p><strong>Justificativa:</strong> ${reqData.justificativa || 'Não informada'}</p>

                        ${vereditoHTML}

                        <h4 class="form-section-title" style="margin-top: 2rem; margin-bottom: 0;">Análise Comparativa de Custos</h4>

                        <div style="display: flex; gap: 0; margin-top: 1rem; border-bottom: 1px solid var(--color-border);">
                            <button class="tab-link active" id="tab-btn-carro"   onclick="switchTravelTab('carro')"  style="border: 1px solid var(--color-border); border-bottom: none; border-radius: 8px 8px 0 0; margin-right: 4px;">
                                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">directions_car</span> Carro
                            </button>
                            <button class="tab-link"        id="tab-btn-aviao"  onclick="switchTravelTab('aviao')"  style="border: 1px solid var(--color-border); border-bottom: none; border-radius: 8px 8px 0 0; margin-right: 4px;">
                                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">flight_takeoff</span> Avião
                            </button>
                            <button class="tab-link"        id="tab-btn-onibus" onclick="switchTravelTab('onibus')" style="border: 1px solid var(--color-border); border-bottom: none; border-radius: 8px 8px 0 0;">
                                <span class="material-icons" style="font-size: 16px; vertical-align: middle;">directions_bus</span> Ônibus
                            </button>
                        </div>

                        <div id="travel-tab-carro"  class="travel-tab-content">${tabCarroHTML}</div>
                        <div id="travel-tab-aviao"  class="travel-tab-content" style="display:none;">${tabAviaoHTML}</div>
                        <div id="travel-tab-onibus" class="travel-tab-content" style="display:none;">${tabOnibusHTML}</div>
                    </div>
                `;

                // ADICIONE ESTA LINHA AQUI:
                switchTravelTab(selectedScenario || 'carro');

                modalFooter.innerHTML = `
                    <button class="btn btn-secondary" onclick="closeRequestModal()">Fechar</button>
                `;

            } catch (error) {
                console.error(error);
                modalBody.innerHTML = `<div class="empty-state" style="color:var(--color-danger);">${error.message}</div>`;
                modalFooter.innerHTML = `<button class="btn btn-secondary" onclick="closeRequestModal()">Fechar</button>`;
            }
        }

        function switchTravelTab(tab) {
            ['carro', 'aviao', 'onibus'].forEach(t => {
                document.getElementById(`travel-tab-${t}`).style.display  = t === tab ? 'block' : 'none';
                document.getElementById(`tab-btn-${t}`).classList.toggle('active', t === tab);
            });
        }

        function openDecisionModal(selectedScenario, flightLink = null, flightPrice = null) {
            if (!currentEditingRequest) return;
            // Armazena o link selecionado temporariamente no elemento para ser lido no submit
            const modal = document.getElementById('request-modal');
            modal.dataset.selectedFlightLink = flightLink || "";

            const modalTitle = document.getElementById('request-modal-title');
            const modalBody = document.getElementById('request-modal-body');
            const modalFooter = document.getElementById('request-modal-footer');

            const reqData = currentEditingRequest.data;
            const scenarioData = selectedScenario === 'carro'
                ? reqData.cenario_carro
                : (selectedScenario === 'aviao' ? reqData.cenario_aviao : reqData.cenario_onibus);

            const scenarioLabels = { carro: 'Carro', aviao: 'Avião', onibus: 'Ônibus' };
            modalTitle.textContent = `Ajuste Final: Cenário ${scenarioLabels[selectedScenario] || selectedScenario}`;

            let fieldsHTML = '';
            if (selectedScenario === 'carro') {
                fieldsHTML = `
                    <label>Combustível (R$)</label>
                    <input type="number" step="0.01" id="edit-transport" class="input-field" value="${scenarioData.transporte || scenarioData.combustivel_estimado || 0}">
                `;
} else {
                fieldsHTML = `
                    <label>Passagem (R$ / pessoa)</label>
                    <input type="number" step="0.01" id="edit-transport" class="input-field" value="${flightPrice || scenarioData.passagem || scenarioData.transporte_passagem || scenarioData.passagem_total || 0}">
                    <label>Deslocamento Local / Uber (R$)</label>
                    <input type="number" step="0.01" id="edit-uber" class="input-field" value="${scenarioData.uber_local || 0}">
                `;
            }

            modalBody.innerHTML = `
            <div style="padding: 1rem;">
                <div class="form-group">
                    <h4 class="form-section-title">Revisar Valores Selecionados</h4>
                    <div class="grid grid-cols-2" style="align-items: center; gap: 10px;">
                        ${fieldsHTML}
                        <label>Hospedagem (R$)</label>
                        <input type="number" step="0.01" id="edit-hospedagem" class="input-field" value="${scenarioData.hospedagem || 0}">
                        <label>Alimentação (R$)</label>
                        <input type="number" step="0.01" id="edit-alimentacao" class="input-field" value="${scenarioData.alimentacao || 0}">
                    </div>
                </div>
                <div class="form-group">
                    <h4 class="form-section-title">Observações da Gestão</h4>
                    <textarea id="decision-notes" class="input-field" rows="3" placeholder="Por que este cenário foi escolhido?"></textarea>
                </div>
            </div>
            `;

            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="openTravelRequestDetailsModal('${currentEditingRequest.id}')">Voltar</button>
                <button class="btn btn-danger" onclick="submitTravelDecision('rejected_by_director', '${selectedScenario}')">Recusar</button>
                <button class="btn btn-success" onclick="submitTravelDecision('approved_by_director', '${selectedScenario}')">Aprovar Cenário</button>
            `;
        }
        
        async function submitTravelDecision(decision, selectedScenario) {
            if (!currentEditingRequest) return;

            // 1. RECOLETAR OS DADOS (INCLUINDO OS EDITADOS)
            let updatedData = JSON.parse(JSON.stringify(currentEditingRequest.data));

            // Atualiza apenas o cenário selecionado com os valores editados
            const scenarioKey = selectedScenario === 'carro' ? 'cenario_carro' : (selectedScenario === 'aviao' ? 'cenario_aviao' : 'cenario_onibus');
const numParticipants = updatedData.num_participantes || 1;
            if (selectedScenario === 'carro') {
                updatedData[scenarioKey].transporte = document.getElementById('edit-transport').value;
            } else {
                const valorPassagemEditado = parseFloat(document.getElementById('edit-transport').value || 0);
                updatedData[scenarioKey].passagem_unitaria_aprovada = valorPassagemEditado.toFixed(2);
                updatedData[scenarioKey].passagem_total = (valorPassagemEditado * numParticipants).toFixed(2);
                updatedData[scenarioKey].uber_local = document.getElementById('edit-uber')?.value || 0;
            }
            updatedData[scenarioKey].hospedagem  = document.getElementById('edit-hospedagem').value;
            updatedData[scenarioKey].alimentacao = document.getElementById('edit-alimentacao').value;

            updatedData.decision_notes    = document.getElementById('decision-notes').value;
            updatedData.selected_scenario = selectedScenario;
            updatedData.final_decision    = decision;
            updatedData.decided_by        = currentUserProfile.full_name;
            updatedData.decided_at        = new Date().toISOString();
            updatedData.approved_flight_link = document.getElementById('request-modal').dataset.selectedFlightLink || "";
            
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error("Sessão inválida.");

                // 2. MONTAR O CORPO DA REQUISIÇÃO CORRETAMENTE
                const bodyPayload = {
                    request_id: currentEditingRequest.id, // <-- ENVIA O ID
                    decision: decision, // <-- ENVIA A DECISÃO
                    updated_data: JSON.stringify(updatedData) // <-- ENVIA OS DADOS ATUALIZADOS
                };

                const response = await fetch(N8N_REGISTER_DECISION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify(bodyPayload)
                });

                if (!response.ok) throw new Error('Falha ao registrar decisão.');
                
                showToast('Decisão registrada com sucesso!', 'success');
                closeRequestModal();
                loadTravelRequestManagementPage();

            } catch (error) {
                showToast(`Erro: ${error.message}`, 'danger');
            }
        }

        // --- ROUTINES MODULE LOGIC ---
        async function loadMyRoutinesPage() {
            const page = document.getElementById('my-routines-page');
            page.innerHTML = `
                <div class="page-header">
                    <div><h1>Minhas Rotinas</h1><p>Organize e acompanhe suas tarefas diárias.</p></div>
                </div>
                <div class="grid" style="grid-template-columns: 350px 1fr; gap: 2rem; align-items: flex-start;">
                    <div class="card" id="calendar-container" style="padding: 1rem;"></div>
                    <div class="card">
                        <h3 id="tasks-list-title" style="margin-top:0; border-bottom: 1px solid var(--color-border); padding-bottom: 0.5rem; margin-bottom: 1rem;">Tarefas do Dia</h3>
                        <div id="tasks-list-container"></div>
                    </div>
                </div>
            `;
            
            routineCurrentDate = new Date();
            await renderCalendar(routineCurrentDate.getFullYear(), routineCurrentDate.getMonth());
            selectDate(new Date().toISOString().split('T')[0]);
        }

        async function renderCalendar(year, month) {
            const container = document.getElementById('calendar-container');
            if (!container) return;
            container.innerHTML = '<div class="empty-state">Carregando calendário...</div>';

            const { data: tasksStatus, error } = await supabaseClient.rpc('get_tasks_status_for_month', {
                p_year: year,
                p_month: month + 1
            });

            if (error) {
                container.innerHTML = '<div class="empty-state" style="color: var(--color-danger)">Erro ao carregar dados.</div>';
                console.error(error);
                return;
            }

            const statusMap = new Map((tasksStatus || []).map(s => [s.date, { has_pending: s.has_pending, all_completed: s.all_completed }]));
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();

            const monthName = firstDay.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            
            let html = `
                <div class="calendar-header">
                    <button class="btn btn-icon" id="prev-month-btn"><span class="material-icons">chevron_left</span></button>
                    <h3>${monthName}</h3>
                    <button class="btn btn-icon" id="next-month-btn"><span class="material-icons">chevron_right</span></button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-weekday">D</div><div class="calendar-weekday">S</div><div class="calendar-weekday">T</div><div class="calendar-weekday">Q</div><div class="calendar-weekday">Q</div><div class="calendar-weekday">S</div><div class="calendar-weekday">S</div>
            `;

            for (let i = 0; i < startDayOfWeek; i++) {
                html += `<div class="calendar-day empty"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                const isToday = dateString === new Date().toISOString().split('T')[0];
                const status = statusMap.get(dateString);

                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                
                let indicator = '';
                if (status) {
                    if (status.all_completed) {
                        dayClass += ' day-completed';
                        indicator = '<div class="task-indicator completed"><span class="material-icons">check</span></div>';
                    } else if (status.has_pending) {
                        dayClass += ' day-pending';
                        indicator = '<div class="task-indicator pending"></div>';
                    }
                }

                html += `<div class="${dayClass}" data-date="${dateString}" onclick="selectDate('${dateString}')">
                            <span>${day}</span>
                            ${indicator}
                         </div>`;
            }

            html += '</div>';
            container.innerHTML = html;

            document.getElementById('prev-month-btn').onclick = () => {
                routineCurrentDate.setMonth(routineCurrentDate.getMonth() - 1);
                renderCalendar(routineCurrentDate.getFullYear(), routineCurrentDate.getMonth());
            };
            document.getElementById('next-month-btn').onclick = () => {
                routineCurrentDate.setMonth(routineCurrentDate.getMonth() + 1);
                renderCalendar(routineCurrentDate.getFullYear(), routineCurrentDate.getMonth());
            };
        }

        function selectDate(dateString) {
            document.querySelectorAll('.calendar-day.active').forEach(el => el.classList.remove('active'));
            const selectedDay = document.querySelector(`.calendar-day[data-date="${dateString}"]`);
            if (selectedDay) {
                selectedDay.classList.add('active');
            }
            fetchAndRenderTasks(dateString);
        }

        async function fetchAndRenderTasks(date) {
            const tasksContainer = document.getElementById('tasks-list-container');
            const titleElement = document.getElementById('tasks-list-title');
            if (!tasksContainer || !titleElement) return;
            tasksContainer.innerHTML = `<div class="empty-state">Carregando tarefas...</div>`;

            const dateObj = new Date(date + 'T12:00:00');
            const formattedDate = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            titleElement.textContent = `Tarefas para ${formattedDate}`;

            const { data: tasks, error } = await supabaseClient.rpc('get_user_tasks_for_date', { p_date: date });

            if (error) {
                console.error('Erro ao buscar tarefas:', error);
                tasksContainer.innerHTML = `<div class="empty-state" style="color: var(--color-danger)">Falha ao carregar tarefas.</div>`;
                return;
            }

            if (tasks.length === 0) {
                tasksContainer.innerHTML = `<div class="empty-state">Nenhuma tarefa atribuída a você para este dia.</div>`;
                return;
            }

            const tasksByRoutine = tasks.reduce((acc, task) => {
                if (!acc[task.routine_id]) {
                    acc[task.routine_id] = {
                        title: task.routine_title,
                        description: task.routine_description,
                        assigned_by: task.assigned_by_name,
                        created_at: task.routine_created_at,
                        tasks: []
                    };
                }
                acc[task.routine_id].tasks.push(task);
                return acc;
            }, {});

            tasksContainer.innerHTML = Object.values(tasksByRoutine).map(routine => {
                const completedCount = routine.tasks.filter(t => t.status === 'completed').length;
                const totalCount = routine.tasks.length;

                const tasksHTML = routine.tasks.map(task => {
                    const isCompleted = task.status === 'completed';
                    const onClickAction = `completeTask(this, '${task.routine_task_id}', ${task.task_instance_id || null}, '${date}')`;
                    const dueTimeHTML = task.due_time ? `<span class="task-due-time"> (Prazo: ${task.due_time.substring(0, 5)})</span>` : '';

                    return `
                        <div class="task-item ${isCompleted ? 'completed' : ''}" style="display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid var(--color-border); padding: 0.5rem 0;">
                            <label class="custom-checkbox" style="flex-grow: 1;">
                                <input type="checkbox" onchange="${onClickAction}" ${isCompleted ? 'checked' : ''}>
                                <span class="checkbox-box"><span class="material-icons">check</span></span>
                                <div>
                                    <span class="task-title-span">${task.task_title}</span>${dueTimeHTML}
                                    <div class="task-description-span">${task.task_description || ''}</div>
                                </div>
                            </label>
                        </div>
                    `;
                }).join('');

                const creationDate = new Date(routine.created_at).toLocaleDateString('pt-BR');

                return `
                    <details class="routine-group" open>
                        <summary class="routine-group-header">
                            <h4>${routine.title}</h4>
                            <div class="routine-group-meta">
                                <span>Atribuído por: ${routine.assigned_by || 'Sistema'} • Criado em: ${creationDate}</span>
                                <span class="score-pill ${completedCount === totalCount ? 'good' : 'med'}">${completedCount}/${totalCount}</span>
                            </div>
                        </summary>
                        <div class="routine-group-body">
                            ${tasksHTML}
                        </div>
                    </details>
                `;
            }).join('');
        }

        async function completeTask(checkboxElement, routineTaskId, taskInstanceId, date) {
            checkboxElement.disabled = true;
            const isCompleted = checkboxElement.checked;
            const action = isCompleted ? 'complete' : 'uncomplete';

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error('Sessão inválida.');

                const response = await fetch(N8N_COMPLETE_TASK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({ 
                        action: action,
                        routine_task_id: routineTaskId,
                        task_instance_id: taskInstanceId,
                        date: date
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    console.error("Erro do servidor:", errorData);
                    throw new Error('Falha ao atualizar status da tarefa.');
                }
                
                showToast(`Tarefa marcada como ${isCompleted ? 'concluída' : 'pendente'}!`, 'success');
                
                const activeDate = document.querySelector('.calendar-day.active')?.dataset.date;
                if (activeDate) {
                   await renderCalendar(routineCurrentDate.getFullYear(), routineCurrentDate.getMonth());
                   const dayEl = document.querySelector(`.calendar-day[data-date="${activeDate}"]`);
                   if(dayEl) dayEl.classList.add('active');
                   fetchAndRenderTasks(activeDate);
                }

            } catch (e) {
                showToast(e.message, 'danger');
                checkboxElement.checked = !isCompleted; 
            } finally {
                checkboxElement.disabled = false;
            }
        }

        async function loadManageRoutinesPage() {
            const page = document.getElementById('manage-routines-page');
            page.innerHTML = `
                <div class="page-header">
                    <div><h1>Gerenciar Rotinas</h1><p>Crie, edite e atribua rotinas de tarefas.</p></div>
                    <div class="page-header-actions"><button class="btn btn-danger" onclick="openNewRoutineModal()"><span class="material-icons">add</span> Nova Rotina</button></div>
                </div>
                <div class="manage-routines-layout">
                    <div class="card routines-column-card">
                        <div class="routines-column-header"><h3>Rotinas Criadas</h3></div>
                        <div class="routines-list" id="routines-list-col1"><div class="empty-state">Carregando...</div></div>
                    </div>
                    <div class="card routines-column-card">
                        <div class="routines-column-header">
                            <h3>Tarefas da Rotina</h3>
                            <div id="add-task-button-container"></div>
                        </div>
                        <div class="routines-list" id="tasks-list-col2"><div class="empty-state">Selecione uma rotina</div></div>
                    </div>
                    <div class="card routines-column-card">
                        <div class="routines-column-header">
                            <h3>Usuários Atribuídos</h3>
                            <div id="assign-user-button-container"></div>
                        </div>
                        <div class="routines-list" id="assignments-list-col3"><div class="empty-state">Selecione uma rotina</div></div>
                    </div>
                </div>
            `;

            const { data: routines, error } = await supabaseClient.from('routines').select('*').order('title');
            const listContainer = document.getElementById('routines-list-col1');

            if(error) {
                listContainer.innerHTML = '<div class="empty-state">Erro ao carregar rotinas.</div>';
                return;
            }
            if(routines.length === 0) {
                listContainer.innerHTML = '<div class="empty-state">Nenhuma rotina criada.</div>';
                return;
            }

            listContainer.innerHTML = routines.map(r => `
                <div class="routines-list-item" data-routine-id="${r.id}" onclick="selectRoutine('${r.id}', this)">
                    <span>${r.title}</span>
                    <div class="routine-actions" style="margin-left:auto; display:flex;">
                        <button class="btn btn-icon" title="Editar Rotina" onclick="event.stopPropagation(); openEditRoutineModal('${r.id}', '${r.title.replace(/'/g, "\\'")}', \`${(r.description || '').replace(/`/g, "\\`")}\`)"><span class="material-icons">edit</span></button>
                        <button class="btn btn-icon" title="Excluir Rotina" onclick="event.stopPropagation(); deleteRoutineHandler('${r.id}', '${r.title.replace(/'/g, "\\'")}')"><span class="material-icons">delete</span></button>
                    </div>
                </div>
            `).join('');
        }

        function openNewRoutineModal() {
            document.getElementById('new-routine-form').reset();
            document.getElementById('new-routine-modal').classList.add('visible');
        }

        async function createRoutine() {
            const title = document.getElementById('routine-title').value;
            const description = document.getElementById('routine-description').value;
            if (!title) { showToast('O título é obrigatório.', 'warning'); return; }
            const btn = document.getElementById('btn-create-routine');
            btn.disabled = true;

            const routineData = { title, description, department: currentUserProfile.department };

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                const response = await fetch(N8N_CREATE_ROUTINE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                    body: JSON.stringify(routineData)
                });
                if (!response.ok) throw new Error('Falha ao criar rotina.');
                showToast('Rotina criada com sucesso!', 'success');
                document.getElementById('new-routine-modal').classList.remove('visible');
                loadManageRoutinesPage(); 
            } catch (e) { showToast(e.message, 'danger'); } finally { btn.disabled = false; }
        }

        async function selectRoutine(routineId, element) {
            document.querySelectorAll('#routines-list-col1 .routines-list-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');

            const tasksCol = document.getElementById('tasks-list-col2');
            const assignmentsCol = document.getElementById('assignments-list-col3');
            tasksCol.innerHTML = `<div class="empty-state">Carregando tarefas...</div>`;
            assignmentsCol.innerHTML = `<div class="empty-state">Carregando atribuições...</div>`;
            
            document.getElementById('add-task-button-container').innerHTML = `<button class="btn btn-danger btn-icon" onclick="openNewTaskModal('${routineId}')" title="Adicionar Tarefa"><span class="material-icons">add</span></button>`;
            document.getElementById('assign-user-button-container').innerHTML = `<button class="btn btn-danger btn-icon" onclick="openAssignUsersModal('${routineId}')" title="Atribuir Usuários"><span class="material-icons">person_add</span></button>`;

            const [tasksRes, assignmentsRes] = await Promise.all([
                supabaseClient.from('routine_tasks').select('*').eq('routine_id', routineId).order('task_order'),
                supabaseClient.from('user_routine_assignments').select('*, user:user_id(id, full_name, department)').eq('routine_id', routineId)
            ]);

            if (tasksRes.error) {
                tasksCol.innerHTML = `<div class="empty-state">Erro ao carregar tarefas.</div>`;
            } else {
                tasksCol.innerHTML = tasksRes.data.length > 0
                    ? `<ul id="task-list-sortable" style="list-style:none; padding:0; margin:0;">${tasksRes.data.map(t => `
                        <li class="routines-list-item" data-task-id="${t.id}" style="display:flex; align-items:center; gap:0.5rem;">
                            <span class="material-icons drag-handle" style="cursor:grab; color:var(--color-text-secondary);">drag_handle</span>
                            <span><strong>#${t.task_order}</strong> - ${t.title}</span>
                            <div class="routine-actions" style="margin-left:auto; display:flex;">
                                <button class="btn btn-icon" title="Editar Tarefa" onclick="event.stopPropagation(); openEditTaskModal('${t.id}', '${t.title.replace(/'/g, "\\'")}', \`${(t.description || '').replace(/`/g, "\\`")}\`, ${t.task_order})"><span class="material-icons">edit</span></button>
                                <button class="btn btn-icon" title="Excluir Tarefa" onclick="event.stopPropagation(); deleteTaskHandler('${t.id}', '${t.title.replace(/'/g, "\\'")}')"><span class="material-icons">delete</span></button>
                            </div>
                        </li>`).join('')}</ul>`
                    : `<div class="empty-state">Nenhuma tarefa adicionada.</div>`;
            }

            if (assignmentsRes.error) {
                assignmentsCol.innerHTML = `<div class="empty-state">Erro ao carregar atribuições.</div>`;
            } else {
                const uniqueUsers = Array.from(new Map(assignmentsRes.data.map(item => [item.user.id, item.user])).values());
                assignmentsCol.innerHTML = uniqueUsers.length > 0 ? uniqueUsers.map(u => `
                    <div class="routines-list-item">
                        <div>
                            <div style="font-weight: 500;">${u.full_name}</div>
                            <div style="font-size: 0.8rem; color: var(--color-text-secondary);">${u.department || 'N/A'}</div>
                        </div>
                        <div class="routine-actions" style="margin-left:auto; display:flex;">
                            <button class="btn btn-icon" title="Remover Usuário" onclick="event.stopPropagation(); removeUserHandler('${u.id}', '${routineId}', '${u.full_name.replace(/'/g, "\\'")}')"><span class="material-icons">person_remove</span></button>
                        </div>
                    </div>`).join('') : `<div class="empty-state">Nenhum usuário atribuído.</div>`;
            }

            initializeSortable(routineId);
        }

        function openNewTaskModal(routineId) {
            document.getElementById('new-task-form').reset();
            document.getElementById('task-routine-id').value = routineId;
            document.getElementById('new-task-modal').classList.add('visible');
        }

        async function openAssignUsersModal(routineId) {
            document.getElementById('assign-routine-id').value = routineId;
            const modal = document.getElementById('assign-users-modal');
            const tableBody = document.getElementById('assign-users-table-body');
            tableBody.innerHTML = `<tr><td colspan="3" class="empty-state">Carregando usuários...</td></tr>`;
            
            selectedAssignmentDates = [];
            renderSelectedDates();
            modal.classList.add('visible');
            document.getElementById('add-date-btn').onclick = addAssignmentDate;

            const { data: assignableUsers, error } = await supabaseClient.rpc('get_assignable_users');

            if (error) {
                console.error("Erro ao buscar usuários atribuíveis:", error);
                tableBody.innerHTML = `<tr><td colspan="3" class="empty-state" style="color:var(--color-danger);">Falha ao carregar usuários.</td></tr>`;
                return;
            }
            
            const { data: assignedRes } = await supabaseClient.from('user_routine_assignments').select('user_id').eq('routine_id', routineId);
            const assignedUserIds = new Set((assignedRes || []).map(a => a.user_id));
            
            tableBody.innerHTML = assignableUsers.map(user => {
                const isChecked = assignedUserIds.has(user.id);
                return `
                    <tr>
                        <td><input type="checkbox" class="user-assign-checkbox" value="${user.id}" ${isChecked ? 'checked' : ''}></td>
                        <td>${user.full_name}</td>
                        <td>${user.department || '-'}</td>
                    </tr>
                `;
            }).join('');

            const selectAllCheckbox = document.getElementById('select-all-users-routine');
            if (selectAllCheckbox) {
                selectAllCheckbox.onchange = (e) => {
                    document.querySelectorAll('.user-assign-checkbox').forEach(cb => cb.checked = e.target.checked);
                };
            }
        }

        function renderSelectedDates() {
            const listContainer = document.getElementById('selected-dates-list');
            if (!listContainer) return;

            selectedAssignmentDates.sort(); 

            listContainer.innerHTML = selectedAssignmentDates.map(date => {
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR');
                return `
                    <span class="recipient-pill">
                        ${formattedDate}
                        <span class="pill-remove" onclick="removeAssignmentDate('${date}')">&times;</span>
                    </span>
                `;
            }).join('');
        }

        function addAssignmentDate() {
            const dateInput = document.getElementById('assignment-date-input');
            const dateValue = dateInput.value;

            if (!dateValue) {
                showToast('Por favor, selecione uma data.', 'warning');
                return;
            }
            if (selectedAssignmentDates.includes(dateValue)) {
                showToast('Esta data já foi adicionada.', 'info');
                return;
            }
            selectedAssignmentDates.push(dateValue);
            selectedAssignmentDates.sort(); 
            renderSelectedDates();
            dateInput.value = ''; 
        }

        window.removeAssignmentDate = (dateToRemove) => {
            selectedAssignmentDates = selectedAssignmentDates.filter(date => date !== dateToRemove);
            renderSelectedDates();
        }

        function openEditRoutineModal(routineId, title, description) {
            document.getElementById('edit-routine-id').value = routineId;
            document.getElementById('edit-routine-title').value = title;
            document.getElementById('edit-routine-description').value = description;
            document.getElementById('edit-routine-modal').classList.add('visible');
        }

        function openEditTaskModal(taskId, title, description, order) {
            document.getElementById('edit-task-id').value = taskId;
            document.getElementById('edit-task-title').value = title;
            document.getElementById('edit-task-description').value = description;
            document.getElementById('edit-task-order').value = order;
            document.getElementById('edit-task-modal').classList.add('visible');
        }

        async function updateRoutineHandler() {
            const routineId = document.getElementById('edit-routine-id').value;
            const title = document.getElementById('edit-routine-title').value;
            const description = document.getElementById('edit-routine-description').value;
            const btn = document.getElementById('btn-update-routine');
            btn.disabled = true;
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                const response = await fetch(N8N_UPDATE_ROUTINE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}`},
                    body: JSON.stringify({ p_routine_id: routineId, p_title: title, p_description: description })
                });
                if (!response.ok) throw new Error('Falha ao atualizar rotina.');
                showToast('Rotina atualizada!', 'success');
                document.getElementById('edit-routine-modal').classList.remove('visible');
                loadManageRoutinesPage();
            } catch (e) { showToast(e.message, 'danger'); } finally { btn.disabled = false; }
        }

        function deleteRoutineHandler(routineId, routineTitle) {
            showConfirmation(
                "Excluir Rotina?",
                `Tem certeza que deseja excluir a rotina "${routineTitle}"? Todas as suas tarefas e atribuições serão permanentemente removidas.`,
                async () => {
                    try {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        const response = await fetch(N8N_DELETE_ROUTINE_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}`},
                            body: JSON.stringify({ p_routine_id: routineId })
                        });
                        if (!response.ok) throw new Error('Falha ao excluir rotina.');
                        showToast('Rotina excluída com sucesso!', 'success');
                        loadManageRoutinesPage();
                    } catch (e) { showToast(e.message, 'danger'); }
                }
            );
        }

        async function updateTaskHandler() {
            const taskId = document.getElementById('edit-task-id').value;
            const title = document.getElementById('edit-task-title').value;
            const description = document.getElementById('edit-task-description').value;
            const order = document.getElementById('edit-task-order').value;
            const btn = document.getElementById('btn-update-task');
            btn.disabled = true;
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                const response = await fetch(N8N_UPDATE_TASK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}`},
                    body: JSON.stringify({ p_task_id: taskId, p_title: title, p_description: description, p_task_order: parseInt(order) })
                });
                if (!response.ok) throw new Error('Falha ao atualizar tarefa.');
                showToast('Tarefa atualizada!', 'success');
                document.getElementById('edit-task-modal').classList.remove('visible');
                const activeRoutine = document.querySelector('#routines-list-col1 .routines-list-item.active');
                if (activeRoutine) {
                    selectRoutine(activeRoutine.dataset.routineId, activeRoutine);
                }
            } catch (e) { showToast(e.message, 'danger'); } finally { btn.disabled = false; }
        }

        function deleteTaskHandler(taskId, taskTitle) {
            showConfirmation(
                "Excluir Tarefa?",
                `Tem certeza que deseja excluir a tarefa "${taskTitle}"?`,
                async () => {
                    try {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        const response = await fetch(N8N_DELETE_TASK_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}`},
                            body: JSON.stringify({ p_task_id: taskId })
                        });
                        if (!response.ok) throw new Error('Falha ao excluir tarefa.');
                        showToast('Tarefa excluída com sucesso!', 'success');
                        const activeRoutine = document.querySelector('#routines-list-col1 .routines-list-item.active');
                        if (activeRoutine) {
                            selectRoutine(activeRoutine.dataset.routineId, activeRoutine);
                        }
                    } catch (e) { showToast(e.message, 'danger'); }
                }
            );
        }

        function removeUserHandler(userId, routineId, userName) {
            showConfirmation(
                "Remover Usuário?",
                `Tem certeza que deseja remover ${userName} desta rotina? Suas tarefas futuras serão canceladas.`,
                async () => {
                    try {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        const response = await fetch(N8N_REMOVE_USER_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}`},
                            body: JSON.stringify({ p_user_id: userId, p_routine_id: routineId })
                        });
                        if (!response.ok) throw new Error('Falha ao remover usuário.');
                        showToast('Usuário removido da rotina!', 'success');
                        const activeRoutine = document.querySelector('#routines-list-col1 .routines-list-item.active');
                        if (activeRoutine) {
                            selectRoutine(activeRoutine.dataset.routineId, activeRoutine);
                        }
                    } catch (e) { showToast(e.message, 'danger'); }
                }
            );
        }

        function initializeSortable(routineId) {
            const list = document.getElementById('task-list-sortable');
            if (!list) return;

            Sortable.create(list, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: async function (evt) {
                    const taskIdsOrdered = Array.from(list.children).map(item => item.dataset.taskId);
                    
                    Array.from(list.children).forEach((item, index) => {
                        const orderSpan = item.querySelector('span:nth-of-type(2) > strong');
                        if (orderSpan) orderSpan.textContent = `#${index + 1}`;
                    });

                    try {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        const response = await fetch(N8N_REORDER_TASKS_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}`},
                            body: JSON.stringify({ p_routine_id: routineId, p_task_ids_ordered: taskIdsOrdered })
                        });
                        if (!response.ok) throw new Error('Falha ao reordenar tarefas.');
                        showToast('Ordem das tarefas atualizada!', 'success');
                    } catch (e) {
                        showToast(e.message, 'danger');
                        const activeRoutine = document.querySelector('#routines-list-col1 .routines-list-item.active');
                        if (activeRoutine) selectRoutine(activeRoutine.dataset.routineId, activeRoutine);
                    }
                }
            });
        }


        async function addTaskToRoutine() {
            const routineId = document.getElementById('task-routine-id').value;
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const taskOrder = document.getElementById('task-order').value;
            const btn = document.getElementById('btn-create-task');

            if (!title || !taskOrder) { showToast('Título e Ordem são obrigatórios.', 'warning'); return; }
            btn.disabled = true;

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                const response = await fetch(N8N_ADD_TASK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}`},
                    body: JSON.stringify({ routine_id: routineId, title, description, task_order: parseInt(taskOrder) })
                });
                if (!response.ok) throw new Error('Falha ao adicionar tarefa.');
                showToast('Tarefa adicionada!', 'success');
                document.getElementById('new-task-modal').classList.remove('visible');
                selectRoutine(routineId, document.querySelector(`.routines-list-item[data-routine-id="${routineId}"]`));
            } catch (e) { showToast(e.message, 'danger'); } finally { btn.disabled = false; }
        }

        async function assignRoutineToUsers() {
            const routineId = document.getElementById('assign-routine-id').value;
            const selectedUserIds = Array.from(document.querySelectorAll('.user-assign-checkbox:checked')).map(cb => cb.value);
            const btn = document.getElementById('btn-assign-users');

            if (selectedUserIds.length === 0) {
                showToast('Selecione pelo menos um usuário.', 'warning');
                return;
            }
            if (selectedAssignmentDates.length === 0) {
                showToast('Adicione pelo menos uma data para a atribuição.', 'warning');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Salvando...';

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                const response = await fetch(N8N_ASSIGN_ROUTINE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}`},
                    body: JSON.stringify({ 
                        routine_id: routineId, 
                        user_ids: selectedUserIds,
                        dates: selectedAssignmentDates
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Falha ao atribuir rotina.');
                }

                showToast('Atribuições salvas!', 'success');
                document.getElementById('assign-users-modal').classList.remove('visible');
                
                const activeRoutineElement = document.querySelector(`.routines-list-item[data-routine-id="${routineId}"]`);
                if (activeRoutineElement) {
                    await selectRoutine(routineId, activeRoutineElement);
                }
                
            } catch (e) { 
                showToast(e.message, 'danger'); 
            } finally { 
                btn.disabled = false;
                btn.textContent = 'Salvar Atribuições';
            }
        }

        document.getElementById('btn-create-task')?.addEventListener('click', addTaskToRoutine);
        document.getElementById('btn-assign-users')?.addEventListener('click', assignRoutineToUsers);
        document.getElementById('btn-create-routine')?.addEventListener('click', createRoutine);
        document.getElementById('btn-update-routine')?.addEventListener('click', updateRoutineHandler);
        document.getElementById('btn-update-task')?.addEventListener('click', updateTaskHandler);

        async function showWelcomeNotification() {
            if (sessionStorage.getItem('welcomeShown')) return;

            try {
                const { data, error } = await supabaseClient.rpc('get_dashboard_stats').single();
                if (error) throw error;

                const mensagens = data?.pending_messages_count || 0;
                const chamados = data?.urgent_tickets_count || 0;
                const nome = currentUserProfile?.full_name?.split(' ')[0] || 'você';

                let mensagem = `Bem-vindo(a), ${nome}! `;
                if (mensagens === 0 && chamados === 0) {
                    mensagem += `Nenhuma pendência por enquanto. Bom trabalho!`;
                } else {
                    if (mensagens > 0) mensagem += `Você tem <strong>${mensagens}</strong> mensagem(ns) pendente(s). `;
                    if (chamados > 0) mensagem += `Há <strong>${chamados}</strong> chamado(s) aberto(s).`;
                }

                showToast(mensagem, mensagens > 0 || chamados > 0 ? 'warning' : 'success');
            } catch (e) {
                console.warn('Não foi possível carregar o resumo de boas-vindas:', e);
            } finally {
                sessionStorage.setItem('welcomeShown', 'true');
            }
        }

        function checkNotificationTriggers() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const lastVisit = localStorage.getItem('lastVisitDate');
            const lastAfternoonAlert = localStorage.getItem('lastAfternoonAlert');
            const lastEveningAlert = localStorage.getItem('lastEveningAlert');

            if (lastVisit !== today) {
                displayDailySummary();
                localStorage.setItem('lastVisitDate', today);
                localStorage.setItem('lastAfternoonAlert', today);
                localStorage.setItem('lastEveningAlert', today);
                return;
            }

            if (now.getHours() >= 14 && lastAfternoonAlert !== today) {
                 showToast(`Bem-vindo de volta! Lembre-se de suas pendências.`, 'info');
                 localStorage.setItem('lastAfternoonAlert', today);
                 return;
            }

            if (now.getHours() >= 17 && lastEveningAlert !== today) {
                 showToast(`Última chamada! Verifique se há pendências antes de encerrar o dia.`, 'info');
                 localStorage.setItem('lastEveningAlert', today);
            }
        }

        async function displayDailySummary() {
            const today = new Date().toISOString().split('T')[0];
            const nome = currentUserProfile.full_name.split(' ')[0];

            const [statsRes, tasksRes] = await Promise.all([
                supabaseClient.rpc('get_dashboard_stats').single(),
                supabaseClient.rpc('get_user_tasks_for_date', { p_date: today })
            ]);

            const stats = statsRes.data || {};
            const tasks = tasksRes.data || [];

            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.status === 'completed').length;
            const progressPct = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 100;

            const now = new Date();
            const overdueTasks = tasks.filter(t => {
                if (!t.due_time || t.status === 'completed') return false;
                const [h, m] = t.due_time.split(':');
                const due = new Date(); due.setHours(parseInt(h), parseInt(m), 0);
                return due < now;
            });

            const pendingTasks = tasks.filter(t => t.status !== 'completed');
            const proximaTask = pendingTasks.length > 0 ? pendingTasks[0] : null;
            const proximaTexto = proximaTask
                ? `Próxima: <strong>${proximaTask.task_title}</strong>${proximaTask.due_time ? ' às ' + proximaTask.due_time.substring(0,5) : ''}`
                : 'Nenhuma tarefa pendente';

            const mensagens = (stats.pending_messages_count || 0) + (stats.urgent_tickets_count || 0);

            const modal = document.getElementById('confirmation-modal');
            const body = modal.querySelector('.modal-body');
            body.innerHTML = `
                <div style="width: 100%; text-align: left;">

                    <!-- HEADER -->
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.25rem; border-bottom: 1px solid var(--color-border);">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #ff6b35, var(--color-brand-primary)); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <span class="material-icons" style="color: white; font-size: 24px;">wb_sunny</span>
                        </div>
                        <div>
                            <div style="font-weight: 800; font-size: 1.3rem; letter-spacing: -0.01em;">Fala, ${nome}! 👋</div>
                            <div style="font-size: 0.82rem; color: var(--color-text-secondary); text-transform: capitalize;">${new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' })}</div>
                        </div>
                    </div>

                    <!-- BARRA DE PROGRESSO -->
                    <div class="briefing-progress-label">
                        <span style="font-weight: 600;">Progresso do dia</span>
                        <span style="font-weight: 700; color: var(--color-success);">${completedTasks}/${totalTasks} concluídas</span>
                    </div>
                    <div class="briefing-progress-bar-wrapper" style="margin-bottom: 1.5rem;">
                        <div class="briefing-progress-bar-fill" style="width: ${progressPct}%;"></div>
                    </div>

                    <!-- CARDS VERTICAIS -->
                    <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1.5rem;">

                        <!-- CRÍTICO -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.875rem 1rem; background: var(--color-danger-bg); border: 1px solid rgba(216,25,32,0.2); border-radius: 10px;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 36px; height: 36px; border-radius: 8px; background: var(--color-brand-primary); display: flex; align-items: center; justify-content: center;">
                                    <span class="material-icons" style="color: white; font-size: 18px;">priority_high</span>
                                </div>
                                <div>
                                    <div style="font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--color-danger);">Crítico</div>
                                    <div style="font-size: 0.82rem; color: var(--color-text-secondary);">${overdueTasks.length > 0 ? `${overdueTasks.length} tarefa(s) atrasada(s)` : 'Tudo em dia!'}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.8rem; font-weight: 800; color: var(--color-danger);">${overdueTasks.length}</span>
                                ${overdueTasks.length > 0 ? `<button class="btn btn-danger" style="padding: 0.3rem 0.75rem; font-size: 0.8rem;" onclick="closeConfirmationModal(); showPage('my-routines-page');">Resolver</button>` : `<span class="material-icons" style="color: var(--color-success); font-size: 22px;">check_circle</span>`}
                            </div>
                        </div>

                        <!-- HOJE -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.875rem 1rem; background: var(--color-warning-bg); border: 1px solid rgba(245,158,11,0.2); border-radius: 10px;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 36px; height: 36px; border-radius: 8px; background: var(--color-warning); display: flex; align-items: center; justify-content: center;">
                                    <span class="material-icons" style="color: white; font-size: 18px;">today</span>
                                </div>
                                <div>
                                    <div style="font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--color-warning);">Hoje</div>
                                    <div style="font-size: 0.82rem; color: var(--color-text-secondary);">${proximaTexto}</div>
                                </div>
                            </div>
                            <span style="font-size: 1.8rem; font-weight: 800; color: var(--color-warning);">${pendingTasks.length}</span>
                        </div>

                        <!-- MENSAGENS -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.875rem 1rem; background: var(--color-info-bg); border: 1px solid rgba(59,130,246,0.2); border-radius: 10px;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 36px; height: 36px; border-radius: 8px; background: var(--color-info); display: flex; align-items: center; justify-content: center;">
                                    <span class="material-icons" style="color: white; font-size: 18px;">mail</span>
                                </div>
                                <div>
                                    <div style="font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--color-info);">Mensagens</div>
                                    <div style="font-size: 0.82rem; color: var(--color-text-secondary);">${stats.pending_messages_count || 0} msg · ${stats.urgent_tickets_count || 0} chamado(s)</div>
                                </div>
                            </div>
                            <span style="font-size: 1.8rem; font-weight: 800; color: var(--color-info);">${mensagens}</span>
                        </div>

                    </div>

                    <!-- BOTÃO -->
                    <button onclick="closeConfirmationModal()" style="width: 100%; padding: 1rem; border: none; border-radius: 12px; background: linear-gradient(135deg, #c0141b, var(--color-brand-primary) 50%, #ff4444); color: white; font-size: 0.95rem; font-weight: 800; cursor: pointer; letter-spacing: 0.08em; display: flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 15px rgba(216,25,32,0.4); transition: transform 0.15s, box-shadow 0.15s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(216,25,32,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(216,25,32,0.4)'">
                        <span class="material-icons" style="font-size: 20px;">rocket_launch</span>
                        VAMOS EXECUTAR!
                    </button>

                </div>
            `;
            modal.classList.add('visible');
        }

    </script>
</body>
</html>
